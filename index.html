<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>The Tox Reference</title>

    <link rel="stylesheet" type="text/css" href="rust.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <h1 class="title">The Tox Reference</h1>
    <nav id="TOC"><ul>
<li><a href="#introduction">1 Introduction</a><ul>
<li><a href="#goals-and-threat-model">1.1 Goals and threat model</a><ul>
<li><a href="#what-tox-does">1.1.1 What Tox does</a><ul>
<li><a href="#authentication">1.1.1.1 Authentication</a><ul></ul></li>
<li><a href="#end-to-end-encryption">1.1.1.2 End-to-end encryption</a><ul>
<li><a href="#perfect-forward-secrecy">1.1.1.2.1 Perfect forward secrecy</a><ul></ul></li></ul></li>
<li><a href="#reliability">1.1.1.3 Reliability</a><ul></ul></li>
<li><a href="#zero-conf-easy-to-use">1.1.1.4 Zero-conf (easy-to-use)</a><ul></ul></li></ul></li>
<li><a href="#what-tox-does-not">1.1.2 What Tox does not</a><ul>
<li><a href="#anonymity">1.1.2.1 Anonymity</a><ul></ul></li></ul></li></ul></li>
<li><a href="#integers">1.2 Integers</a><ul></ul></li>
<li><a href="#strings">1.3 Strings</a><ul></ul></li></ul></li>
<li><a href="#crypto">2 Crypto</a><ul>
<li><a href="#key">2.1 Key</a><ul>
<li><a href="#key-pair">2.1.1 Key Pair</a><ul></ul></li>
<li><a href="#combined-key">2.1.2 Combined Key</a><ul></ul></li>
<li><a href="#nonce">2.1.3 Nonce</a><ul></ul></li></ul></li>
<li><a href="#box">2.2 Box</a><ul></ul></li></ul></li>
<li><a href="#node-info">3 Node Info</a><ul>
<li><a href="#transport-protocol">3.1 Transport Protocol</a><ul></ul></li>
<li><a href="#host-address">3.2 Host Address</a><ul></ul></li>
<li><a href="#port-number">3.3 Port Number</a><ul></ul></li>
<li><a href="#socket-address">3.4 Socket Address</a><ul></ul></li>
<li><a href="#node-info-packed-node-format">3.5 Node Info (packed node format)</a><ul></ul></li></ul></li>
<li><a href="#protocol-packet">4 Protocol Packet</a><ul>
<li><a href="#packet-kind">4.1 Packet Kind</a><ul></ul></li></ul></li>
<li><a href="#dht">5 DHT</a><ul>
<li><a href="#distance">5.1 Distance</a><ul></ul></li>
<li><a href="#k-buckets">5.2 K-buckets</a><ul>
<li><a href="#bucket-index">5.2.1 Bucket Index</a><ul></ul></li>
<li><a href="#updating-k-buckets">5.2.2 Updating k-buckets</a><ul></ul></li></ul></li>
<li><a href="#dht-node-state">5.3 DHT node state</a><ul></ul></li>
<li><a href="#self-organisation">5.4 Self-organisation</a><ul></ul></li>
<li><a href="#dht-packet">5.5 DHT Packet</a><ul></ul></li>
<li><a href="#rpc-services">5.6 RPC Services</a><ul>
<li><a href="#ping-service">5.6.1 Ping Service</a><ul>
<li><a href="#ping-request-0x00">5.6.1.1 Ping Request (0x00)</a><ul></ul></li>
<li><a href="#ping-response-0x01">5.6.1.2 Ping Response (0x01)</a><ul></ul></li></ul></li>
<li><a href="#nodes-service">5.6.2 Nodes Service</a><ul>
<li><a href="#nodes-request-0x02">5.6.2.1 Nodes Request (0x02)</a><ul></ul></li>
<li><a href="#nodes-response-0x04">5.6.2.2 Nodes Response (0x04)</a><ul></ul></li></ul></li></ul></li>
<li><a href="#dht-operation">5.7 DHT operation</a><ul></ul></li>
<li><a href="#dht-request-packets">5.8 DHT Request packets</a><ul>
<li><a href="#nat-ping-packets">5.8.1 NAT ping packets</a><ul>
<li><a href="#nat-ping-request">5.8.1.1 NAT ping request</a><ul></ul></li>
<li><a href="#nat-ping-response">5.8.1.2 NAT ping response</a><ul></ul></li></ul></li></ul></li>
<li><a href="#hole-punching">5.9 Hole-punching</a><ul>
<li><a href="#cone-nat">5.9.1 Cone NAT</a><ul></ul></li>
<li><a href="#restricted-cone-nat">5.9.2 Restricted cone NAT</a><ul></ul></li>
<li><a href="#symmetric-nat">5.9.3 Symmetric NAT</a><ul></ul></li>
<li><a href="#different-ipports">5.9.4 Different <code>IP:port</code>s</a><ul></ul></li></ul></li>
<li><a href="#dht-bootstrap-info-0xf0">5.10 DHT Bootstrap Info (0xf0)</a><ul></ul></li></ul></li>
<li><a href="#lan-discovery">6 LAN discovery</a><ul></ul></li>
<li><a href="#tcp-server">7 TCP server</a><ul>
<li><a href="#tcp-connection">7.1 TCP Connection</a><ul></ul></li>
<li><a href="#tcp-handshake">7.2 TCP Handshake</a><ul>
<li><a href="#handshake-diagram">7.2.1 Handshake diagram</a><ul>
<li><a href="#handshake-diagram---client">7.2.1.1 Handshake diagram - client</a><ul></ul></li>
<li><a href="#handshake-diagram---server">7.2.1.2 Handshake diagram - server</a><ul></ul></li></ul></li>
<li><a href="#handshake-request">7.2.2 Handshake Request</a><ul>
<li><a href="#handshake-request-packet-payload">7.2.2.1 Handshake Request Packet Payload</a><ul></ul></li></ul></li>
<li><a href="#handshake-response">7.2.3 Handshake Response</a><ul>
<li><a href="#handshake-response-payload">7.2.3.1 Handshake Response Payload</a><ul></ul></li></ul></li></ul></li>
<li><a href="#after-handshake">7.3 After Handshake</a><ul></ul></li>
<li><a href="#encrypted-data-packet">7.4 Encrypted data packet</a><ul>
<li><a href="#encrypted-data-packet-keys">7.4.1 Encrypted data packet keys</a><ul></ul></li>
<li><a href="#encrypted-data-packet-nonces">7.4.2 Encrypted data packet nonces</a><ul>
<li><a href="#encrypted-data-packets-from-server">7.4.2.1 Encrypted data packets from server</a><ul></ul></li>
<li><a href="#encrypted-data-packets-from-client">7.4.2.2 Encrypted data packets from client</a><ul></ul></li></ul></li>
<li><a href="#encrypted-data-packet-size">7.4.3 Encrypted data packet size</a><ul></ul></li>
<li><a href="#encrypted-data-packet-rationale">7.4.4 Encrypted data packet rationale</a><ul></ul></li></ul></li>
<li><a href="#encrypted-payload-types">7.5 Encrypted payload types</a><ul>
<li><a href="#routing-request-0x00">7.5.1 Routing request (0x00)</a><ul></ul></li>
<li><a href="#routing-request-response-0x01">7.5.2 Routing request response (0x01)</a><ul></ul></li>
<li><a href="#connect-notification-0x02">7.5.3 Connect notification (0x02)</a><ul></ul></li>
<li><a href="#disconnect-notification-0x03">7.5.4 Disconnect notification (0x03)</a><ul></ul></li>
<li><a href="#ping-request-0x04">7.5.5 Ping request (0x04)</a><ul></ul></li>
<li><a href="#ping-response-pong-0x05">7.5.6 Ping response (pong) (0x05)</a><ul></ul></li>
<li><a href="#oob-send-0x06">7.5.7 OOB send (0x06)</a><ul></ul></li>
<li><a href="#oob-recv-0x07">7.5.8 OOB recv (0x07)</a><ul></ul></li>
<li><a href="#onion-packet-0x08">7.5.9 Onion packet (0x08)</a><ul></ul></li>
<li><a href="#onion-packet-response-0x09">7.5.10 Onion packet response (0x09)</a><ul></ul></li>
<li><a href="#data-0x10-and-up">7.5.11 Data (0x10 and up)</a><ul></ul></li></ul></li></ul></li>
<li><a href="#tcp-client">8 TCP client</a><ul></ul></li>
<li><a href="#tcp-connections">9 TCP connections</a><ul></ul></li>
<li><a href="#net-crypto">10 Net crypto</a><ul></ul></li>
<li><a href="#onion">11 Onion</a><ul></ul></li>
<li><a href="#friend-requests">12 Friend requests</a><ul></ul></li>
<li><a href="#friend-connection">13 Friend connection</a><ul></ul></li>
<li><a href="#tox-id">14 Tox ID</a><ul></ul></li>
<li><a href="#messenger">15 Messenger</a><ul>
<li><a href="#online">15.1 <code>ONLINE</code></a><ul></ul></li>
<li><a href="#offline">15.2 <code>OFFLINE</code></a><ul></ul></li>
<li><a href="#nickname">15.3 <code>NICKNAME</code></a><ul></ul></li>
<li><a href="#statusmessage">15.4 <code>STATUSMESSAGE</code></a><ul></ul></li>
<li><a href="#userstatus">15.5 <code>USERSTATUS</code></a><ul></ul></li>
<li><a href="#typing">15.6 <code>TYPING</code></a><ul></ul></li>
<li><a href="#message">15.7 <code>MESSAGE</code></a><ul></ul></li>
<li><a href="#action">15.8 <code>ACTION</code></a><ul></ul></li>
<li><a href="#msi">15.9 <code>MSI</code></a><ul></ul></li>
<li><a href="#file-transfer-related-packets">15.10 File Transfer Related Packets</a><ul>
<li><a href="#file_sendrequest">15.10.1 <code>FILE_SENDREQUEST</code></a><ul></ul></li>
<li><a href="#file_control">15.10.2 <code>FILE_CONTROL</code></a><ul></ul></li>
<li><a href="#file_data">15.10.3 <code>FILE_DATA</code></a><ul></ul></li></ul></li>
<li><a href="#group-chat-related-packets">15.11 Group Chat Related Packets</a><ul></ul></li></ul></li>
<li><a href="#group">16 Group</a><ul>
<li><a href="#message-ids">16.1 Message ids</a><ul>
<li><a href="#ping-0x00">16.1.1 ping (0x00)</a><ul></ul></li>
<li><a href="#new_peer-0x10">16.1.2 <code>new_peer</code> (0x10)</a><ul></ul></li>
<li><a href="#kill_peer-0x11">16.1.3 <code>kill_peer</code> (0x11)</a><ul></ul></li>
<li><a href="#name-change-0x30">16.1.4 Name change (0x30)</a><ul></ul></li>
<li><a href="#groupchat-title-change-0x31">16.1.5 Groupchat title change (0x31)</a><ul></ul></li>
<li><a href="#chat-message-0x40">16.1.6 Chat message (0x40)</a><ul></ul></li>
<li><a href="#action-me-0x41">16.1.7 Action (/me) (0x41)</a><ul></ul></li></ul></li></ul></li>
<li><a href="#networktxt">17 network.txt</a><ul></ul></li>
<li><a href="#ping-array">18 Ping array</a><ul></ul></li>
<li><a href="#state-format">19 State Format</a><ul>
<li><a href="#sections">19.1 Sections</a><ul>
<li><a href="#nospam-and-keys-0x01">19.1.1 Nospam and Keys (0x01)</a><ul></ul></li>
<li><a href="#dht-0x02">19.1.2 DHT (0x02)</a><ul>
<li><a href="#dht-sections">19.1.2.1 DHT Sections</a><ul>
<li><a href="#nodes-0x04">19.1.2.1.1 Nodes (0x04)</a><ul></ul></li></ul></li></ul></li>
<li><a href="#friends-0x03">19.1.3 Friends (0x03)</a><ul></ul></li>
<li><a href="#name-0x04">19.1.4 Name (0x04)</a><ul></ul></li>
<li><a href="#status-message-0x05">19.1.5 Status Message (0x05)</a><ul></ul></li>
<li><a href="#status-0x06">19.1.6 Status (0x06)</a><ul></ul></li>
<li><a href="#tcp-relays-0x0a">19.1.7 Tcp Relays (0x0A)</a><ul></ul></li>
<li><a href="#path-nodes-0x0b">19.1.8 Path Nodes (0x0B)</a><ul></ul></li>
<li><a href="#eof-0xff">19.1.9 EOF (0xFF)</a><ul></ul></li></ul></li></ul></li>
<li><a href="#testing">20 Testing</a><ul></ul></li></ul></nav>
<h1 id='introduction' class='section-header'><a href='#introduction'>1 Introduction</a></h1>
<p>This document is a textual specification of the Tox protocol and all the
supporting modules required to implement it. The goal of this document is to
give enough guidance to permit a complete and correct implementation of the
protocol.</p>

<p>All data types are defined before their first use, and their binary protocol
representation is given. The protocol representations are normative and must be
implemented exactly as specified. For some types, human-readable
representations are suggested. An implementation may choose to provide no such
representation or a different one. The implementation is free to choose any
in-memory representation of the specified types, as long as they can be encoded
to and decoded from the specified protocol representation.</p>

<p>Binary formats are specified in tables with length, type, and content
descriptions. If applicable, specific enumeration types are used, so types may
be self-explanatory in some cases. The length can be either a fixed number in
bytes (e.g. <code>32</code>), a number in bits (e.g. <code>7</code> bit), a choice of lengths (e.g.
<code>4 | 16</code>), or an inclusive range (e.g. <code>[0, 100]</code>). Open ranges are denoted
<code>[n,]</code> to mean a minimum length of <code>n</code> with no specified maximum length.</p>

<h2 id='goals-and-threat-model' class='section-header'><a href='#goals-and-threat-model'>1.1 Goals and threat model</a></h2>
<p>(TODO: this is just a placeholder; some more technical description should be
given)</p>

<p>This section should give an idea on what the goals and non-goals of Tox are, so
that reader:</p>

<ul>
<li><p>understands what problems Tox intends to solve</p></li>
<li><p>can validate if they are addressed by this specification</p></li>
<li><p>can make better tradeoffs and decisions in his own reimplementation of the
protocol</p></li>
</ul>

<h3 id='what-tox-does' class='section-header'><a href='#what-tox-does'>1.1.1 What Tox does</a></h3>
<h4 id='authentication' class='section-header'><a href='#authentication'>1.1.1.1 Authentication</a></h4>
<p>User&#39;s address is its public key, thus &quot;adding friend&quot; actually means verifying
key. Drawback is that after being compromised (secret key revealed) you have to
generate a new identity.</p>

<h4 id='end-to-end-encryption' class='section-header'><a href='#end-to-end-encryption'>1.1.1.2 End-to-end encryption</a></h4>
<p>All the messages are encrypted with keys derived via DH, thus keys are only
known to sender and receiver and are never transferred over network.</p>

<h5 id='perfect-forward-secrecy' class='section-header'><a href='#perfect-forward-secrecy'>1.1.1.2.1 Perfect forward secrecy</a></h5>
<p>Achieved by using ephemeral keys (TODO: how are they used in the current
protocol? is the problem actually solved?)</p>

<h4 id='reliability' class='section-header'><a href='#reliability'>1.1.1.3 Reliability</a></h4>
<ul>
<li><p>Tox is supposed to be fully distributed network which doesn&#39;t depend on any
Single Point of Failure. This is achieved by using DHT and direct (P2P)
connections between the peers in the network. Entry point is still
required. Process of connecting to the network is called <code>bootstrapping</code>.
Bootstrapping can and should be done using multiple entry points.</p></li>
<li><p>Tox is supposed to work under (almost) any kind of NAT and firewall; this
is achieved by using hole-punching, UPnP and TCP-relays.</p></li>
<li><p>Resistance to basic DoS and other poisoning.</p></li>
</ul>

<h4 id='zero-conf-easy-to-use' class='section-header'><a href='#zero-conf-easy-to-use'>1.1.1.4 Zero-conf (easy-to-use)</a></h4>
<p>End-user should be able to use the messenger that <strong><em>Just Works</em></strong>. Security
that is too hard to use is useless.</p>

<h3 id='what-tox-does-not' class='section-header'><a href='#what-tox-does-not'>1.1.2 What Tox does not</a></h3>
<h4 id='anonymity' class='section-header'><a href='#anonymity'>1.1.2.1 Anonymity</a></h4>
<p>Unless TCP mode is used, participants communicate directly with each other. One
of the reasons for this is that relaying real-time video with anything but a
direct connection is rather costly (in terms of bandwidth) and also means
delays.</p>

<p>Your IP address is exposed to nodes in your friendlist. They can link your ID
directly to your IP address.</p>

<p>Temporary DHT nodes and onion tunnels are used to find friends, so that your ID
cannot be linked to your IP based solely on publicly available data (TODO: e.g.
data stored in DHT? what else is exposed?); Though adversary intercepting
traffic in large enough network segment is (probably) able to perform some
statistical-based attack; (TODO: what problem it is supposed to solve? does it
solve it? since we don&#39;t care about anonymity, i can only think of prevention
of some targeted Denial-of-Service attacks)</p>

<p>In case where anonymity is a concern, Tox can be proxied over HTTP or SOCKS5
proxy. Using the TCP-only mode is required for anonymity.</p>

<h2 id='integers' class='section-header'><a href='#integers'>1.2 Integers</a></h2>
<p>The protocol uses four bounded unsigned integer types. Bounded means they have
an upper bound beyond which incrementing is not defined. The integer types
support modular arithmetic, so overflow wraps around to zero. Unsigned means
their lower bound is 0. Signed integer types are not used. The binary encoding
of all integer types is a fixed-width byte sequence with the integer encoded in
<a href="https://en.wikipedia.org/wiki/Endianness">Big Endian</a> unless stated otherwise.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Type name</th>
<th style="text-align: left">C type</th>
<th style="text-align: left">Rust type</th>
<th style="text-align: left">Length</th>
<th style="text-align: left">Upper bound</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">Word8</td>
<td style="text-align: left"><code>uint8_t</code></td>
<td style="text-align: left"><code>u8</code></td>
<td style="text-align: left">1</td>
<td style="text-align: left">255 (0xff)</td>
</tr>
<tr>
<td style="text-align: left">Word16</td>
<td style="text-align: left"><code>uint16_t</code></td>
<td style="text-align: left"><code>u16</code></td>
<td style="text-align: left">2</td>
<td style="text-align: left">65535 (0xffff)</td>
</tr>
<tr>
<td style="text-align: left">Word32</td>
<td style="text-align: left"><code>uint32_t</code></td>
<td style="text-align: left"><code>u32</code></td>
<td style="text-align: left">4</td>
<td style="text-align: left">4294967295 (0xffffffff)</td>
</tr>
<tr>
<td style="text-align: left">Word64</td>
<td style="text-align: left"><code>uint64_t</code></td>
<td style="text-align: left"><code>u64</code></td>
<td style="text-align: left">8</td>
<td style="text-align: left">18446744073709551615 (0xffffffffffffffff)</td>
</tr>
</tbody>
</table>

<h2 id='strings' class='section-header'><a href='#strings'>1.3 Strings</a></h2>
<p>A String is a data structure used for human readable text. Strings are
sequences of glyphs. A glyph consists of one non-zero-width unicode code point
and zero or more zero-width unicode code points. The human-readable
representation of a String starts and ends with a quotation mark (<code>&quot;</code>) and
contains all human-readable glyphs verbatim. Control characters are represented
in an isomorphic human-readable way. I.e. every control character has exactly
one human-readable representation, and a mapping exists from the human-readable
representation to the control character. Therefore, the use of Unicode Control
Characters (U+240x) is not permitted without additional marker.</p>

<h1 id='crypto' class='section-header'><a href='#crypto'>2 Crypto</a></h1>
<p>The Crypto module contains all the functions and data types related to
cryptography. This includes random number generation, encryption and
decryption, key generation, operations on nonces and generating random nonces.</p>

<h2 id='key' class='section-header'><a href='#key'>2.1 Key</a></h2>
<p>A Crypto Number is a large fixed size unsigned (positive) integer. Its binary
encoding is as a Big Endian integer in exactly the encoded byte size. Its
human-readable encoding is as a base-16 number encoded as String. The NaCl
implementation <a href="https://github.com/jedisct1/libsodium">libsodium</a> supplies the
functions <code>sodium_bin2hex</code> and <code>sodium_hex2bin</code> to aid in implementing the
human-readable encoding. The in-memory encoding of these crypto numbers in NaCl
already satisfies the binary encoding, so for applications directly using those
APIs, binary encoding and decoding is the <a href="https://en.wikipedia.org/wiki/Identity_function">identity
function</a>.</p>

<p>Tox uses four kinds of Crypto Numbers:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Type</th>
<th style="text-align: left">Bits</th>
<th style="text-align: left">Encoded byte size</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">Public Key</td>
<td style="text-align: left">256</td>
<td style="text-align: left">32</td>
</tr>
<tr>
<td style="text-align: left">Secret Key</td>
<td style="text-align: left">256</td>
<td style="text-align: left">32</td>
</tr>
<tr>
<td style="text-align: left">Combined Key</td>
<td style="text-align: left">256</td>
<td style="text-align: left">32</td>
</tr>
<tr>
<td style="text-align: left">Nonce</td>
<td style="text-align: left">192</td>
<td style="text-align: left">24</td>
</tr>
</tbody>
</table>

<h3 id='key-pair' class='section-header'><a href='#key-pair'>2.1.1 Key Pair</a></h3>
<p>A Key Pair is a pair of Secret Key and Public Key. A new key pair is generated
using the <code>crypto_box_keypair</code> function of the NaCl crypto library. Two
separate calls to the key pair generation function must return distinct key
pairs. See the <a href="https://nacl.cr.yp.to/box.html">NaCl documentation</a> for
details.</p>

<p>A Public Key can be computed from a Secret Key using the NaCl function
<code>crypto_scalarmult_base</code>, which computes the scalar product of a standard group
element and the Secret Key. See the <a href="https://nacl.cr.yp.to/scalarmult.html">NaCl
documentation</a> for details.</p>

<h3 id='combined-key' class='section-header'><a href='#combined-key'>2.1.2 Combined Key</a></h3>
<p>A Combined Key is computed from a Secret Key and a Public Key using the NaCl
function <code>crypto_box_beforenm</code>. Given two Key Pairs KP1 (SK1, PK1) and KP2
(SK2, PK2), the Combined Key computed from (SK1, PK2) equals the one computed
from (SK2, PK1). This allows for symmetric encryption, as peers can derive the
same shared key from their own secret key and their peer&#39;s public key.</p>

<p>In the Tox protocol, packets are encrypted using the public key of the receiver
and the secret key of the sender. The receiver decrypts the packets using the
receiver&#39;s secret key and the sender&#39;s public key.</p>

<p>The fact that the same key is used to encrypt and decrypt packets on both sides
means that packets being sent could be replayed back to the sender if there is
nothing to prevent it.</p>

<p>The shared key generation is the most resource intensive part of the
encryption/decryption which means that resource usage can be reduced
considerably by saving the shared keys and reusing them later as much as
possible.</p>

<h3 id='nonce' class='section-header'><a href='#nonce'>2.1.3 Nonce</a></h3>
<p>A random nonce is generated using the cryptographically secure random number
generator from the NaCl library <code>randombytes</code>.</p>

<p>A nonce is incremented by interpreting it as a Big Endian number and adding 1.
If the nonce has the maximum value, the value after the increment is 0.</p>

<p>Most parts of the protocol use random nonces. This prevents new nonces from
being associated with previous nonces. If many different packets could be tied
together due to how the nonces were generated, it might for example lead to
tying DHT and onion announce packets together. This would introduce a flaw in
the system as non friends could tie some people&#39;s DHT keys and long term keys
together.</p>

<h2 id='box' class='section-header'><a href='#box'>2.2 Box</a></h2>
<p>The Tox protocol differentiates between two types of text: Plain Text and
Cipher Text. Cipher Text may be transmitted over untrusted data channels. Plain
Text can be Sensitive or Non Sensitive. Sensitive Plain Text must be
transformed into Cipher Text using the encryption function before it can be
transmitted over untrusted data channels.</p>

<p>The encryption function takes a Combined Key, a Nonce, and a Plain Text, and
returns a Cipher Text. It uses <code>crypto_box_afternm</code> to perform the encryption.
The meaning of the sentence &quot;encrypting with a secret key, a public key, and a
nonce&quot; is: compute a combined key from the secret key and the public key and
then use the encryption function for the transformation.</p>

<p>The decryption function takes a Combined Key, a Nonce, and a Cipher Text, and
returns either a Plain Text or an error. It uses <code>crypto_box_open_afternm</code> from
the NaCl library. Since the cipher is symmetric, the encryption function can
also perform decryption, but will not perform message authentication, so the
implementation must be careful to use the correct functions.</p>

<p><code>crypto_box</code> uses xsalsa20 symmetric encryption and poly1305 authentication.</p>

<p>The create and handle request functions are the encrypt and decrypt functions
for a type of DHT packets used to send data directly to other DHT nodes. To be
honest they should probably be in the DHT module but they seem to fit better
here. TODO: What exactly are these functions?</p>

<h1 id='node-info' class='section-header'><a href='#node-info'>3 Node Info</a></h1>
<h2 id='transport-protocol' class='section-header'><a href='#transport-protocol'>3.1 Transport Protocol</a></h2>
<p>A Transport Protocol is a transport layer protocol directly below the Tox
protocol itself. Tox supports two transport protocols: UDP and TCP. The binary
representation of the Transport Protocol is a single bit: 0 for UDP, 1 for TCP.
If encoded as standalone value, the bit is stored in the least significant bit
of a byte. If followed by other bit-packed data, it consumes exactly one bit.</p>

<p>The human-readable representation for UDP is <code>UDP</code> and for TCP is <code>TCP</code>.</p>

<h2 id='host-address' class='section-header'><a href='#host-address'>3.2 Host Address</a></h2>
<p>A Host Address is either an IPv4 or an IPv6 address. The binary representation
of an IPv4 address is a Big Endian 32 bit unsigned integer (4 bytes). For an
IPv6 address, it is a Big Endian 128 bit unsigned integer (16 bytes). The
binary representation of a Host Address is a 7 bit unsigned integer specifying
the address family (2 for IPv4, 10 for IPv6), followed by the address itself.</p>

<p>Thus, when packed together with the Transport Protocol, the first bit of the
packed byte is the protocol and the next 7 bits are the address family.</p>

<h2 id='port-number' class='section-header'><a href='#port-number'>3.3 Port Number</a></h2>
<p>A Port Number is a 16 bit number. Its binary representation is a Big Endian 16
bit unsigned integer (2 bytes).</p>

<h2 id='socket-address' class='section-header'><a href='#socket-address'>3.4 Socket Address</a></h2>
<p>A Socket Address is a pair of Host Address and Port Number. Together with a
Transport Protocol, it is sufficient information to address a network port on
any internet host.</p>

<h2 id='node-info-packed-node-format' class='section-header'><a href='#node-info-packed-node-format'>3.5 Node Info (packed node format)</a></h2>
<p>The Node Info data structure contains a Transport Protocol, a Socket Address,
and a Public Key. This is sufficient information to start communicating with
that node. The binary representation of a Node Info is called the &quot;packed node
format&quot;.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code> bit</td>
<td style="text-align: left">Transport Protocol</td>
<td style="text-align: left">UDP = 0, TCP = 1</td>
</tr>
<tr>
<td style="text-align: left"><code>7</code> bit</td>
<td style="text-align: left">Address Family</td>
<td style="text-align: left">2 = IPv4, 10 = IPv6</td>
</tr>
<tr>
<td style="text-align: left"><code>4 | 16</code></td>
<td style="text-align: left">IP address</td>
<td style="text-align: left">4 bytes for IPv4, 16 bytes for IPv6</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left">Port Number</td>
<td style="text-align: left">Port number</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public Key</td>
<td style="text-align: left">Node ID</td>
</tr>
</tbody>
</table>

<p>The packed node format is a way to store the node info in a small yet easy to
parse format. To store more than one node, simply append another one to the
previous one: <code>[packed node 1][packed node 2][...]</code>.</p>

<p>In the packed node format, the first byte (high bit protocol, lower 7 bits
address family) are called the IP Type. The following table is informative and
can be used to simplify the implementation.</p>

<table>
<thead>
<tr>
<th style="text-align: left">IP Type</th>
<th style="text-align: left">Transport Protocol</th>
<th style="text-align: left">Address Family</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>2 (0x02)</code></td>
<td style="text-align: left">UDP</td>
<td style="text-align: left">IPv4</td>
</tr>
<tr>
<td style="text-align: left"><code>10 (0x0a)</code></td>
<td style="text-align: left">UDP</td>
<td style="text-align: left">IPv6</td>
</tr>
<tr>
<td style="text-align: left"><code>130 (0x82)</code></td>
<td style="text-align: left">TCP</td>
<td style="text-align: left">IPv4</td>
</tr>
<tr>
<td style="text-align: left"><code>138 (0x8a)</code></td>
<td style="text-align: left">TCP</td>
<td style="text-align: left">IPv6</td>
</tr>
</tbody>
</table>

<p>The number <code>130</code> is used for an IPv4 TCP relay and <code>138</code> is used to indicate an
IPv6 TCP relay.</p>

<p>The reason for these numbers is that the numbers on Linux for IPv4 and IPv6
(the <code>AF_INET</code> and <code>AF_INET6</code> defines) are <code>2</code> and <code>10</code>. The TCP numbers are
just the UDP numbers <code>+ 128</code>.</p>

<h1 id='protocol-packet' class='section-header'><a href='#protocol-packet'>4 Protocol Packet</a></h1>
<p>A Protocol Packet is the top level Tox protocol element. All other packet types
are wrapped in Protocol Packets. It consists of a Packet Kind and a payload.
The binary representation of a Packet Kind is a single byte (8 bits). The
payload is an arbitrary sequence of bytes.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left">Packet Kind</td>
<td style="text-align: left">The packet kind identifier</td>
</tr>
<tr>
<td style="text-align: left"><code>[0,]</code></td>
<td style="text-align: left">Bytes</td>
<td style="text-align: left">Payload</td>
</tr>
</tbody>
</table>

<p>These top level packets can be transported in a number of ways, the most common
way being over the network using UDP or TCP. The protocol itself does not
prescribe transport methods, and an implementation is free to implement
additional transports such as WebRTC, IRC, or pipes.</p>

<p>In the remainder of the document, different kinds of Protocol Packet are
specified with their packet kind and payload. The packet kind is not repeated
in the payload description (TODO: actually it mostly is, but later it won&#39;t).</p>

<p>Inside Protocol Packets payload, other packet types can specify additional
packet kinds. E.g. inside a Crypto Data packet (<code>0x1b</code>), the
<a href="#messenger">Messenger</a> module defines its protocols for messaging, file
transfers, etc. Top level Protocol Packets are themselves not encrypted, though
their payload may be.</p>

<h2 id='packet-kind' class='section-header'><a href='#packet-kind'>4.1 Packet Kind</a></h2>
<p>The following is an exhaustive list of top level packet kind names and their
number. Their payload is specified in dedicated sections. Each section is named
after the Packet Kind it describes followed by the byte value in parentheses,
e.g. <a href="#ping-request-0x00">Ping Request (0x00)</a>.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Byte value</th>
<th style="text-align: left">Packet Kind</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>0x00</code></td>
<td style="text-align: left">Ping Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x01</code></td>
<td style="text-align: left">Ping Response</td>
</tr>
<tr>
<td style="text-align: left"><code>0x02</code></td>
<td style="text-align: left">Nodes Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x04</code></td>
<td style="text-align: left">Nodes Response</td>
</tr>
<tr>
<td style="text-align: left"><code>0x18</code></td>
<td style="text-align: left">Cookie Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x19</code></td>
<td style="text-align: left">Cookie Response</td>
</tr>
<tr>
<td style="text-align: left"><code>0x1a</code></td>
<td style="text-align: left">Crypto Handshake</td>
</tr>
<tr>
<td style="text-align: left"><code>0x1b</code></td>
<td style="text-align: left">Crypto Data</td>
</tr>
<tr>
<td style="text-align: left"><code>0x20</code></td>
<td style="text-align: left">DHT Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x21</code></td>
<td style="text-align: left">LAN Discovery</td>
</tr>
<tr>
<td style="text-align: left"><code>0x80</code></td>
<td style="text-align: left">Onion Request 0</td>
</tr>
<tr>
<td style="text-align: left"><code>0x81</code></td>
<td style="text-align: left">Onion Request 1</td>
</tr>
<tr>
<td style="text-align: left"><code>0x82</code></td>
<td style="text-align: left">Onion Request 2</td>
</tr>
<tr>
<td style="text-align: left"><code>0x83</code></td>
<td style="text-align: left">Announce Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x84</code></td>
<td style="text-align: left">Announce Response</td>
</tr>
<tr>
<td style="text-align: left"><code>0x85</code></td>
<td style="text-align: left">Onion Data Request</td>
</tr>
<tr>
<td style="text-align: left"><code>0x86</code></td>
<td style="text-align: left">Onion Data Response</td>
</tr>
<tr>
<td style="text-align: left"><code>0x8c</code></td>
<td style="text-align: left">Onion Response 3</td>
</tr>
<tr>
<td style="text-align: left"><code>0x8d</code></td>
<td style="text-align: left">Onion Response 2</td>
</tr>
<tr>
<td style="text-align: left"><code>0x8e</code></td>
<td style="text-align: left">Onion Response 1</td>
</tr>
<tr>
<td style="text-align: left"><code>0xf0</code></td>
<td style="text-align: left">Bootstrap Info</td>
</tr>
</tbody>
</table>

<h1 id='dht' class='section-header'><a href='#dht'>5 DHT</a></h1>
<p>The DHT is a self-organizing swarm of all nodes in the Tox network. A node in
the Tox network is also called &quot;Tox node&quot;. When we talk about &quot;peers&quot;, we mean
any node that is not the local node (the subject). This module takes care of
finding the IP and port of nodes and establishing a route to them directly via
UDP using <a href="#hole-punching">hole-punching</a> if necessary. The DHT only runs on
UDP and so is only used if UDP works.</p>

<p>Every node in the Tox DHT has an ephemeral Key Pair called the DHT Key Pair
consisting of the DHT Secret Key and the DHT Public Key. The DHT Public Key
acts as the node address. The DHT Key Pair is renewed every time the tox
instance is closed or restarted. An implementation may choose to renew the key
more often, but doing so will disconnect all peers.</p>

<p>The DHT public key of a friend is found using the <a href="#onion">onion</a> module. Once
the DHT public key of a friend is known, the DHT is used to find them and
connect directly to them via UDP.</p>

<h2 id='distance' class='section-header'><a href='#distance'>5.1 Distance</a></h2>
<p>A Distance is a positive integer. Its human-readable representation is a
base-16 number. Distance (type) is an <a href="https://en.wikipedia.org/wiki/Ordered_semigroup">ordered
monoid</a> with the associative
binary operator <code>+</code> and the identity element <code>0</code>.</p>

<p>The DHT uses a <a href="https://en.wikipedia.org/wiki/Metric_(mathematics)">metric</a> to
determine distance between two nodes. The Distance type is the co-domain of
this metric. The metric currently used by the Tox DHT is the <code>XOR</code> of the
nodes&#39; public keys: <code>distance(x, y) = x XOR y</code>. For this computation, public
keys are interpreted as Big Endian integers (see <a href="#key-1">Crypto Numbers</a>).</p>

<p>When we speak of a &quot;close node&quot;, we mean that its Distance to the node under
consideration is small compared to the Distance to other nodes.</p>

<p>An implementation is not required to provide a Distance type, so it has no
specified binary representation. For example, instead of computing a distance
and comparing it against another distance, the implementation can choose to
implement Distance as a pair of public keys and define an ordering on Distance
without computing the complete integral value. This works, because as soon as
an ordering decision can be made in the most significant bits, further bits
won&#39;t influence that decision.</p>

<p>XOR is a valid metric, i.e. it satisfies the required conditions:</p>

<ol>
<li><p>Non-negativity <code>distance(x, y) &gt;= 0</code>: Since public keys are Crypto Numbers,
which are by definition positive, their XOR is necessarily positive.</p></li>
<li><p>Identity of indiscernibles <code>distance(x, y) == 0</code> iff <code>x == y</code>: The XOR of
two integers is zero iff they are equal.</p></li>
<li><p>Symmetry <code>distance(x, y) == distance(y, x)</code>: XOR is a symmetric operation.</p></li>
<li><p>Subadditivity <code>distance(x, z) &lt;= distance(x, y) + distance(y, z)</code>: follows
from associativity, since
<code>x XOR z = x XOR (y XOR y) XOR z = distance(x, y) XOR distance(y, z)</code> which
is not greater than <code>distance(x, y) + distance(y, z)</code>.</p></li>
</ol>

<p>In addition, XOR has other useful properties:</p>

<ul>
<li><p>Unidirectionality: given the key <code>x</code> and the distance <code>d</code> there exist one
and only one key <code>y</code> such that <code>distance(x, y) = d</code>.</p>

<p>The implication is that repeated lookups are likely to pass along the same
way and thus caching makes sense.</p>

<p>Source:
<a href="http://pdos.csail.mit.edu/%7Epetar/papers/maymounkov-kademlia-lncs.pdf">maymounkov-kademlia</a></p></li>
</ul>

<p>Example: Given three nodes with keys 2, 5, and 6:</p>

<ul>
<li><p><code>2 XOR 5 = 7</code></p></li>
<li><p><code>2 XOR 6 = 4</code></p></li>
<li><p><code>5 XOR 2 = 7</code></p></li>
<li><p><code>5 XOR 6 = 3</code></p></li>
<li><p><code>6 XOR 2 = 4</code></p></li>
<li><p><code>6 XOR 5 = 3</code></p></li>
</ul>

<p>The closest node from both 2 and 5 is 6. The closest node from 6 is 5 with
distance 3. This example shows that a key that is close in terms of integer
addition may not necessarily be close in terms of XOR.</p>

<h2 id='k-buckets' class='section-header'><a href='#k-buckets'>5.2 K-buckets</a></h2>
<p>K-buckets is a data structure for efficiently storing a set of nodes close to a
certain key called the base key. The base key is constant throughout the
lifetime of a k-buckets instance.</p>

<p>A k-buckets is a map from small integers <code>0 &lt;= n &lt; 256</code> to a set of up to <code>k</code>
Node Infos. The set is called a bucket. <code>k</code> is called the bucket size. The
default bucket size is 8.</p>

<p>The above number <code>n</code> is the bucket index. It is positive integer with the range
<code>[0, 255]</code>, i.e. the range of an 8 bit unsigned integer.</p>

<p>A bucket entry is an element of the bucket. The bucket is an ordered set, and
the entries are sorted by <a href="#distance">distance</a> from the base key. Thus, the
first (smallest) element of the set is the closest one to the base key in that
set, the last (greatest) element is the furthest away.</p>

<h3 id='bucket-index' class='section-header'><a href='#bucket-index'>5.2.1 Bucket Index</a></h3>
<p>The index of the bucket can be computed using the following function:
<code>bucketIndex(baseKey, nodeKey) = 255 - log_2(distance(baseKey, nodeKey))</code>. This
function is not defined when <code>baseKey == nodeKey</code>, meaning k-buckets will never
contain a Node Info about the base node.</p>

<p>Thus, each k-bucket contains only Node Infos for whose keys the following
holds: if node with key <code>nodeKey</code> is in k-bucket with index <code>n</code>, then
<code>bucketIndex(baseKey, nodeKey) == n</code>. Thus, n&#39;th k-bucket consists of nodes for
which distance to the base node lies in range <code>[2^n, 2^(n+1) - 1]</code>.</p>

<p>The bucket index can be efficiently computed by determining the first bit at
which the two keys differ, starting from the most significant bit. So, if the
local DHT key starts with e.g. <code>0x80</code> and the bucketed node key starts with
<code>0x40</code>, then the bucket index for that node is 0. If the second bit differs,
the bucket index is 1. If the keys are almost exactly equal and only the last
bit differs, the bucket index is 255.</p>

<h3 id='updating-k-buckets' class='section-header'><a href='#updating-k-buckets'>5.2.2 Updating k-buckets</a></h3>
<p>TODO: this is different from kademlia&#39;s least-recently-seen eviction policy;
why the existing solution was chosen, how does it affect security, performance
and resistance to poisoning? original paper claims that preference of old live
nodes results in better persistence and resistance to basic DDoS attacks;</p>

<p>Any update or lookup operation on a k-buckets instance that involves a single
node requires us to first compute the bucket index for that node. An update
involving a Node Info with <code>nodeKey == baseKey</code> has no effect. If the update
results in an empty bucket, that bucket is removed from the map.</p>

<p>A bucket is <em>full</em> when the bucket contains the maximum number of entries
configured by the bucket size.</p>

<p>A node is <em>viable</em> for entry if the bucket is not <em>full</em> or the node&#39;s public
key has a lower distance from the base key than the current entry with the
greatest distance.</p>

<p>If a node is <em>viable</em> and the bucket is <em>full</em>, the entry with the greatest
distance from the base key is removed to keep the bucket size below the maximum
configured bucket size.</p>

<p>Adding a node whose key already exists will result in an update of the Node
Info in the bucket. Removing a node for which no Node Info exists in the
k-buckets has no effect. Thus, removing a node twice is permitted and has the
same effect as removing it once.</p>

<h2 id='dht-node-state' class='section-header'><a href='#dht-node-state'>5.3 DHT node state</a></h2>
<p>Every DHT node contains a Key Pair called the DHT Key Pair.</p>

<p>A DHT node also stores a set of Node Infos of nodes that are close to its own
DHT public key. It uses the <a href="#k-buckets">k-buckets</a> data structure for this,
with the local DHT Public Key as the base key.</p>

<h2 id='self-organisation' class='section-header'><a href='#self-organisation'>5.4 Self-organisation</a></h2>
<p>Self-organising in the DHT occurs through each DHT peer connecting to an
arbitrary number of peers closest to their own DHT public key and some that are
further away.</p>

<p>If each peer in the network knows the peers with the DHT public key closest to
its DHT public key, then to find a specific peer with public key X a peer just
needs to recursively ask peers in the DHT for known peers that have the DHT
public keys closest to X. Eventually the peer will find the peers in the DHT
that are the closest to that peer and, if that peer is online, they will find
them.</p>

<h2 id='dht-packet' class='section-header'><a href='#dht-packet'>5.5 DHT Packet</a></h2>
<p>The DHT Packet contains the sender&#39;s DHT Public Key, an encryption Nonce, and
an encrypted payload. The payload is encrypted with the DHT secret key of the
sender, the DHT public key of the receiver, and the nonce that is sent along
with the packet. DHT Packets are sent inside Protocol Packets with a varying
Packet Kind.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#protocol-packet">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public Key</td>
<td style="text-align: left">Sender DHT Public Key</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
<td style="text-align: left">Random nonce</td>
</tr>
<tr>
<td style="text-align: left"><code>[16,]</code></td>
<td style="text-align: left">Bytes</td>
<td style="text-align: left">Encrypted payload</td>
</tr>
</tbody>
</table>

<p>The encrypted payload is at least 16 bytes long, because the encryption
includes a <a href="https://en.wikipedia.org/wiki/Message_authentication_code">MAC</a> of
16 bytes. A 16 byte payload would thus be the empty message. The DHT protocol
never actually sends empty messages, so in reality the minimum size is 27 bytes
for the <a href="#ping-service">Ping Packet</a>.</p>

<h2 id='rpc-services' class='section-header'><a href='#rpc-services'>5.6 RPC Services</a></h2>
<p>A DHT RPC Service consists of a Request packet and a Response packet. A DHT RPC
Packet contains a payload and a Request ID. This ID is a 64 bit unsigned
integer that helps identify the response for a given request. The Request ID in
the response packet must be equal to the Request ID in the request it is
responding to.</p>

<p>DHT RPC Packets are encrypted and transported within DHT Packets.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#dht-packet">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>[0,]</code></td>
<td style="text-align: left">Bytes</td>
<td style="text-align: left">Payload</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code></td>
<td style="text-align: left">Request ID</td>
</tr>
</tbody>
</table>

<p>The minimum payload size is 0, but in reality the smallest sensible payload
size is 1. Since the same symmetric key is used in both communication
directions, an encrypted Request would be a valid encrypted Response if they
contained the same plaintext.</p>

<p>Parts of the protocol using RPC packets must take care to make Request payloads
not be valid Response payloads. For instance, <a href="#ping-service">Ping Packets</a>
carry a boolean flag that indicate whether the payload corresponds to a Request
or a Response.</p>

<p>The Request ID provides some resistance against replay attacks. If there were
no Request ID, it would be easy for an attacker to replay old responses and
thus provide nodes with out-of-date information. The exact value of the Request
ID will be specified later in the DHT section.</p>

<h3 id='ping-service' class='section-header'><a href='#ping-service'>5.6.1 Ping Service</a></h3>
<p>The Ping Service is used to periodically check if another node is still alive.</p>

<p>A Ping Packet payload consists of just a boolean value saying whether it is a
request or a response.</p>

<p>The one byte boolean inside the encrypted payload is added to prevent peers
from creating a valid Ping Response from a Ping Request without decrypting the
packet and encrypting a new one. Since symmetric encryption is used, the
encrypted Ping Response would be byte-wise equal to the Ping Request without
the discriminator byte.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#rpc-services">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left">Bool</td>
<td style="text-align: left">Response flag: 0x00 for Request, 0x01 for Response</td>
</tr>
</tbody>
</table>

<h4 id='ping-request-0x00' class='section-header'><a href='#ping-request-0x00'>5.6.1.1 Ping Request (0x00)</a></h4>
<p>A Ping Request is a Ping Packet with the response flag set to False. When a
Ping Request is received and successfully decrypted, a Ping Response packet is
created and sent back to the requestor.</p>

<h4 id='ping-response-0x01' class='section-header'><a href='#ping-response-0x01'>5.6.1.2 Ping Response (0x01)</a></h4>
<p>A Ping Response is a Ping Packet with the response flag set to True.</p>

<h3 id='nodes-service' class='section-header'><a href='#nodes-service'>5.6.2 Nodes Service</a></h3>
<p>The Nodes Service is used to query another DHT node for up to 4 nodes they know
that are the closest to a requested node.</p>

<p>The DHT Nodes RPC service uses the
<a href="node-info-packed-node-format">Packed Node Format</a>.</p>

<h4 id='nodes-request-0x02' class='section-header'><a href='#nodes-request-0x02'>5.6.2.1 Nodes Request (0x02)</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#rpc-services">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public Key</td>
<td style="text-align: left"> Requested DHT Public Key</td>
</tr>
</tbody>
</table>

<p>The DHT Public Key sent in the request is the one the sender is searching for.</p>

<h4 id='nodes-response-0x04' class='section-header'><a href='#nodes-response-0x04'>5.6.2.2 Nodes Response (0x04)</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#rpc-services">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left">Int</td>
<td style="text-align: left"> Number of nodes in the response (maximum 4)</td>
</tr>
<tr>
<td style="text-align: left"><code>[39, 204]</code></td>
<td style="text-align: left">Node Infos</td>
<td style="text-align: left">Nodes in Packed Node Format</td>
</tr>
</tbody>
</table>

<p>An IPv4 node is 39 bytes, an IPv6 node is 51 bytes, so the maximum size is
<code>51 * 4 = 204</code> bytes.</p>

<p>Nodes responses should contain the 4 closest nodes that the sender of the
response has in their list of known nodes.</p>

<h2 id='dht-operation' class='section-header'><a href='#dht-operation'>5.7 DHT operation</a></h2>
<p>Only the UDP Protocol (IP Type <code>2</code> and <code>10</code>) are used in the DHT module when
sending nodes with the packed node format. This is because the TCP Protocol is
used to send TCP relay information and the DHT is UDP only.</p>

<p>This is done to increase the speed at which peers are found. Toxcore also
stores the 8 nodes (Must be the same or smaller than the nodes toxcore stores
for each index in its close list to make sure all the closest peers found will
know the node being searched) closest to each of the public keys in its DHT
friends list (or list of DHT public keys that it actively tries to find and
connect to). Toxcore pings every node in the lists every 60 seconds to see if
they are alive. It does not store itself in either list and does not send any
requests to itself. Nodes can be in more than one list for example if the DHT
public key of the peer is very close to the DHT public key of a friend being
searched. It also sends get node requests to a random node (random makes it
unpredictable, predictability or knowing which node a node will ping next could
make some attacks that disrupt the network more easy as it adds a possible
attack vector) in each of these lists of nodes every 20 seconds, with the
search public key being its public key for the closest node and the public key
being searched for being the ones in the DHT friends list. Nodes are removed
after 122 seconds of no response. Nodes are added to the lists after a valid
ping response or send node packet is received from them. If the node is already
present in the list it is updated if the IP address changed. A node can only be
added to a list if the list is not full or if the nodes DHT public key is
closer than the DHT public key of at least one of the nodes in the list to the
public key being searched with that list. When a node is added to a full list,
it will replace the furthest node.</p>

<p>If the 32 nodes number were increased, it would increase the amount of packets
needed to check if each of them is still alive which would increase the
bandwidth usage but reliability would go up. If the number of nodes were
decreased, reliability would go down along with bandwidth usage. The reason for
this relationship between reliability and number of nodes is that if we assume
that not every node has its UDP ports open or is behind a cone NAT it means
that each of these nodes must be able to store a certain number of nodes behind
restrictive NATs in order for others to be able to find those nodes behind
restrictive NATs. For example if 7/8 nodes were behind restrictive NATs, using
8 nodes would not be enough because the chances of some of these nodes being
impossible to find in the network would be too high.</p>

<p>If the ping timeouts and delays between pings were higher it would decrease the
bandwidth usage but increase the amount of disconnected nodes that are still
being stored in the lists. Decreasing these delays would do the opposite.</p>

<p>If the number 8 of nodes closest to each public key were increased to 16 it
would increase the bandwidth usage, might increase hole punching efficiency on
symmetric NATs (more ports to guess from, see Hole punching) and might increase
the reliability. Lowering this number would have the opposite effect.</p>

<p>When receiving a send node packet, toxcore will check if each of the received
nodes could be added to any one of the lists. If the node can, toxcore will
send a ping packet to it, if it cannot it will be ignored.</p>

<p>When receiving a get node packet, toxcore will find the 4 nodes, in its nodes
lists, closest to the public key in the packet and send them in the send node
response.</p>

<p>The timeouts and number of nodes in lists for toxcore were picked by feeling
alone and are probably not the best values. This also applies to the behavior
which is simple and should be improved in order to make the network resist
better to sybil attacks.</p>

<h2 id='dht-request-packets' class='section-header'><a href='#dht-request-packets'>5.8 DHT Request packets</a></h2>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x20)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">receiver&#39;s DHT public key</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">sender&#39;s DHT public key</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">nonce</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">encrypted message</td>
</tr>
</tbody>
</table>

<p>DHT Request packets are packets that can be sent across one DHT node to one
that they know. They are used to send encrypted data to friends that we are not
necessarily connected to directly in the DHT.</p>

<p>A DHT node that receives a DHT request packet will check whether the receivers
public key is their DHT public key and, if it is, they will decrypt and handle
the packet. If it is not they will check whether they know that DHT public key
(if it&#39;s in their list of close nodes). If it isn&#39;t, they will drop the packet.
If it is they will resend the exact packet to that DHT node.</p>

<p>The encrypted message is encrypted using the receiver&#39;s DHT Public key, the
sender&#39;s DHT private key and the nonce (randomly generated 24 bytes).</p>

<p>DHT request packets are used for DHTPK packets (see onion) and NAT ping
packets.</p>

<h3 id='nat-ping-packets' class='section-header'><a href='#nat-ping-packets'>5.8.1 NAT ping packets</a></h3>
<p>Encapsulated in the DHT request packet.</p>

<p><code>NAT ping packet</code>s are used to check whether a friend we are not connected to
directly is online and ready to do hole-punching.</p>

<h4 id='nat-ping-request' class='section-header'><a href='#nat-ping-request'>5.8.1.1 NAT ping request</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0xfe)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x00)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> random number</td>
</tr>
</tbody>
</table>

<p>Received <code>NAT ping request</code> needs to be checked if it is from a friend.</p>

<p>Check is performed by comparing the Public Key from <a href="#dht-request-packets">DHT request
packet</a> that given <code>NAT ping request</code> was encapsulated in
with the list of Public Keys of own <code>friend</code>s.</p>

<p>If <code>NAT ping request</code> is…</p>

<ul>
<li>  … from own <code>friend</code>, a <a href="#nat-ping-response"><code>NAT ping response</code></a> with the
same <code>random number</code> that request has should be sent back via the nodes
that know the friend sending the request.

<ul>
<li>  If there are no known nodes that know the <code>friend</code>, packet will be
dropped.</li>
</ul></li>
<li>  … not from own <code>friend</code>, packet will be dropped.</li>
</ul>

<h4 id='nat-ping-response' class='section-header'><a href='#nat-ping-response'>5.8.1.2 NAT ping response</a></h4>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0xfe)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x01)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> random number (the same that was received in request)</td>
</tr>
</tbody>
</table>

<h2 id='hole-punching' class='section-header'><a href='#hole-punching'>5.9 Hole-punching</a></h2>
<p>Mechanism to determine whether hole-punching should be started:</p>

<ol>
<li> Request from 8 closest to own node peers <code>IP:port</code> of friend.
<a href="TODO:_how?"></a></li>
<li> At least 4+ of nodes return <code>IP:port</code> of the friend.</li>
<li> Send <a href="#ping-service">DHT ping request</a> to each of those <code>IP:port</code>s.</li>
<li> If no response is received, start hole-punching.</li>
</ol>

<p><em>The numbers <code>8</code> and <code>4</code> are used in toxcore and were chosen based on &quot;the
feel&quot; alone and might not be optimal.</em></p>

<p>Before hole-punching is started, a <a href="#net-ping-packets">NAT ping packet</a> is sent
to the friend via peers that claim to know the friend. If <a href="#nat-ping-response">NAT ping
response</a> with the same random number is received,
hole-punching should be started.</p>

<p>Receiving a <code>NAT ping response</code> means that the friend is both online and
actively searching for us, since that is the only way they would know nodes
that know us. <strong>Hole-punching will work only if the friend is actively trying
to connect to us.</strong></p>

<p><code>NAT ping request</code>s are sent every 3 seconds in toxcore. If no response is
received for 6 seconds, the hole-punching will stop.</p>

<p>Sending <code>NAT ping request</code>s in longer intervals might increase the possibility
of the other node going offline and ping packets sent in the hole-punching
being sent to a dead peer, but potentially it could decrease bandwidth usage.
Decreasing the intervals will have the opposite effect.</p>

<p>For hole-punching we <em>assume</em> that people using Tox are on one of 3 types of
NAT:</p>

<ul>
<li>  <a href="#cone-nat"><code>Cone NAT</code></a></li>
<li>  <a href="#restricted-cone-nat"><code>Restricted Cone NAT</code></a></li>
<li>  <a href="#symmetric-nat"><code>Symmetric NAT</code></a></li>
</ul>

<p>There are 3 cases that toxcore can encounter when hole-punching:</p>

<ul>
<li>  4+ close to given Public Key peers returned the <a href="#restricted-cone-nat">same
<code>IP:port</code></a></li>
<li>  4+ close to given Public Key peers returned the <a href="#symmetric-nat">same <code>IP</code>, but different
<code>port</code></a></li>
<li>  close to given PK peers returns <a href="#different-ipports">different <code>IP:port</code>s</a></li>
</ul>

<h3 id='cone-nat' class='section-header'><a href='#cone-nat'>5.9.1 Cone NAT</a></h3>
<p>Behaviour of the software doing NAT:</p>

<ul>
<li>  Assign one whole port to each UDP socket behind the NAT, any packet from
any <code>IP:port</code> sent to that assigned port from the internet will be
forwarded to the socket behind it.</li>
</ul>

<p>Hole-punching with normal <code>cone NAT</code>s is achieved simply through the way in
which the <a href="#dht">DHT</a> functions, i.e. we send to the <code>IP:port</code> of friend <a href="#ping-service">DHT
ping request</a>, and we receive <a href="#ping-response-0x01">DHT ping
response</a>.</p>

<h3 id='restricted-cone-nat' class='section-header'><a href='#restricted-cone-nat'>5.9.2 Restricted cone NAT</a></h3>
<p>Behaviour of the software doing NAT:</p>

<ul>
<li>  Assign one whole port to each UDP socket behind the NAT. Forward packets
only from <code>IP</code>s that the UDP socket has sent a packet to.</li>
</ul>

<p>When 4+ nodes close to us return the same <code>IP:port</code> of the friend, it means
that the friend is on a <code>restricted cone NAT</code>.</p>

<p>Hole-punching can be done by getting the friend to send a packet to our public
<code>IP:port</code>. This means that hole-punching can be achieved easily and that we
should just continue sending <a href="#ping-service">DHT ping packets</a> regularly to
that <code>IP:port</code> until we get a <a href="#ping-response-0x01">DHT ping response</a>. This
will work because the friend is searching for us in the DHT. Upon finding us
friend will send a packet to our public <code>IP:port</code> (or try to with the
hole-punching), thereby establishing a connection.</p>

<h3 id='symmetric-nat' class='section-header'><a href='#symmetric-nat'>5.9.3 Symmetric NAT</a></h3>
<p><em>It&#39;s the worst.</em></p>

<p>Behaviour of the software doing NAT:</p>

<ul>
<li>  Assign a new port for each <code>IP:port</code> a packet is sent to. Treat each new
peer to which an UDP packet is sent to as a <code>connection</code>. Forward packets
only from the assigned <code>IP:port</code> of that <code>connection</code> to the socket.</li>
<li>  <em>In case of a bad implementation, crash &amp; burn, making users cry.</em></li>
</ul>

<p>Close to us nodes don&#39;t return the same <code>port</code> for friend – this means that the
friend is on a <code>symmetric NAT</code>.</p>

<p>Some symmetric NATs open ports in sequences, which could result in ports
returned by close to us nodes to be e.g. 1345, 1347, 1389, 1395.</p>

<p>Hole-punching with symmetric NATs is done based on guessing which ports are
more likely to be used by friend when they&#39;re trying to send ping request to
us. <a href="#ping-service">DHT ping requests</a> are sent to those ports until
<code>DHT ping response</code> is received.</p>

<p>Toxcore tries all the ports, beside each returned port (e.g. for the 4 ports
previously listed it would try: 1345, 1347, 1389, 1395, 1346, 1348, 1390, 1396,
1344, 1346...), gradually trying ports further away from ones that close to us
nodes reported as working.</p>

<ul>
<li>  Try up to 48 ports every 3 seconds until connection is established.</li>
<li>  After 5 attempts, double (?)range(?) and start trying ports from <code>1024</code>, 48
at the same time, including previously guessed ports.

<ul>
<li>  <em>This seemed to fix it for some symmetric NATs, most likely because a
lot of them restart their count at 1024. – <code>irungentoo</code></em></li>
</ul></li>
</ul>

<p>Increasing the amount of ports tried per second would make the hole-punching
happen faster but also has a potential to DoS NATs due to the large number of
packets being sent to different IPs in a short amount of time. Decreasing the
number of ports would make the hole punching slower.</p>

<p><em>Although this works, the method could be improved.</em></p>

<p>This works in cases where both peers have different NATs. For example, if A and
B are trying to connect to each other: A has a symmetric NAT and B a restricted
cone NAT. A will detect that B has a restricted cone NAT and keep sending ping
packets to B&#39;s one <code>IP:port</code>. B will detect that A has a symmetric NAT and will
send packets to it to try guessing A&#39;s ports. If B manages to guess the port A
is sending packets from they will connect together.</p>

<h3 id='different-ipports' class='section-header'><a href='#different-ipports'>5.9.4 Different <code>IP:port</code>s</a></h3>
<p>May occur when peers return different <code>IP</code>s and <code>port</code>s.</p>

<p>There are 2 cases when this can happen:</p>

<ul>
<li>  the friend is behind a very restrictive NAT that cannot be hole-punched</li>
<li>  the friend recently connected to another internet connection and some peers
still have the outdated information</li>
</ul>

<p>There is nothing that can be done when very restrictive NAT is in play, thus it
is recommended to use the most common <code>IP</code> returned by the peers and ignore
other <code>IP:port</code>s.</p>

<h2 id='dht-bootstrap-info-0xf0' class='section-header'><a href='#dht-bootstrap-info-0xf0'>5.10 DHT Bootstrap Info (0xf0)</a></h2>
<p>Bootstrap nodes are regular Tox nodes with a stable DHT public key. This means
the DHT public key does not change across restarts. DHT bootstrap nodes have
one additional request kind: Bootstrap Info. The request is simply a packet of
length 78 bytes where the first byte is 0xf0. The other bytes are ignored.</p>

<p>The response format is as follows:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Type</th>
<th style="text-align: left"><a href="#protocol-packet">Contents</a></th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left">Word32</td>
<td style="text-align: left"> Bootstrap node version</td>
</tr>
<tr>
<td style="text-align: left"><code>256</code></td>
<td style="text-align: left">Bytes</td>
<td style="text-align: left"> Message of the day</td>
</tr>
</tbody>
</table>

<h1 id='lan-discovery' class='section-header'><a href='#lan-discovery'>6 LAN discovery</a></h1>
<p>LAN discovery is a way to discover Tox peers that are on a local network. If
two Tox friends are on a local network, the most efficient way for them to
communicate together is to use the local network. If a Tox client is opened on
a local network in which another Tox client exists then good behavior would be
to bootstrap to the network using the Tox client on the local network. This is
what LAN discovery aims to accomplish.</p>

<p>LAN discovery works by sending a UDP packet through the toxcore UDP socket to
the interface broadcast address on IPv4, the global broadcast address
(255.255.255.255) and the multicast address on IPv6 (FF02::1) on the default
Tox UDP port (33445).</p>

<p>The LAN Discovery packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (33)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">DHT public key</td>
</tr>
</tbody>
</table>

<p>LAN Discovery packets contain the DHT public key of the sender. When a LAN
Discovery packet is received, a DHT get nodes packet will be sent to the sender
of the packet. This means that the DHT instance will bootstrap itself to every
peer from which it receives one of these packets. Through this mechanism, Tox
clients will bootstrap themselves automatically from other Tox clients running
on the local network.</p>

<p>When enabled, toxcore sends these packets every 10 seconds to keep delays low.
The packets could be sent up to every 60 seconds but this would make peer
finding over the network 6 times slower.</p>

<p>LAN discovery enables two friends on a local network to find each other as the
DHT prioritizes LAN addresses over non LAN addresses for DHT peers. Sending a
get node request/bootstrapping from a peer successfully should also add them to
the list of DHT peers if we are searching for them. The peer must not be
immediately added if a LAN discovery packet with a DHT public key that we are
ping packet must be sent, and a valid response must be received, before we can
say that this peer has been found.</p>

<p>LAN discovery is how Tox handles and makes everything work well on LAN.</p>

<h1 id='tcp-server' class='section-header'><a href='#tcp-server'>7 TCP server</a></h1>
<p>The TCP server has the goal of acting like a TCP relay between clients who
cannot connect directly to each other or who for some reason are limited to
using the TCP protocol to connect to each other. <code>TCP_server</code> is typically run
only on actual server machines but any Tox client could host one as the api to
run one is exposed through the tox.h api.</p>

<p>To connect to a hosted TCP server toxcore uses the TCP client module.</p>

<p>TCP connections between the TCP client and the server are encrypted to prevent
an outsider from knowing information like who is connecting to whom just from
looking at someones connection to a TCP server. This is useful when someone
connects though something like Tor for example. It also prevents 3rd party from
injecting data in the stream and makes it so we can assume that any data
received was not tampered with and is exactly what was sent by the client.</p>

<p>The TCP server essentially acts as just a relay between 2 peers. When a TCP
client connects to the server it tells the server which clients it wants the
server to connect it to. The server will only let two clients connect to each
other if both have indicated to the server that they want to connect to each
other. This is to prevent non friends from checking if someone is connected to
a TCP server. The TCP server supports sending packets blindly through it to
clients with a client with public key X (OOB packets) however the TCP server
does not give any feedback regarding whether the packet arrived or not and thus
it is only useful to send data to friends who may not know that we are
connected to the current TCP server while we know they are.</p>

<p>This occurs when one peer discovers the TCP relay and DHT public key of the
other peer before the other peer discovers its DHT public key. In that case OOB
packets would be used until the other peer knows that the peer is connected to
the relay and establishes a connection through it.</p>

<p>In order to make toxcore work on TCP only the TCP server supports relaying
onion packets from TCP clients and sending any responses from them to TCP
clients.</p>

<h2 id='tcp-connection' class='section-header'><a href='#tcp-connection'>7.1 TCP Connection</a></h2>
<p>When a client first connects to a TCP server they open up a TCP connection to
the IP and port the TCP server is listening on. Once the connection is
established a <a href="#handshake-request">Handshake Request</a> packet is sent. The
server then responds with its <a href="#handshake-response">Handshake Response</a> and a
secure connection is established. The connection is then said to be unconfirmed
and the client must then send some encrypted data to the server before the
server can mark the connection as confirmed.</p>

<p>The reason it works like this is to prevent a type of attack where a peer would
send a handshake packet and then time out right away. To prevent this the
server must wait a few seconds for a sign that the client received handshake
packet before confirming the connection. The both can then communicate with
each other using the encrypted connection.</p>

<h2 id='tcp-handshake' class='section-header'><a href='#tcp-handshake'>7.2 TCP Handshake</a></h2>
<p>The logic behind the format of the handshake is that we:</p>

<ol>
<li><p>need to prove to the server that we own the Private Key related to the
Public Key we are announcing ourselves with.</p></li>
<li><p>need to establish a secure connection that has perfect forward secrecy</p></li>
<li><p>prevent any replay, impersonation or other attacks</p></li>
</ol>

<p>How it accomplishes each of those points:</p>

<ol>
<li><p>If the client does not own the Private Key related to the Public Key it
will not be able to create the handshake packet.</p></li>
<li><p>Temporary session keys generated by the client and server in the encrypted
part of the Handshake Packets are used to encrypt/decrypt packets during
the session.</p></li>
<li><p>The following attacks are prevented:</p>

<ul>
<li><p>Attacker modifies any byte of the Handshake Packets: Decryption fails,
no attacks possible.</p></li>
<li><p>Attacker captures the handshake packet from the client and replays it
later to the server: Attacker will never get the server to confirm the
connection (no effect).</p></li>
<li><p>Attacker captures a server response and sends it to the client next
time they try to connect to the server: Client will never confirm the
connection. (See: <code>TCP_client</code>)</p></li>
<li><p>Attacker tries to impersonate a server: They won&#39;t be able to decrypt
the Handshake and won&#39;t be able to respond.</p></li>
<li><p>Attacker tries to impersonate a client: Server won&#39;t be able to decrypt
the Handshake.</p></li>
</ul></li>
</ol>

<h3 id='handshake-diagram' class='section-header'><a href='#handshake-diagram'>7.2.1 Handshake diagram</a></h3>
<h4 id='handshake-diagram---client' class='section-header'><a href='#handshake-diagram---client'>7.2.1.1 Handshake diagram - client</a></h4>
<pre class="rust rust-example-rendered">
<span class="ident">PK</span> <span class="op">+</span> <span class="ident">PublicKey</span>
<span class="ident">SK</span> <span class="op">+</span> <span class="ident">SecretKey</span>
<span class="ident">PcK</span> <span class="op">+</span> <span class="ident">PrecomputedKey</span> (<span class="ident">Combined</span> <span class="ident">Key</span>)

                <span class="ident">Client</span>                                   <span class="ident">Network</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
<span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                            <span class="op">||</span>
<span class="op">|</span>       <span class="op">|</span> <span class="ident">crypto_box_keypair</span>() <span class="op">|</span>                            <span class="op">||</span>
<span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                            <span class="op">||</span>
<span class="op">|</span>            <span class="op">|</span>             <span class="op">|</span>                                <span class="op">||</span>
<span class="op">|</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                       <span class="op">||</span>
<span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">+</span> <span class="ident">Session</span> <span class="ident">SK</span> <span class="op">|</span>    <span class="op">|</span> <span class="ident">Session</span> <span class="ident">PK</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>              <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>        <span class="op">|</span>  <span class="ident">new</span> <span class="ident">nonce</span>() <span class="op">|</span>              <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>              <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>               <span class="op">|</span>                      <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>             <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>      <span class="op">|</span><span class="ident">client_sent_nonce</span><span class="op">|</span>             <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>             <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>            <span class="op">|</span>                         <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>            <span class="op">|</span>                         <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>            <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>  <span class="op">|</span> <span class="ident">Sender</span> <span class="ident">PK</span>  <span class="op">|</span> <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Payload</span>          <span class="op">|</span>     <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>      <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>     <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>      <span class="op">|</span> <span class="op">|</span><span class="ident">Session</span> <span class="ident">PK</span>       &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>      <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>           <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>      <span class="op">+</span><span class="op">-&gt;</span><span class="ident">client_sent_nonce</span><span class="op">|</span>           <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>           <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>            <span class="op">|</span>  <span class="ident">new</span> <span class="ident">nonce</span>() <span class="op">|</span>          <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>                    <span class="op">|</span>                 <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">|</span>           <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="ident">Nonce</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">|</span>    <span class="op">|</span>      <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">|</span>    <span class="op">|</span>      <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">|</span> <span class="ident">Client</span> <span class="ident">SK</span>  <span class="op">|</span>  <span class="op">|</span><span class="ident">Client</span> <span class="ident">PK</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">|</span>    <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>           <span class="op">|</span>                     <span class="op">|</span>    <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>    <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>                          <span class="op">|</span>      <span class="op">|</span>    <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>                          <span class="op">|</span>      <span class="op">|</span>    <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">+</span>  <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">|</span>  <span class="ident">PcK</span>  &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">precomputed</span>()<span class="op">|</span>  <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">+</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>     <span class="op">|</span>   <span class="op">|</span>                            <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                      <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>     <span class="op">|</span>         <span class="op">|</span>                      <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">|</span>    <span class="op">|</span>     <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">|</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>     <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">seal_precomputed</span>() &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>           <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>            <span class="op">|</span>                     <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>            <span class="op">|</span>                     <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>            <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">|</span><span class="ident">Encrypted</span> <span class="ident">Payload</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>     <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>                            <span class="op">|</span>     <span class="op">|</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>     <span class="op">|</span>    <span class="op">||</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">|</span><span class="ident">Packet</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">Packet</span><span class="op">|</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>     <span class="op">|</span>    <span class="op">||</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">|</span><span class="ident">Client</span> <span class="ident">PK</span>        &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">|</span>     <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>          <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">Nonce</span>            <span class="op">|</span>      <span class="op">|</span>          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">|</span>          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                <span class="op">|</span>   <span class="op">|</span><span class="ident">Encrypted</span> <span class="ident">Payload</span>&lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                <span class="op">|</span>                                       <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span><span class="ident">Packet</span>           &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Packet</span><span class="op">|</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Nonce</span>            <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">|</span>  <span class="op">|</span>     <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">|</span>  <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Encrypted</span> <span class="ident">Payload</span><span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>           <span class="op">|</span>  <span class="op">|</span> <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>   <span class="op">|</span><span class="ident">open_precomputed</span>()<span class="op">|</span>                                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>             <span class="op">|</span>                                          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>             <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                          <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                    <span class="op">|</span><span class="ident">Payload</span>          <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">|</span>                    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Session</span> <span class="ident">PK</span>       <span class="op">|</span>                 <span class="op">||</span>
<span class="op">|</span>               <span class="op">|</span>   <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">||</span>
<span class="op">|</span>               <span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span><span class="ident">sender_sent_nonce</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>            <span class="op">||</span>
<span class="op">|</span>               <span class="op">|</span>   <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">|</span>            <span class="op">||</span>
<span class="op">|</span>               <span class="op">|</span>   <span class="op">|</span>                          <span class="op">|</span>            <span class="op">||</span>
<span class="op">|</span>               <span class="op">|</span>   <span class="op">|</span>                          <span class="op">|</span>            <span class="op">||</span>
<span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                     <span class="op">|</span>            <span class="op">||</span>
<span class="op">|</span>           <span class="op">|</span><span class="ident">precompute</span>()<span class="op">|</span>               <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>            <span class="op">||</span>
<span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>               <span class="op">|</span>                  <span class="op">||</span>
<span class="op">|</span>                 <span class="op">|</span>                      <span class="op">|</span>                  <span class="op">||</span>
<span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">||</span>
<span class="op">|</span>           <span class="op">|</span><span class="ident">Session</span> <span class="ident">PcK</span> <span class="op">|</span>      <span class="op">|</span><span class="ident">client_recv_nonce</span><span class="op">|</span>         <span class="op">||</span>
<span class="op">|</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">||</span>
<span class="op">|</span>                                                           <span class="op">||</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span></pre>

<h4 id='handshake-diagram---server' class='section-header'><a href='#handshake-diagram---server'>7.2.1.2 Handshake diagram - server</a></h4>
<pre class="rust rust-example-rendered">
<span class="ident">PK</span> <span class="op">+</span> <span class="ident">PublicKey</span>
<span class="ident">SK</span> <span class="op">+</span> <span class="ident">SecretKey</span>
<span class="ident">PcK</span> <span class="op">+</span> <span class="ident">PrecomputedKey</span> (<span class="ident">Combined</span> <span class="ident">Key</span>)


        <span class="ident">Network</span>                   <span class="ident">Server</span>
           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>
           <span class="op">||</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                                    <span class="op">|</span>
           <span class="op">||</span>       <span class="op">|</span> <span class="ident">crypto_box_keypair</span>() <span class="op">|</span>                                    <span class="op">|</span>
           <span class="op">||</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                                    <span class="op">|</span>
           <span class="op">||</span>            <span class="op">|</span>             <span class="op">|</span>                                        <span class="op">|</span>
           <span class="op">||</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                               <span class="op">|</span>
           <span class="op">||</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="ident">Session</span> <span class="ident">PK</span> <span class="op">|</span>    <span class="op">|</span> <span class="ident">Session</span> <span class="ident">SK</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                  <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                           <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>         <span class="op">|</span>  <span class="ident">new</span> <span class="ident">nonce</span>() <span class="op">|</span>                           <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                           <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>                <span class="op">|</span>                                   <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">server_sent_nonce</span><span class="op">|</span>                          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>     <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                                                  <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                            <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>        <span class="op">|</span> <span class="ident">Server</span> <span class="ident">SK</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                 <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                                       <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                                       <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                                       <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>              <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
<span class="op">|</span> <span class="ident">Packet</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">Packet</span>           <span class="op">|</span>              <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>      <span class="op">|</span><span class="ident">Client</span> <span class="ident">PK</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">precomputed</span>()<span class="op">|</span> <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Nonce</span>            <span class="op">|</span>              <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span>   <span class="op">|</span><span class="ident">Encrypted</span> <span class="ident">Payload</span><span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="ident">PcK</span>  <span class="op">|</span>     <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>  <span class="op">|</span>        <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span>              <span class="op">|</span>         <span class="op">|</span>           <span class="op">|</span>          <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span>         <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>       <span class="op">|</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">open_precomputed</span>()<span class="op">|</span>       <span class="op">|</span> <span class="op">+</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">precompute</span>()<span class="op">|</span>     <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>       <span class="op">|</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>     <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                     <span class="op">|</span>                 <span class="op">|</span> <span class="op">|</span>        <span class="op">|</span>            <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">|</span><span class="ident">Payload</span>          <span class="op">|</span>        <span class="op">|</span> <span class="op">|</span>  <span class="op">|</span><span class="ident">Session</span> <span class="ident">PcK</span>      <span class="op">||</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span> <span class="op">|</span>  <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">|</span><span class="ident">Session</span> <span class="ident">PK</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                     <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">|</span><span class="ident">client_sent_nonce</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">server_recv_nonce</span><span class="op">||</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>            <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>    <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                                       <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>               <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>               <span class="op">|</span>  <span class="ident">new</span> <span class="ident">nonce</span>() <span class="op">|</span>        <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>               <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>                       <span class="op">|</span>               <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>               <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>                       <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="ident">Nonce</span>      <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>                               <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>                               <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>       <span class="op">|</span><span class="ident">Payload</span>           <span class="op">+</span><span class="op">+</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">|</span> <span class="op">|</span>       <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">Session</span> <span class="ident">PK</span>        <span class="op">||</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>   <span class="op">|</span>       <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">server_sent_nonce</span> <span class="op">||</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>           <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">|</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>           <span class="op">|</span>                <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>           <span class="op">|</span>                <span class="op">|</span>              <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>           <span class="op">|</span>       <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">|</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-&gt;</span><span class="ident">seal_precomputed</span>()&lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                            <span class="op">|</span>                  <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="ident">v</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>        <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">|</span><span class="ident">Encrypted</span> <span class="ident">Payload</span> <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>    <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>    <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                                          <span class="op">|</span>    <span class="op">|</span>                   <span class="op">|</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>    <span class="op">|</span>                   <span class="op">|</span>
<span class="op">|</span> <span class="ident">Packet</span> &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span><span class="ident">Packet</span>            <span class="op">|</span>   <span class="op">|</span>    <span class="op">|</span>                   <span class="op">|</span>
<span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span> <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>    <span class="op">|</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">|</span><span class="ident">Nonce</span>             &lt;-<span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                   <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>   <span class="op">|</span>                        <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">|</span><span class="ident">Encrypted</span> <span class="ident">Payload</span> &lt;-<span class="op">-</span><span class="op">-</span><span class="op">+</span>                        <span class="op">|</span>
           <span class="op">||</span>                   <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span>                            <span class="op">|</span>
           <span class="op">||</span>                                                                   <span class="op">|</span>
           <span class="op">||</span>                                                                   <span class="op">|</span>
           <span class="op">+</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">-</span><span class="op">+</span></pre>

<h3 id='handshake-request' class='section-header'><a href='#handshake-request'>7.2.2 Handshake Request</a></h3>
<p>The first 32 bytes in the request are the DHT Public Key that the TCP client is
announcing itself with to the server. The next 24 bytes are a nonce which the
TCP client uses along with the Secret Key associated with the public key in the
first 32 bytes of the packet to encrypt the rest of this packet.</p>

<p>The encrypted payload contains a Temporary Public Key that will be used for
encryption during the connection and will be discarded after. It also contains
a Client Base Nonce which will be used later for encrypting packets sent to the
TCP server.</p>

<p>To establish a secure connection with a TCP server client sends the following
128 bytes of <code>Handshake Packet</code> to the server:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">DHT Public Key of client</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce for the encrypted payload</td>
</tr>
<tr>
<td style="text-align: left"><code>72</code></td>
<td style="text-align: left">Payload (plus MAC)</td>
</tr>
</tbody>
</table>

<h4 id='handshake-request-packet-payload' class='section-header'><a href='#handshake-request-packet-payload'>7.2.2.1 Handshake Request Packet Payload</a></h4>
<p>Payload is encrypted with the DHT Private Key of the client and Public Key of
the server and the nonce and contains:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Temporary Public Key</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Client Base Nonce</td>
</tr>
</tbody>
</table>

<p>The Client Base Nonce is a random nonce that TCP client wants the TCP server to
use to decrypt the packets sent to the TCP server.</p>

<h3 id='handshake-response' class='section-header'><a href='#handshake-response'>7.2.3 Handshake Response</a></h3>
<p>If the server successfully decrypts the encrypted payload from the Handshake
Packet, it responds with the following <code>Handshake Response</code> of length 96 bytes:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce for the encrypted payload</td>
</tr>
<tr>
<td style="text-align: left"><code>72</code></td>
<td style="text-align: left">Payload (plus MAC)</td>
</tr>
</tbody>
</table>

<p>The client already knows the long term Public Key of the server so it is
omitted in the Handshake Response, thus only a nonce is present in the
unencrypted part. The encrypted payload of the response has the same elements
as the encrypted payload of the Handshake Request: a temporary Public Key tied
to this connection and a Server Base Nonce which will be used later when
decrypting packets received from the TCP server, both unique for the
connection.</p>

<h4 id='handshake-response-payload' class='section-header'><a href='#handshake-response-payload'>7.2.3.1 Handshake Response Payload</a></h4>
<p>Payload is encrypted with the private key of the server and the DHT public key
of the client and the nonce and contains:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Server Base Nonce</td>
</tr>
</tbody>
</table>

<p>The Server Base Nonce is a random nonce that the TCP server wants the TCP
client to use to decrypt the packets sent to the TCP client.</p>

<h2 id='after-handshake' class='section-header'><a href='#after-handshake'>7.3 After Handshake</a></h2>
<p>Now client will know the server&#39;s temporary Public Key and Server Base Nonce
for the connection and the server will know the Client Base Nonce and temporary
Public Key for the connection.</p>

<p>The client will then send an encrypted packet to the server. The first packet
must be any valid encrypted data packet that server has to respond to, e.g. if
client would send <a href="#ping-request-0x04">Ping Request (0x04)</a> server needs to
respond with Ping Response.</p>

<p>First packet sent by client and response from server are used to check whether
client can correctly encrypt sent packet and correctly decrypt received
response.</p>

<p>It matters also to server, since a correctly encrypted by client request
signifies that it really came from client and is not from an attacker replying
packets.</p>

<p>The server must prevent resource consuming attacks by timing out clients if
they do not send any encrypted packets to the server in order to prove to the
server that the connection was established correctly.</p>

<p>Toxcore does not have a timeout for clients, instead it stores connecting
clients in large circular lists and times them out if their entry in the list
gets replaced by a newer connection. The reasoning behind this is that it
prevents TCP flood attacks from having a negative impact on the currently
connected nodes. There are however much better ways to do this and the only
reason toxcore does it this way is because writing it was very simple. When
connections are confirmed they are moved somewhere else.</p>

<p>When the server confirms the connection it must look in the list of connected
peers to see if it is already connected to a client with the same announced
Public Key. If this is the case the server must kill the previous connection
because this means that the client previously timed out and is reconnecting.
Because of Toxcore design it is very unlikely for two different peers to have
the same Public Key.</p>

<h2 id='encrypted-data-packet' class='section-header'><a href='#encrypted-data-packet'>7.4 Encrypted data packet</a></h2>
<p>Encrypted data packets look like this to outsiders:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> length of data</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">encrypted data</td>
</tr>
</tbody>
</table>

<p>In a TCP stream they would look like:
<code>[[length][data]][[length][data]][[length][data]]...</code>.</p>

<h3 id='encrypted-data-packet-keys' class='section-header'><a href='#encrypted-data-packet-keys'>7.4.1 Encrypted data packet keys</a></h3>
<p>Both the client and server use the temporary Public and Secret connection keys
which are each generated for the connection and then Public Key part is sent to
the other in the <a href="#tcp-handshake">handshake</a>. They are then used like the
diagram shows to generate a <a href="#combined-key">Combined Key</a> which is equal on
both sides:</p>

<pre class="rust rust-example-rendered">
<span class="ident">Client</span>:                                     <span class="ident">Server</span>:
<span class="ident">generate_shared_key</span>(                        <span class="ident">generate_shared_key</span>(
[<span class="ident">temp</span> <span class="ident">connection</span> <span class="ident">Public</span> <span class="ident">Key</span> <span class="ident">of</span> <span class="ident">server</span>],     [<span class="ident">temp</span> <span class="ident">connection</span> <span class="ident">Public</span> <span class="ident">Key</span> <span class="ident">of</span> <span class="ident">client</span>],
[<span class="ident">temp</span> <span class="ident">connection</span> <span class="ident">Secret</span> <span class="ident">Key</span> <span class="ident">of</span> <span class="ident">client</span>])     [<span class="ident">temp</span> <span class="ident">connection</span> <span class="ident">Secret</span> <span class="ident">Key</span> <span class="ident">of</span> <span class="ident">server</span>])
<span class="op">=</span>                                           <span class="op">=</span>
[<span class="ident">Combined</span> <span class="ident">Key</span>]                                [<span class="ident">Combined</span> <span class="ident">key</span>]</pre>

<p>The generated Combined Key is equal on both sides and is used to encrypt and
decrypt the encrypted data packets.</p>

<h3 id='encrypted-data-packet-nonces' class='section-header'><a href='#encrypted-data-packet-nonces'>7.4.2 Encrypted data packet nonces</a></h3>
<h4 id='encrypted-data-packets-from-server' class='section-header'><a href='#encrypted-data-packets-from-server'>7.4.2.1 Encrypted data packets from server</a></h4>
<p>Each encrypted data packet sent to the client will be encrypted with the
Combined Key and with the Server Base Nonce incremented by the number of
packets sent: <code>Server Base Nonce + number of packets sent</code>.</p>

<p>Number of packets sent starts at <code>0</code> for the first packet that uses the Server
Base Nonce. Second packet would use <code>Server Base Nonce + 1</code>, and so on.</p>

<h4 id='encrypted-data-packets-from-client' class='section-header'><a href='#encrypted-data-packets-from-client'>7.4.2.2 Encrypted data packets from client</a></h4>
<p>Each packet sent to server from the client will be encrypted with the Combined
Key and with Client Base Nonce incremented by number of packets sent:
<code>Client Base Nonce + number of packets sent</code>.</p>

<p>Number of packets sent starts at <code>0</code> for the first packet that uses the Client
Base Nonce. Second packet would use <code>Client Base Nonce + 1</code>, and so on.</p>

<h3 id='encrypted-data-packet-size' class='section-header'><a href='#encrypted-data-packet-size'>7.4.3 Encrypted data packet size</a></h3>
<p>Encrypted data packets have a hard maximum size of <code>2 + 2048</code> bytes in the
toxcore TCP server implementation.</p>

<p><code>2</code> bytes inform about number of bytes that following data packet has.</p>

<p><code>2048</code> bytes is enough to make sure that all toxcore packets can go through and
leaves some extra space just in case the protocol needs to be changed in the
future.</p>

<p>In current toxcore, the largest encrypted data packets sent will be of size <code>2 + 1417</code> which is <code>1419</code> total.</p>

<h3 id='encrypted-data-packet-rationale' class='section-header'><a href='#encrypted-data-packet-rationale'>7.4.4 Encrypted data packet rationale</a></h3>
<p>The logic behind the format of the encrypted packets is that:</p>

<ol>
<li><p>TCP is a stream protocol, we need packets.</p></li>
<li><p>Any attacks must be prevented</p></li>
</ol>

<p>How it accomplishes each of those points:</p>

<ol>
<li><p><code>2</code> bytes before each packet of encrypted data denote the length. We assume
a functioning TCP will deliver bytes in order. If the TCP doesn&#39;t work
correctly it most likely means that it is under attack and for that see the
next point.</p></li>
<li><p>The following attacks are prevented:</p>

<ul>
<li><p>Modifying the length bytes will either make the connection time out
and/or decryption fail.</p></li>
<li><p>Modifying any encrypted bytes will make decryption fail.</p></li>
<li><p>Injecting any bytes will make decryption fail.</p></li>
<li><p>Trying to re order the packets will make decryption fail because of the
ordered nonce.</p></li>
<li><p>Removing any packets from the stream will make decryption fail because
of the ordered nonce.</p></li>
</ul></li>
</ol>

<h2 id='encrypted-payload-types' class='section-header'><a href='#encrypted-payload-types'>7.5 Encrypted payload types</a></h2>
<p>The following represents the various types of data that can be sent inside
encrypted data packets.</p>

<h3 id='routing-request-0x00' class='section-header'><a href='#routing-request-0x00'>7.5.1 Routing request (0x00)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x00)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key</td>
</tr>
</tbody>
</table>

<h3 id='routing-request-response-0x01' class='section-header'><a href='#routing-request-response-0x01'>7.5.2 Routing request response (0x01)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x01)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> <code>rpid</code></td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key</td>
</tr>
</tbody>
</table>

<p><code>rpid</code> is invalid <code>connection_id</code> (0) if refused, <code>connection_id</code> if accepted.</p>

<h3 id='connect-notification-0x02' class='section-header'><a href='#connect-notification-0x02'>7.5.3 Connect notification (0x02)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x02)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> <code>connection_id</code> of connection that got connected</td>
</tr>
</tbody>
</table>

<h3 id='disconnect-notification-0x03' class='section-header'><a href='#disconnect-notification-0x03'>7.5.4 Disconnect notification (0x03)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x03)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> <code>connection_id</code> of connection that got disconnected</td>
</tr>
</tbody>
</table>

<h3 id='ping-request-0x04' class='section-header'><a href='#ping-request-0x04'>7.5.5 Ping request (0x04)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x04)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> <code>ping_id</code> (0 is invalid)</td>
</tr>
</tbody>
</table>

<h3 id='ping-response-pong-0x05' class='section-header'><a href='#ping-response-pong-0x05'>7.5.6 Ping response (pong) (0x05)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x05)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> <code>ping_id</code> (0 is invalid)</td>
</tr>
</tbody>
</table>

<h3 id='oob-send-0x06' class='section-header'><a href='#oob-send-0x06'>7.5.7 OOB send (0x06)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x06)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Destination public key</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Data</td>
</tr>
</tbody>
</table>

<h3 id='oob-recv-0x07' class='section-header'><a href='#oob-recv-0x07'>7.5.8 OOB recv (0x07)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x07)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Sender public key</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Data</td>
</tr>
</tbody>
</table>

<h3 id='onion-packet-0x08' class='section-header'><a href='#onion-packet-0x08'>7.5.9 Onion packet (0x08)</a></h3>
<p>Same format as initial onion packet but packet id is 0x08 instead of 0x80.</p>

<h3 id='onion-packet-response-0x09' class='section-header'><a href='#onion-packet-response-0x09'>7.5.10 Onion packet response (0x09)</a></h3>
<p>Same format as onion packet but packet id is 0x09 instead of 0x8e.</p>

<h3 id='data-0x10-and-up' class='section-header'><a href='#data-0x10-and-up'>7.5.11 Data (0x10 and up)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> packet id</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> connection id</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">data</td>
</tr>
</tbody>
</table>

<p>The TCP server is set up in a way to minimize waste while relaying the many
packets that might go between two tox peers hence clients must create
connections to other clients on the relay. The connection number is a <code>uint8_t</code>
and must be equal or greater to 16 in order to be valid. Because a <code>uint8_t</code>
has a maximum value of 256 it means that the maximum number of different
connections to other clients that each connection can have is 240. The reason
valid <code>connection_ids</code> are bigger than 16 is because they are the first byte of
data packets. Currently only number 0 to 9 are taken however we keep a few
extras in case we need to extend the protocol without breaking it completely.</p>

<p>Routing request (Sent by client to server): Send a routing request to the
server that we want to connect to peer with public key where the public key is
the public the peer announced themselves as. The server must respond to this
with a Routing response.</p>

<p>Routing response (Sent by server to client): The response to the routing
request, tell the client if the routing request succeeded (valid
<code>connection_id</code>) and if it did, tell them the id of the connection
(<code>connection_id</code>). The public key sent in the routing request is also sent in
the response so that the client can send many requests at the same time to the
server without having code to track which response belongs to which public key.</p>

<p>The only reason a routing request should fail is if the connection has reached
the maximum number of simultaneous connections. In case the routing request
fails the public key in the response will be the public key in the failed
request.</p>

<p>Connect notification (Sent by server to client): Tell the client that
<code>connection_id</code> is now connected meaning the other is online and data can be
sent using this <code>connection_id</code>.</p>

<p>Disconnect notification (Sent by client to server): Sent when client wants the
server to forget about the connection related to the <code>connection_id</code> in the
notification. Server must remove this connection and must be able to reuse the
<code>connection_id</code> for another connection. If the connection was connected the
server must send a disconnect notification to the other client. The other
client must think that this client has simply disconnected from the TCP server.</p>

<p>Disconnect notification (Sent by server to client): Sent by the server to the
client to tell them that the connection with <code>connection_id</code> that was connected
is now disconnected. It is sent either when the other client of the connection
disconnect or when they tell the server to kill the connection (see above).</p>

<p>Ping and Pong packets (can be sent by both client and server, both will
respond): ping packets are used to know if the other side of the connection is
still live. TCP when established doesn&#39;t have any sane timeouts (1 week isn&#39;t
sane) so we are obliged to have our own way to check if the other side is still
live. Ping ids can be anything except 0, this is because of how toxcore sets
the variable storing the <code>ping_id</code> that was sent to 0 when it receives a pong
response which means 0 is invalid.</p>

<p>The server should send ping packets every X seconds (toxcore <code>TCP_server</code> sends
them every 30 seconds and times out the peer if it doesn&#39;t get a response in
10). The server should respond immediately to ping packets with pong packets.</p>

<p>The server should respond to ping packets with pong packets with the same
<code>ping_id</code> as was in the ping packet. The server should check that each pong
packet contains the same <code>ping_id</code> as was in the ping, if not the pong packet
must be ignored.</p>

<p>OOB send (Sent by client to server): If a peer with private key equal to the
key they announced themselves with is connected, the data in the OOB send
packet will be sent to that peer as an OOB recv packet. If no such peer is
connected, the packet is discarded. The toxcore <code>TCP_server</code> implementation has
a hard maximum OOB data length of 1024. 1024 was picked because it is big
enough for the <code>net_crypto</code> packets related to the handshake and is large
enough that any changes to the protocol would not require breaking TCP server.
It is however not large enough for the biggest <code>net_crypto</code> packets sent with
an established <code>net_crypto</code> connection to prevent sending those via OOB
packets.</p>

<p>OOB recv (Sent by server to client): OOB recv are sent with the announced
public key of the peer that sent the OOB send packet and the exact data.</p>

<p>OOB packets can be used just like normal data packets however the extra size
makes sending data only through them less efficient than data packets.</p>

<p>Data: Data packets can only be sent and received if the corresponding
<code>connection_id</code> is connection (a Connect notification has been received from
it) if the server receives a Data packet for a non connected or existent
connection it will discard it.</p>

<p>Why did I use different packet ids for all packets when some are only sent by
the client and some only by the server? It&#39;s less confusing.</p>

<h1 id='tcp-client' class='section-header'><a href='#tcp-client'>8 TCP client</a></h1>
<p><code>TCP client</code> is the client for the TCP server. It establishes and keeps a
connection to the TCP server open.</p>

<p>All the packet formats are explained in detail in <code>TCP server</code> so this section
will only cover <code>TCP client</code> specific details which are not covered in the
<code>TCP server</code> documentation.</p>

<p>TCP clients can choose to connect to TCP servers through a proxy. Most common
types of proxies (SOCKS, HTTP) work by establishing a connection through a
proxy using the protocol of that specific type of proxy. After the connection
through that proxy to a TCP server is established, the socket behaves from the
point of view of the application exactly like a TCP socket that connects
directly to a TCP server instance. This means supporting proxies is easy.</p>

<p><code>TCP client</code> first establishes a TCP connection, either through a proxy or
directly to a TCP server. It uses the DHT public key as its long term key when
connecting to the TCP server.</p>

<p>It establishes a secure connection to the TCP server. After establishing a
connection to the TCP server, and when the handshake response has been received
from the TCP server, the toxcore implementation immediately sends a ping
packet. Ideally the first packets sent would be routing request packets but
this solution aids code simplicity and allows the server to confirm the
connection.</p>

<p>Ping packets, like all other data packets, are sent as encrypted packets.</p>

<p>Ping packets are sent by the toxcore TCP client every 30 seconds with a timeout
of 10 seconds, the same interval and timeout as toxcore TCP server ping
packets. They are the same because they accomplish the same thing.</p>

<p><code>TCP client</code> must have a mechanism to make sure important packets (routing
requests, disconnection notifications, ping packets, ping response packets)
don&#39;t get dropped because the TCP socket is full. Should this happen, the TCP
client must save these packets and prioritize sending them, in order, when the
TCP socket on the server becomes available for writing again. <code>TCP client</code> must
also take into account that packets might be bigger than the number of bytes it
can currently write to the socket. In this case, it must save the bytes of the
packet that it didn&#39;t write to the socket and write them to the socket as soon
as the socket allows so that the connection does not get broken. It must also
assume that it may receive only part of an encrypted packet. If this occurs it
must save the part of the packet it has received and wait for the rest of the
packet to arrive before handling it.</p>

<p><code>TCP client</code> can be used to open up a route to friends who are connected to the
TCP server. This is done by sending a routing request to the TCP server with
the DHT public key of the friend. This tells the server to register a
<code>connection_id</code> to the DHT public key sent in the packet. The server will then
respond with a routing response packet. If the connection was accepted, the
<code>TCP client</code> will store the <code>connection id</code> for this connection. The
<code>TCP client</code> will make sure that routing response packets are responses to a
routing packet that it sent by storing that it sent a routing packet to that
public key and checking the response against it. This prevents the possibility
of a bad TCP server exploiting the client.</p>

<p>The <code>TCP client</code> will handle connection notifications and disconnection
notifications by alerting the module using it that the connection to the peer
is up or down.</p>

<p><code>TCP client</code> will send a disconnection notification to kill a connection to a
friend. It must send a disconnection notification packet regardless of whether
the peer was online or offline so that the TCP server will unregister the
connection.</p>

<p>Data to friends can be sent through the TCP relay using OOB (out of band)
packets and connected connections. To send an OOB packet, the DHT public key of
the friend must be known. OOB packets are sent in blind and there is no way to
query the TCP relay to see if the friend is connected before sending one. OOB
packets should be sent when the connection to the friend via the TCP relay
isn&#39;t in an connected state but it is known that the friend is connected to
that relay. If the friend is connected via the TCP relay, then normal data
packets must be sent as they are smaller than OOB packets.</p>

<p>OOB recv and data packets must be handled and passed to the module using it.</p>

<h1 id='tcp-connections' class='section-header'><a href='#tcp-connections'>9 TCP connections</a></h1>
<p><code>TCP_connections</code> takes care of handling multiple TCP client instances to
establish a reliable connection via TCP relays to a friend. Connecting to a
friend with only one relay would not be very reliable, so <code>TCP_connections</code>
provides the level of abstraction needed to manage multiple relays. For
example, it ensures that if a relay goes down, the connection to the peer will
not be impacted. This is done by connecting to the other peer with more than
one relay.</p>

<p><code>TCP_connections</code> is above <a href="#tcp-client"><code>TCP client</code></a> and below <code>net_crypto</code>.</p>

<p>A TCP connection in <code>TCP_connections</code> is defined as a connection to a peer
though one or more TCP relays. To connect to another peer with
<code>TCP_connections</code>, a connection in <code>TCP_connections</code> to the peer with DHT
public key X will be created. Some TCP relays which we know the peer is
connected to will then be associated with that peer. If the peer isn&#39;t
connected directly yet, these relays will be the ones that the peer has sent to
us via the onion module. The peer will also send some relays it is directly
connected to once a connection is established, however, this is done by another
module.</p>

<p><code>TCP_connections</code> has a list of all relays it is connected to. It tries to keep
the number of relays it is connected to as small as possible in order to
minimize load on relays and lower bandwidth usage for the client. The desired
number of TCP relay connections per peer is set to 3 in toxcore with the
maximum number set to 6. The reason for these numbers is that 1 would mean no
backup relays and 2 would mean only 1 backup. To be sure that the connection is
reliable 3 seems to be a reasonable lower bound. The maximum number of 6 is the
maximum number of relays that can be tied to each peer. If 2 peers are
connected each to the same 6+ relays and they both need to be connected to that
amount of relays because of other friends this is where this maximum comes into
play. There is no reason why this number is 6 but in toxcore it has to be at
least double than the desired number (3) because the code assumes this.</p>

<p>If necessary, <code>TCP_connections</code> will connect to TCP relays to use them to send
onion packets. This is only done if there is no UDP connection to the network.
When there is a UDP connection, packets are sent with UDP only because sending
them with TCP relays can be less reliable. It is also important that we are
connected at all times to some relays as these relays will be used by TCP only
peers to initiate a connection to us.</p>

<p>In toxcore, each client is connected to 3 relays even if there are no TCP peers
and the onion is not needed. It might be optimal to only connect to these
relays when toxcore is initializing as this is the only time when peers will
connect to us via TCP relays we are connected to. Due to how the onion works,
after the initialization phase, where each peer is searched in the onion and
then if they are found the info required to connect back (DHT pk, TCP relays)
is sent to them, there should be no more peers connecting to us via TCP relays.
This may be a way to further reduce load on TCP relays, however, more research
is needed before it is implemented.</p>

<p><code>TCP_connections</code> picks one relay and uses only it for sending data to the
other peer. The reason for not picking a random connected relay for each packet
is that it severely deteriorates the quality of the link between two peers and
makes performance of lossy video and audio transmissions really poor. For this
reason, one relay is picked and used to send all data. If for any reason no
more data can be sent through that relay, the next relay is used. This may
happen if the TCP socket is full and so the relay should not necessarily be
dropped if this occurs. Relays are only dropped if they time out or if they
become useless (if the relay is one too many or is no longer being used to
relay data to any peers).</p>

<p><code>TCP_connections</code> in toxcore also contains a mechanism to make connections go
to sleep. TCP connections to other peers may be put to sleep if the connection
to the peer establishes itself with UDP after the connection is established
with TCP. UDP is the method preferred by <code>net_crypto</code> to communicate with other
peers. In order to keep track of the relays which were used to connect with the
other peer in case the UDP connection fails, they are saved by
<code>TCP_connections</code> when the connection is put to sleep. Any relays which were
only used by this redundant connection are saved then disconnected from. If the
connection is awakened, the relays are reconnected to and the connection is
reestablished. Putting a connection to sleep is the same as saving all the
relays used by the connection and removing the connection. Awakening the
connection is the same as creating a new connection with the same parameters
and restoring all the relays.</p>

<p>A method to detect potentially dysfunctional relays that try to disrupt the
network by lying that they are connecting to a peer when they are not or that
maliciously drop all packets should be considered. Toxcore doesn&#39;t currently
implement such a system and adding one requires more research and likely also
requires extending the protocol.</p>

<p>When TCP connections connects to a relay it will create a new
<a href="#tcp-client"><code>TCP_client</code></a> instance for that relay. At any time if the
<code>TCP_client</code> instance reports that it has disconnected, the TCP relay will be
dropped. Once the TCP relay reports that it is connected, <code>TCP_connections</code>
will find all the connections that are associated to the relay and announce to
the relay that it wants to connect to each of them with routing requests. If
the relay reports that the peer for a connection is online, the connection
number and relay will be used to send data in that connection with data
packets. If the peer isn&#39;t reported as online but the relay is associated to a
connection, TCP OOB (out of band) packets will be used to send data instead of
data packets. TCP OOB packets are used in this case since the relay most likely
has the peer connected but it has not sent a routing request to connect to us.</p>

<p><code>TCP_connections</code> is used as the bridge between individual <code>TCP_client</code>
instances and <code>net_crypto</code>, or the bridge between individual connections and
something that requires an interface that looks like one connection.</p>

<h1 id='net-crypto' class='section-header'><a href='#net-crypto'>10 Net crypto</a></h1>
<p>The Tox transport protocol is what Tox uses to establish and send data securely
to friends and provides encryption, ordered delivery, and perfect forward
secrecy. It is a UDP protocol but it is also used when 2 friends connect over
TCP relays.</p>

<p>The reason the protocol for connections to friends over TCP relays and direct
UDP is the same is for simplicity and so the connection can switch between both
without the peers needing to disconnect and reconnect. For example two Tox
friends might first connect over TCP and a few seconds later switch to UDP when
a direct UDP connection becomes possible. The opening up of the UDP route or
&#39;hole-punching&#39; is done by the DHT module and the opening up of a relayed TCP
connection is done by the <code>TCP_connection</code> module. The Tox transport protocol
has the job of connecting two peers (tox friends) safely once a route or
communications link between both is found. Direct UDP is preferred over TCP
because it is direct and isn&#39;t limited by possibly congested TCP relays. Also,
a peer can only connect to another using the Tox transport protocol if they
know the real public key and DHT public key of the peer they want to connect
to. However, both the DHT and TCP connection modules require this information
in order to find and open the route to the peer which means we assume this
information is known by toxcore and has been passed to <code>net_crypto</code> when the
<code>net_crypto</code> connection was created.</p>

<p>Because this protocol has to work over UDP it must account for possible packet
loss, packets arriving in the wrong order and has to implement some kind of
congestion control. This is implemented above the level at which the packets
are encrypted. This prevents a malicious TCP relay from disrupting the
connection by modifying the packets that go through it. The packet loss
prevention makes it work very well on TCP relays that we assume may go down at
any time as the connection will stay strong even if there is need to switch to
another TCP relay which will cause some packet loss.</p>

<p>Before sending the actual handshake packet the peer must obtain a cookie. This
cookie step serves as a way for the receiving peer to confirm that the peer
initiating the connection can receive the responses in order to prevent certain
types of DoS attacks.</p>

<p>The peer receiving a cookie request packet must not allocate any resources to
the connection. They will simply respond to the packet with a cookie response
packet containing the cookie that the requesting peer must then use in the
handshake to initiate the actual connection.</p>

<p>The cookie response must be sent back using the exact same link the cookie
request packet was sent from. The reason for this is that if it is sent back
using another link, the other link might not work and the peer will not be
expecting responses from another link. For example, if a request is sent from
UDP with ip port X, it must be sent back by UDP to ip port X. If it was
received from a TCP OOB packet it must be sent back by a TCP OOB packet via the
same relay with the destination being the peer who sent the request. If it was
received from an established TCP relay connection it must be sent back via that
same exact connection.</p>

<p>When a cookie request is received, the peer must not use the information in the
request packet for anything, he must not store it, he must only create a cookie
and cookie response from it, then send the created cookie response packet and
forget them. The reason for this is to prevent possible attacks. For example if
a peer would allocate long term memory for each cookie request packet received
then a simple packet flood would be enough to achieve an effective denial of
service attack by making the program run out of memory.</p>

<p>cookie request packet (145 bytes):</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> <span class="number">24</span>]
[<span class="ident">Sender</span><span class="lifetime">&#39;s</span> <span class="ident">DHT</span> <span class="ident">Public</span> <span class="ident">key</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
[<span class="ident">Random</span> <span class="ident">nonce</span> (<span class="number">24</span> <span class="ident">bytes</span>)]
[<span class="ident">Encrypted</span> <span class="ident">message</span> <span class="ident">containing</span>:
    [<span class="ident">Sender</span><span class="lifetime">&#39;s</span> <span class="ident">real</span> <span class="ident">public</span> <span class="ident">key</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
    [<span class="ident">padding</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
    [<span class="ident">uint64_t</span> <span class="ident">echo</span> <span class="ident">id</span> (<span class="ident">must</span> <span class="ident">be</span> <span class="ident">sent</span> <span class="ident">back</span> <span class="ident">untouched</span> <span class="kw">in</span> <span class="ident">cookie</span> <span class="ident">response</span>)]
]</pre>

<p>Encrypted message is encrypted with sender&#39;s DHT private key, receiver&#39;s DHT
public key and the nonce.</p>

<p>The packet id for cookie request packets is 24. The request contains the DHT
public key of the sender which is the key used (The DHT private key) (along
with the DHT public key of the receiver) to encrypt the encrypted part of the
cookie packet and a nonce also used to encrypt the encrypted part of the
packet. Padding is used to maintain backwards-compatibility with previous
versions of the protocol. The echo id in the cookie request must be sent back
untouched in the cookie response. This echo id is how the peer sending the
request can be sure that the response received was a response to the packet
that he sent.</p>

<p>The reason for sending the DHT public key and real public key in the cookie
request is that both are contained in the cookie sent back in the response.</p>

<p>Toxcore currently sends 1 cookie request packet every second 8 times before it
kills the connection if there are no responses.</p>

<p>cookie response packet (161 bytes):</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> <span class="number">25</span>]
[<span class="ident">Random</span> <span class="ident">nonce</span> (<span class="number">24</span> <span class="ident">bytes</span>)]
[<span class="ident">Encrypted</span> <span class="ident">message</span> <span class="ident">containing</span>:
    [<span class="ident">Cookie</span>]
    [<span class="ident">uint64_t</span> <span class="ident">echo</span> <span class="ident">id</span> (<span class="ident">that</span> <span class="ident">was</span> <span class="ident">sent</span> <span class="kw">in</span> <span class="ident">the</span> <span class="ident">request</span>)]
]</pre>

<p>Encrypted message is encrypted with the exact same symmetric key as the cookie
request packet it responds to but with a different nonce.</p>

<p>The packet id for cookie request packets is 25. The response contains a nonce
and an encrypted part encrypted with the nonce. The encrypted part is encrypted
with the same key used to decrypt the encrypted part of the request meaning the
expensive shared key generation needs to be called only once in order to handle
and respond to a cookie request packet with a cookie response.</p>

<p>The Cookie (see below) and the echo id that was sent in the request are the
contents of the encrypted part.</p>

<p>The Cookie should be (112 bytes):</p>

<pre class="rust rust-example-rendered">
[<span class="ident">nonce</span>]
[<span class="ident">encrypted</span> <span class="ident">data</span>:
    [<span class="ident">uint64_t</span> <span class="ident">time</span>]
    [<span class="ident">Sender</span><span class="lifetime">&#39;s</span> <span class="ident">real</span> <span class="ident">public</span> <span class="ident">key</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
    [<span class="ident">Sender</span><span class="lifetime">&#39;s</span> <span class="ident">DHT</span> <span class="ident">public</span> <span class="ident">key</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
]</pre>

<p>The cookie is a 112 byte piece of data that is created and sent to the
requester as part of the cookie response packet. A peer who wants to connect to
another must obtain a cookie packet from the peer they are trying to connect
to. The only way to send a valid handshake packet to another peer is to first
obtain a cookie from them.</p>

<p>The cookie contains information that will both prove to the receiver of the
handshake that the peer has received a cookie response and contains encrypted
info that tell the receiver of the handshake packet enough info to both decrypt
and validate the handshake packet and accept the connection.</p>

<p>When toxcore is started it generates a symmetric encryption key that it uses to
encrypt and decrypt all cookie packets (using NaCl authenticated encryption
exactly like encryption everywhere else in toxcore). Only the instance of
toxcore that create the packets knows the encryption key meaning any cookie it
successfully decrypts and validates were created by it.</p>

<p>The time variable in the cookie is used to prevent cookie packets that are too
old from being used. Toxcore has a time out of 15 seconds for cookie packets.
If a cookie packet is used more than 15 seconds after it is created toxcore
will see it as invalid.</p>

<p>When responding to a cookie request packet the sender&#39;s real public key is the
known key sent by the peer in the encrypted part of the cookie request packet
and the senders DHT public key is the key used to encrypt the encrypted part of
the cookie request packet.</p>

<p>When generating a cookie to put inside the encrypted part of the handshake: One
of the requirements to connect successfully to someone else is that we know
their DHT public key and their real long term public key meaning there is
enough information to construct the cookie.</p>

<p>Handshake packet:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> <span class="number">26</span>]
[<span class="ident">Cookie</span>]
[<span class="ident">nonce</span> (<span class="number">24</span> <span class="ident">bytes</span>)]
[<span class="ident">Encrypted</span> <span class="ident">message</span> <span class="ident">containing</span>:
    [<span class="number">24</span> <span class="ident">bytes</span> <span class="ident">base</span> <span class="ident">nonce</span>]
    [<span class="ident">session</span> <span class="ident">public</span> <span class="ident">key</span> <span class="ident">of</span> <span class="ident">the</span> <span class="ident">peer</span> (<span class="number">32</span> <span class="ident">bytes</span>)]
    [<span class="ident">sha512</span> <span class="ident">hash</span> <span class="ident">of</span> <span class="ident">the</span> <span class="ident">entire</span> <span class="ident">Cookie</span> <span class="ident">sitting</span> <span class="ident">outside</span> <span class="ident">the</span> <span class="ident">encrypted</span> <span class="ident">part</span>]
    [<span class="ident">Other</span> <span class="ident">Cookie</span> (<span class="ident">used</span> <span class="ident">by</span> <span class="ident">the</span> <span class="ident">other</span> <span class="ident">to</span> <span class="ident">respond</span> <span class="ident">to</span> <span class="ident">the</span> <span class="ident">handshake</span> <span class="ident">packet</span>)]
]</pre>

<p>The packet id for handshake packets is 26. The cookie is a cookie obtained by
sending a cookie request packet to the peer and getting a cookie response
packet with a cookie in it. It may also be obtained in the handshake packet by
a peer receiving a handshake packet (Other Cookie).</p>

<p>The nonce is a nonce used to encrypt the encrypted part of the handshake
packet. The encrypted part of the handshake packet is encrypted with the long
term keys of both peers. This is to prevent impersonation.</p>

<p>Inside the encrypted part of the handshake packet there is a &#39;base nonce&#39; and a
session public key. The &#39;base nonce&#39; is a nonce that the other should use to
encrypt each data packet, adding + 1 to it for each data packet sent. (first
packet is &#39;base nonce&#39; + 0, next is &#39;base nonce&#39; + 1, etc. Note that for
mathematical operations the nonce is considered to be a 24 byte number in big
endian format). The session key is the temporary connection public key that the
peer has generated for this connection and it sending to the other. This
session key is used so that the connection has perfect forward secrecy. It is
important to save the private key counterpart of the session public key sent in
the handshake, the public key received by the other and both the received and
sent base nonces as they are used to encrypt/decrypt the data packets.</p>

<p>The hash of the cookie in the encrypted part is used to make sure that an
attacker has not taken an older valid handshake packet and then replaced the
cookie packet inside with a newer one which would be bad as they could replay
it and might be able to make a mess.</p>

<p>The &#39;Other Cookie&#39; is a valid cookie that we put in the handshake so that the
other can respond with a valid handshake without having to make a cookie
request to obtain one.</p>

<p>The handshake packet is sent by both sides of the connection. If a peer
receives a handshake it will check if the cookie is valid, if the encrypted
section decrypts and validates, if the cookie hash is valid, if long term
public key belongs to a known friend. If all these are true then the connection
is considered &#39;Accepted&#39; but not &#39;Confirmed&#39;.</p>

<p>If there is no existing connection to the peer identified by the long term
public key to set to &#39;Accepted&#39;, one will be created with that status. If a
connection to such peer with a not yet &#39;Accepted&#39; status to exists, this
connection is set to accepted. If a connection with a &#39;Confirmed&#39; status exists
for this peer, the handshake packet will be ignored and discarded (The reason
for discarding it is that we do not want slightly late handshake packets to
kill the connection) except if the DHT public key in the cookie contained in
the handshake packet is different from the known DHT public key of the peer. If
this happens the connection will be immediately killed because it means it is
no longer valid and a new connection will be created immediately with the
&#39;Accepted&#39; status.</p>

<p>Sometimes toxcore might receive the DHT public key of the peer first with a
handshake packet so it is important that this case is handled and that the
implementation passes the DHT public key to the other modules (<a href="#dht">DHT</a>,
<a href="#tcp-connections"><code>TCP_connection</code></a> because this does happen.</p>

<p>Handshake packets must be created only once during the connection but must be
sent in intervals until we are sure the other received them. This happens when
a valid encrypted data packet is received and decrypted.</p>

<p>The states of a connection:</p>

<ol>
<li><p>Not accepted: Send handshake packets.</p></li>
<li><p>Accepted: A handshake packet has been received from the other peer but no
encrypted packets: continue (or start) sending handshake packets because
the peer can&#39;t know if the other has received them.</p></li>
<li><p>Confirmed: A valid encrypted packet has been received from the other peer:
Connection is fully established: stop sending handshake packets.</p></li>
</ol>

<p>Toxcore sends handshake packets every second 8 times and times out the
connection if the connection does not get confirmed (no encrypted packet is
received) within this time.</p>

<p>Perfect handshake scenario:</p>

<pre class="rust rust-example-rendered">
<span class="ident">Peer</span> <span class="number">1</span>                <span class="ident">Peer</span> <span class="number">2</span>
<span class="ident">Cookie</span> <span class="ident">request</span>   <span class="op">-&gt;</span>
                      &lt;- <span class="ident">Cookie</span> <span class="ident">response</span>
<span class="ident">Handshake</span> <span class="ident">packet</span> <span class="op">-&gt;</span>
                      <span class="op">*</span> <span class="ident">accepts</span> <span class="ident">connection</span>
                      &lt;- <span class="ident">Handshake</span> <span class="ident">packet</span>
<span class="kw-2">*</span><span class="ident">accepts</span> <span class="ident">connection</span>
<span class="ident">Encrypted</span> <span class="ident">packet</span> <span class="op">-&gt;</span>   &lt;- <span class="ident">Encrypted</span> <span class="ident">packet</span>
<span class="kw-2">*</span><span class="ident">confirms</span> <span class="ident">connection</span>  <span class="kw-2">*</span><span class="ident">confirms</span> <span class="ident">connection</span>
       <span class="ident">Connection</span> <span class="ident">successful</span>.
<span class="ident">Encrypted</span> <span class="ident">packets</span> <span class="op">-&gt;</span> &lt;- <span class="ident">Encrypted</span> <span class="ident">packets</span>

<span class="ident">More</span> <span class="ident">realistic</span> <span class="ident">handshake</span> <span class="ident">scenario</span>:
<span class="ident">Peer</span> <span class="number">1</span>                <span class="ident">Peer</span> <span class="number">2</span>
<span class="ident">Cookie</span> <span class="ident">request</span>   <span class="op">-&gt;</span>   <span class="kw-2">*</span><span class="ident">packet</span> <span class="ident">lost</span><span class="op">*</span>
<span class="ident">Cookie</span> <span class="ident">request</span>   <span class="op">-&gt;</span>
                      &lt;- <span class="ident">Cookie</span> <span class="ident">response</span>
                      <span class="kw-2">*</span><span class="ident">Peer</span> <span class="number">2</span> <span class="ident">randomly</span> <span class="ident">starts</span> <span class="ident">new</span> <span class="ident">connection</span> <span class="ident">to</span> <span class="ident">peer</span> <span class="number">1</span>
                      &lt;- <span class="ident">Cookie</span> <span class="ident">request</span>
<span class="ident">Cookie</span> <span class="ident">response</span>  <span class="op">-&gt;</span>
<span class="ident">Handshake</span> <span class="ident">packet</span> <span class="op">-&gt;</span>   &lt;- <span class="ident">Handshake</span> <span class="ident">packet</span>
<span class="kw-2">*</span><span class="ident">accepts</span> <span class="ident">connection</span>   <span class="op">*</span> <span class="ident">accepts</span> <span class="ident">connection</span>
<span class="ident">Encrypted</span> <span class="ident">packet</span> <span class="op">-&gt;</span>   &lt;- <span class="ident">Encrypted</span> <span class="ident">packet</span>
<span class="kw-2">*</span><span class="ident">confirms</span> <span class="ident">connection</span>  <span class="kw-2">*</span><span class="ident">confirms</span> <span class="ident">connection</span>
       <span class="ident">Connection</span> <span class="ident">successful</span>.
<span class="ident">Encrypted</span> <span class="ident">packets</span> <span class="op">-&gt;</span> &lt;- <span class="ident">Encrypted</span> <span class="ident">packets</span></pre>

<p>The reason why the handshake is like this is because of certain design
requirements:</p>

<ol>
<li><p>The handshake must not leak the long term public keys of the peers to a
possible attacker who would be looking at the packets but each peer must
know for sure that they are connecting to the right peer and not an
impostor.</p></li>
<li><p>A connection must be able of being established if only one of the peers has
the information necessary to initiate a connection (DHT public key of the
peer and a link to the peer).</p></li>
<li><p>If both peers initiate a connection to each other at the same time the
connection must succeed without issues.</p></li>
<li><p>There must be perfect forward secrecy.</p></li>
<li><p>Must be resistant to any possible attacks.</p></li>
</ol>

<p>Due to how it is designed only one connection is possible at a time between 2
peers.</p>

<p>Encrypted packets:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x1b)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> The last 2 bytes of the nonce used to encrypt this</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left"> Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with the session key and &#39;base nonce&#39; set by the
receiver in their handshake + packet number (starting at 0, big endian math).</p>

<p>The packet id for encrypted packets is <code>27</code>. Encrypted packets are the packets
used to send data to the other peer in the connection. Since these packets can
be sent over UDP the implementation must assume that they can arrive out of
order or even not arrive at all.</p>

<p>To get the key used to encrypt/decrypt each packet in the connection a peer
takes the session public key received in the handshake and the private key
counterpart of the key it sent it the handshake and generates a shared key from
it. This shared key will be identical for both peers. It is important to note
that connection keys must be wiped when the connection is killed.</p>

<p>To create an encrypted packet to be sent to the other peer, the data is
encrypted with the shared key for this connection and the base nonce that the
other peer sent in the handshake packet with the total number of encrypted
packets sent in the connection added to it (&#39;base nonce&#39; + 0 for the first
encrypted data packet sent, &#39;base nonce&#39; + 1 for the second, etc. Note that the
nonce is treated as a big endian number for mathematical operations like
additions). The 2 byte (<code>uint16_t</code>) number at the beginning of the encrypted
packet is the last 2 bytes of this 24 byte nonce.</p>

<p>To decrypt a received encrypted packet, the nonce the packet was encrypted with
is calculated using the base nonce that the peer sent to the other and the 2
byte number at the beginning of the packet. First we assume that packets will
most likely arrive out of order and that some will be lost but that packet loss
and out of orderness will never be enough to make the 2 byte number need an
extra byte. The packet is decrypted using the shared key for the connection and
the calculated nonce.</p>

<p>Toxcore uses the following method to calculate the nonce for each packet:</p>

<ol>
<li><p><code>diff</code> = (2 byte number on the packet) - (last 2 bytes of the current saved
base nonce) NOTE: treat the 3 variables as 16 bit unsigned ints, the result
is expected to sometimes roll over.</p></li>
<li><p>copy <code>saved_base_nonce</code> to <code>temp_nonce</code>.</p></li>
<li><p><code>temp_nonce = temp_nonce + diff</code>. <code>temp_nonce</code> is the correct nonce that
can be used to decrypt the packet.</p></li>
<li><p><code>DATA_NUM_THRESHOLD</code> = (1/3 of the maximum number that can be stored in an
unsigned 2 bit integer)</p></li>
<li><p>if decryption succeeds and <code>diff &gt; (DATA_NUM_THRESHOLD * 2)</code> then:</p>

<ul>
<li>  <code>saved_base_nonce = saved_base_nonce + DATA_NUM_THRESHOLD</code></li>
</ul></li>
</ol>

<p>First it takes the difference between the 2 byte number on the packet and the
last. Because the 3 values are unsigned 16 bit ints and rollover is part of the
math something like diff = (10 - 65536) means diff is equal to 11.</p>

<p>Then it copies the saved base nonce to a temp nonce buffer.</p>

<p>Then it adds diff to the nonce (the nonce is in big endian format).</p>

<p>After if decryption was successful it checks if diff was bigger than 2/3 of the
value that can be contained in a 16 bit unsigned int and increases the saved
base nonce by 1/3 of the maximum value if it succeeded.</p>

<p>This is only one of many ways that the nonce for each encrypted packet can be
calculated.</p>

<p>Encrypted packets that cannot be decrypted are simply dropped.</p>

<p>The reason for exchanging base nonces is because since the key for encrypting
packets is the same for received and sent packets there must be a cryptographic
way to make it impossible for someone to do an attack where they would replay
packets back to the sender and the sender would think that those packets came
from the other peer.</p>

<p>Data in the encrypted packets:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">our</span> <span class="ident">recvbuffers</span> <span class="ident">buffer_start</span>, (<span class="ident">highest</span> <span class="ident">packet</span> <span class="ident">number</span> <span class="ident">handled</span> <span class="op">+</span> <span class="number">1</span>), (<span class="ident">big</span> <span class="ident">endian</span>)]
[<span class="ident">uint32_t</span> <span class="ident">packet</span> <span class="ident">number</span> <span class="kw">if</span> <span class="ident">lossless</span>, <span class="ident">sendbuffer</span> <span class="ident">buffer_end</span> <span class="kw">if</span> <span class="ident">lossy</span>, (<span class="ident">big</span> <span class="ident">endian</span>)]
[<span class="ident">data</span>]</pre>

<p>Encrypted packets may be lossy or lossless. Lossy packets are simply encrypted
packets that are sent to the other. If they are lost, arrive in the wrong order
or even if an attacker duplicates them (be sure to take this into account for
anything that uses lossy packets) they will simply be decrypted as they arrive
and passed upwards to what should handle them depending on the data id.</p>

<p>Lossless packets are packets containing data that will be delivered in order by
the implementation of the protocol. In this protocol, the receiver tells the
sender which packet numbers he has received and which he has not and the sender
must resend any packets that are dropped. Any attempt at doubling packets will
cause all (except the first received) to be ignored.</p>

<p>Each lossless packet contains both a 4 byte number indicating the highest
packet number received and processed and a 4 byte packet number which is the
packet number of the data in the packet.</p>

<p>In lossy packets, the layout is the same except that instead of a packet
number, the second 4 byte number represents the packet number of a lossless
packet if one were sent right after. This number is used by the receiver to
know if any packets have been lost. (for example if it receives 4 packets with
numbers (0, 1, 2, 5) and then later a lossy packet with this second number as:
8 it knows that packets: 3, 4, 6, 7 have been lost and will request them)</p>

<p>How the reliability is achieved:</p>

<p>First it is important to say that packet numbers do roll over, the next number
after 0xFFFFFFFF (maximum value in 4 bytes) is 0. Hence, all the mathematical
operations dealing with packet numbers are assumed to be done only on unsigned
32 bit integer unless said otherwise. For example 0 - 0xFFFFFFFF would equal to
1 because of the rollover.</p>

<p>When sending a lossless packet, the packet is created with its packet number
being the number of the last lossless packet created + 1 (starting at 0). The
packet numbers are used for both reliability and in ordered delivery and so
must be sequential.</p>

<p>The packet is then stored along with its packet number in order for the peer to
be able to send it again if the receiver does not receive it. Packets are only
removed from storage when the receiver confirms they have received them.</p>

<p>The receiver receives packets and stores them along with their packet number.
When a receiver receives a packet he stores the packet along with its packet
number in an array. If there is already a packet with that number in the
buffer, the packet is dropped. If the packet number is smaller than the last
packet number that was processed, the packet is dropped. A processed packet
means it was removed from the buffer and passed upwards to the relevant module.</p>

<p>Assuming a new connection, the sender sends 5 lossless packets to the receiver:
0, 1, 2, 3, 4 are the packet numbers sent and the receiver receives: 3, 2, 0, 2
in that order.</p>

<p>The receiver will save the packets and discards the second packet with the
number 2, he has: 0, 2, 3 in his buffer. He will pass the first packet to the
relevant module and remove it from the array but since packet number 1 is
missing he will stop there. Contents of the buffer are now: 2, 3. The receiver
knows packet number 1 is missing and will request it from the sender by using a
packet request packet:</p>

<p>data ids:</p>

<table>
<thead>
<tr>
<th style="text-align: left">ID</th>
<th style="text-align: left"> Data</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">0</td>
<td style="text-align: left">padding (skipped until we hit a non zero (data id) byte)</td>
</tr>
<tr>
<td style="text-align: left">1</td>
<td style="text-align: left">packet request packet (lossy packet)</td>
</tr>
<tr>
<td style="text-align: left">2</td>
<td style="text-align: left">connection kill packet (lossy packet)</td>
</tr>
<tr>
<td style="text-align: left">...</td>
<td style="text-align: left">...</td>
</tr>
<tr>
<td style="text-align: left">16+</td>
<td style="text-align: left">reserved for Messenger usage (lossless packets)</td>
</tr>
<tr>
<td style="text-align: left">192+</td>
<td style="text-align: left">reserved for Messenger usage (lossy packets)</td>
</tr>
<tr>
<td style="text-align: left">255</td>
<td style="text-align: left">reserved for Messenger usage (lossless packet)</td>
</tr>
</tbody>
</table>

<p>Connection kill packets tell the other that the connection is over.</p>

<p>Packet numbers are the first byte of data in the packet.</p>

<p>packet request packet:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> (<span class="number">1</span>)][<span class="ident">uint8_t</span> <span class="ident">num</span>][<span class="ident">uint8_t</span> <span class="ident">num</span>][<span class="ident">uint8_t</span> <span class="ident">num</span>]...[<span class="ident">uint8_t</span> <span class="ident">num</span>]</pre>

<p>Packet request packets are used by one side of the connection to request
packets from the other. To create a full packet request packet, the one
requesting the packet takes the last packet number that was processed (sent to
the relevant module and removed from the array (0 in the example above)).
Subtract the number of the first missing packet from that number (1 - 0) = 1.
Which means the full packet to request packet number 1 will look like:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint32_t</span> <span class="number">1</span>]
[<span class="ident">uint32_t</span> <span class="number">0</span>]
[<span class="ident">uint8_t</span> <span class="number">1</span>][<span class="ident">uint8_t</span> <span class="number">1</span>]</pre>

<p>If packet number 4 was being requested as well, take the difference between the
packet number and the last packet number being requested (4 - 1) = 3. So the
packet will look like:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint32_t</span> <span class="number">1</span>]
[<span class="ident">uint32_t</span> <span class="number">0</span>]
[<span class="ident">uint8_t</span> <span class="number">1</span>][<span class="ident">uint8_t</span> <span class="number">1</span>][<span class="ident">uint8_t</span> <span class="number">3</span>]</pre>

<p>But what if the number is greater than 255? Let&#39;s say the peer needs to request
packets 3, 6, 1024, the packet will look like:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint32_t</span> <span class="number">1</span>]
[<span class="ident">uint32_t</span> <span class="number">2</span>]
[<span class="ident">uint8_t</span> <span class="number">1</span>][<span class="ident">uint8_t</span> <span class="number">3</span>][<span class="ident">uint8_t</span> <span class="number">3</span>][<span class="ident">uint8_t</span> <span class="number">0</span>][<span class="ident">uint8_t</span> <span class="number">0</span>][<span class="ident">uint8_t</span> <span class="number">0</span>][<span class="ident">uint8_t</span> <span class="number">253</span>]</pre>

<p>Each 0 in the packet represents adding 255 until a non 0 byte is reached which
is then added and the resulting requested number is what is left.</p>

<p>This request is designed to be small when requesting packets in real network
conditions where the requested packet numbers will be close to each other.
Putting each requested 4 byte packet number would be very simple but would make
the request packets unnecessarily large which is why the packets look like
this.</p>

<p>When a request packet is received, it will be decoded and all packets in
between the requested packets will be assumed to be successfully received by
the other.</p>

<p>Packet request packets are sent at least every 1 second in toxcore and more
when packets are being received.</p>

<p>The current formula used is (note that this formula is likely sub-optimal):</p>

<pre class="rust rust-example-rendered">
<span class="ident">REQUEST_PACKETS_COMPARE_CONSTANT</span> <span class="op">=</span> <span class="number">50.0</span> <span class="ident">double</span> <span class="ident">request_packet_interval</span> <span class="op">=</span>
(<span class="ident">REQUEST_PACKETS_COMPARE_CONSTANT</span> <span class="op">/</span>
(((<span class="ident">double</span>)<span class="ident">num_packets_array</span>(<span class="kw-2">&amp;</span><span class="ident">conn</span><span class="op">-&gt;</span><span class="ident">recv_array</span>) <span class="op">+</span> <span class="number">1.0</span>) <span class="op">/</span> (<span class="ident">conn</span><span class="op">-&gt;</span><span class="ident">packet_recv_rate</span>
<span class="op">+</span> <span class="number">1.0</span>)));</pre>

<p><code>num_packets_array(&amp;conn-&gt;recv_array)</code> returns the difference between the
highest packet number received and the last one handled. In the toxcore code it
refers to the total size of the current array (with the holes which are the
placeholders for not yet received packets that are known to be missing).</p>

<p><code>conn-&gt;packet_recv_rate</code> is the number of data packets successfully received
per second.</p>

<p>This formula was created with the logic that the higher the &#39;delay&#39; in packets
(<code>num_packets_array(&amp;conn-&gt;recv_array)</code>) vs the speed of packets received, the
more request packets should be sent.</p>

<p>Requested packets are resent every time they can be resent as in they will obey
the congestion control and not bypass it. They are resent once, subsequent
request packets will be used to know if the packet was received or if it should
be resent.</p>

<p>The ping or rtt (round trip time) between two peers can be calculated by saving
the time each packet was sent and taking the difference between the time the
latest packet confirmed received by a request packet was sent and the time the
request packet was received. The rtt can be calculated for every request
packet. The lowest one (for all packets) will be the closest to the real ping.</p>

<p>This ping or rtt can be used to know if a request packet that requests a packet
we just sent should be resent right away or we should wait or not for the next
one (to know if the other side actually had time to receive the packet).</p>

<p>The congestion control algorithm has the goal of guessing how many packets can
be sent through the link every second before none can be sent through anymore.
How it works is basically to send packets faster and faster until none can go
through the link and then stop sending them faster than that.</p>

<p>Currently the congestion control uses the following formula in toxcore however
that is probably not the best way to do it.</p>

<p>The current formula is to take the difference between the current size of the
send queue and the size of the send queue 1.2 seconds ago, take the total
number of packets sent in the last 1.2 seconds and subtract the previous number
from it.</p>

<p>Then divide this number by 1.2 to get a packet speed per second. If this speed
is lower than the minimum send rate of 8 packets per second, set it to 8.</p>

<p>A congestion event can be defined as an event when the number of requested
packets exceeds the number of packets the congestion control says can be sent
during this frame. If a congestion event occurred during the last 2 seconds,
the packet send rate of the connection is set to the send rate previously
calculated, if not it is set to that send rate times 1.25 in order to increase
the speed.</p>

<p>Like I said this isn&#39;t perfect and a better solution can likely be found or the
numbers tweaked.</p>

<p>To fix the possible issue where it would be impossible to send very low
bandwidth data like text messages when sending high bandwidth data like files
it is possible to make priority packets ignore the congestion control
completely by placing them into the send packet queue and sending them even if
the congestion control says not to. This is used in toxcore for all non file
transfer packets to prevent file transfers from preventing normal message
packets from being sent.</p>

<h1 id='onion' class='section-header'><a href='#onion'>11 Onion</a></h1>
<p>The goal of the onion module in Tox is to prevent peers that are not friends
from finding out the temporary DHT public key from a known long term public key
of the peer and to prevent peers from discovering the long term public key of
peers when only the temporary DHT key is known.</p>

<p>It makes sure only friends of a peer can find it and connect to it and
indirectly makes sure non friends cannot find the ip address of the peer when
knowing the Tox address of the friend.</p>

<p>The only way to prevent peers in the network from associating the temporary DHT
public key with the long term public key is to not broadcast the long term key
and only give others in the network that are not friends the DHT public key.</p>

<p>The onion lets peers send their friends, whose real public key they know as it
is part of the Tox ID, their DHT public key so that the friends can then find
and connect to them without other peers being able to identify the real public
keys of peers.</p>

<p>So how does the onion work?</p>

<p>The onion works by enabling peers to announce their real public key to peers by
going through the onion path. It is like a DHT but through onion paths. In fact
it uses the DHT in order for peers to be able to find the peers with ids
closest to their public key by going through onion paths.</p>

<p>In order to announce its real public key anonymously to the Tox network while
using the onion, a peer first picks 3 random nodes that it knows (they can be
from anywhere: the DHT, connected TCP relays or nodes found while finding peers
with the onion). The nodes should be picked in a way that makes them unlikely
to be operated by the same person perhaps by looking at the ip addresses and
looking if they are in the same subnet or other ways. More research is needed
to make sure nodes are picked in the safest way possible.</p>

<p>The reason for 3 nodes is that 3 hops is what they use in Tor and other
anonymous onion based networks.</p>

<p>These nodes are referred to as nodes A, B and C. Note that if a peer cannot
communicate via UDP, its first peer will be one of the TCP relays it is
connected to, which will be used to send its onion packet to the network.</p>

<p>TCP relays can only be node A or the first peer in the chain as the TCP relay
is essentially acting as a gateway to the network. The data sent to the TCP
Client module to be sent as a TCP onion packet by the module is different from
the one sent directly via UDP. This is because it doesn&#39;t need to be encrypted
(the connection to the TCP relay server is already encrypted).</p>

<p>First I will explain how communicating via onion packets work.</p>

<p>Note: nonce is a 24 byte nonce. The nested nonces are all the same as the outer
nonce.</p>

<p>Onion packet (request):</p>

<p>Initial (TCP) data sent as the data of an onion packet through the TCP client
module:</p>

<ul>
<li><p><code>IP_Port</code> of node B</p></li>
<li><p>A random public key PK1</p></li>
<li><p>Encrypted with the secret key SK1 and the public key of Node B and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node C</p></li>
<li><p>A random public key PK2</p></li>
<li><p>Encrypted with the secret key SK2 and the public key of Node C and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node D</p></li>
<li><p>Data to send to Node D</p></li>
</ul></li>
</ul></li>
</ul>

<p>Initial (UDP) (sent from us to node A):</p>

<ul>
<li><p><code>uint8_t</code> (0x80) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>Our temporary DHT public key</p></li>
<li><p>Encrypted with our temporary DHT secret key and the public key of Node A
and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node B</p></li>
<li><p>A random public key PK1</p></li>
<li><p>Encrypted with the secret key SK1 and the public key of Node B and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node C</p></li>
<li><p>A random public key PK2</p></li>
<li><p>Encrypted with the secret key SK2 and the public key of Node C and
the nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node D</p></li>
<li><p>Data to send to Node D</p></li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>(sent from node A to node B):</p>

<ul>
<li><p><code>uint8_t</code> (0x81) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>A random public key PK1</p></li>
<li><p>Encrypted with the secret key SK1 and the public key of Node B and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node C</p></li>
<li><p>A random public key PK2</p></li>
<li><p>Encrypted with the secret key SK2 and the public key of Node C and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node D</p></li>
<li><p>Data to send to Node D</p></li>
</ul></li>
</ul></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
</ul>

<p>(sent from node B to node C):</p>

<ul>
<li><p><code>uint8_t</code> (0x82) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>A random public key PK1</p></li>
<li><p>Encrypted with the secret key SK1 and the public key of Node C and the
nonce:</p>

<ul>
<li><p><code>IP_Port</code> of node D</p></li>
<li><p>Data to send to Node D</p></li>
</ul></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node B and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node A)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
</ul></li>
</ul>

<p>(sent from node C to node D):</p>

<ul>
<li><p>Data to send to Node D</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node C and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node B)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node B and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node A)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>Onion packet (response):</p>

<p>initial (sent from node D to node C):</p>

<ul>
<li><p><code>uint8_t</code> (0x8c) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node C and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node B)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node B and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node A)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Data to send back</p></li>
</ul>

<p>(sent from node C to node B):</p>

<ul>
<li><p><code>uint8_t</code> (0x8d) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node B and the nonce:</p>

<ul>
<li><p><code>IP_Port</code> (of Node A)</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
</ul></li>
<li><p>Data to send back</p></li>
</ul>

<p>(sent from node B to node A):</p>

<ul>
<li><p><code>uint8_t</code> (0x8e) packet id</p></li>
<li><p>Nonce</p></li>
<li><p>Encrypted with the temporary symmetric key of Node A and the nonce:</p>

<ul>
<li>  <code>IP_Port</code> (of us)</li>
</ul></li>
<li><p>Data to send back</p></li>
</ul>

<p>(sent from node A to us):</p>

<ul>
<li>  Data to send back</li>
</ul>

<p>Each packet is encrypted multiple times so that only node A will be able to
receive and decrypt the first packet and know where to send it to, node B will
only be able to receive that decrypted packet, decrypt it again and know where
to send it and so on. You will also notice a piece of encrypted data (the
sendback) at the end of the packet that grows larger and larger at every layer
with the IP of the previous node in it. This is how the node receiving the end
data (Node D) will be able to send data back.</p>

<p>When a peer receives an onion packet, they will decrypt it, encrypt the
coordinates (IP/port) of the source along with the already existing encrypted
data (if it exists) with a symmetric key known only by the peer and only
refreshed every hour (in toxcore) as a security measure to force expire paths.</p>

<p>Here&#39;s a diagram how it works:</p>

<pre class="rust rust-example-rendered">
<span class="ident">peer</span>
  <span class="op">-&gt;</span> [<span class="ident">onion1</span>[<span class="ident">onion2</span>[<span class="ident">onion3</span>[<span class="ident">data</span>]]]] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">A</span>
  <span class="op">-&gt;</span> [<span class="ident">onion2</span>[<span class="ident">onion3</span>[<span class="ident">data</span>]]][<span class="ident">sendbackA</span>] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">B</span>
  <span class="op">-&gt;</span> [<span class="ident">onion3</span>[<span class="ident">data</span>]][<span class="ident">sendbackB</span>[<span class="ident">sendbackA</span>]] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">C</span>
  <span class="op">-&gt;</span> [<span class="ident">data</span>][<span class="ident">SendbackC</span>[<span class="ident">sendbackB</span>[<span class="ident">sendbackA</span>]]]<span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">D</span> (<span class="ident">end</span>)

<span class="ident">Node</span> <span class="ident">D</span>
  <span class="op">-&gt;</span> [<span class="ident">SendbackC</span>[<span class="ident">sendbackB</span>[<span class="ident">sendbackA</span>]]][<span class="ident">response</span>] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">C</span>
  <span class="op">-&gt;</span> [<span class="ident">sendbackB</span>[<span class="ident">sendbackA</span>]][<span class="ident">response</span>] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">B</span>
  <span class="op">-&gt;</span> [<span class="ident">sendbackA</span>][<span class="ident">response</span>] <span class="op">-&gt;</span> <span class="ident">Node</span> <span class="ident">A</span>
  <span class="op">-&gt;</span> [<span class="ident">response</span>] <span class="op">-&gt;</span> <span class="ident">peer</span></pre>

<p>The random public keys in the onion packets are temporary public keys generated
for and used for that onion path only. This is done in order to make it
difficult for others to link different paths together. Each encrypted layer
must have a different public key. This is the reason why there are multiple
keys in the packet definintions above.</p>

<p>The nonce is used to encrypt all the layers of encryption. This 24 byte nonce
should be randomly generated. If it isn&#39;t randomly generated and has a relation
to nonces used for other paths it could be possible to tie different onion
paths together.</p>

<p>The <code>IP_Port</code> is an ip and port in packed format:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>TOX_AF_INET</code> (2) for IPv4 or <code>TOX_AF_INET6</code> (10) for IPv6</td>
</tr>
<tr>
<td style="text-align: left"><code>4 | 16</code></td>
<td style="text-align: left">IP address (4 bytes if IPv4, 16 if IPv6)</td>
</tr>
<tr>
<td style="text-align: left"><code>12 | 0</code></td>
<td style="text-align: left">Zeroes</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Port</td>
</tr>
</tbody>
</table>

<p>If IPv4 the format is padded with 12 bytes of zeroes so that both IPv4 and IPv6
have the same stored size.</p>

<p>The <code>IP_Port</code> will always end up being of size 19 bytes. This is to make it
hard to know if an ipv4 or ipv6 ip is in the packet just by looking at the
size. The 12 bytes of zeros when ipv4 must be set to 0 and not left
uninitialized as some info may be leaked this way if it stays uninitialized.
All numbers here are in big endian format.</p>

<p>The <code>IP_Port</code> in the sendback data can be in any format as long as the length
is 19 bytes because only the one who writes it can decrypt it and read it,
however, using the previous format is recommended because of code reuse. The
nonce in the sendback data must be a 24 byte nonce.</p>

<p>Each onion layers has a different packed id that identifies it so that an
implementation knows exactly how to handle them. Note that any data being sent
back must be encrypted, appear random and not leak information in any way as
all the nodes in the path will see it.</p>

<p>If anything is wrong with the received onion packets (decryption fails) the
implementation should drop them.</p>

<p>The implementation should have code for each different type of packet that
handles it, adds (or decrypts) a sendback and sends it to the next peer in the
path. There are a lot of packets but an implementation should be very
straightforward.</p>

<p>Note that if the first node in the path is a TCP relay, the TCP relay must put
an identifier (instead of an IP/Port) in the sendback so that it knows that any
response should be sent to the appropriate peer connected to the TCP relay.</p>

<p>This explained how to create onion packets and how they are sent back. Next is
what is actually sent and received on top of these onion packets or paths.</p>

<p>Note: nonce is a 24 byte nonce.</p>

<p>announce request packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x83)</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">A public key (real or temporary)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">Payload</td>
</tr>
</tbody>
</table>

<p>The public key is our real long term public key if we want to announce
ourselves, a temporary one if we are searching for friends.</p>

<p>The payload is encrypted with the secret key part of the sent public key, the
public key of Node D and the nonce, and contains:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Ping ID</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key we are searching for</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key that we want those sending back data packets to use</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left">Data to send back in response</td>
</tr>
</tbody>
</table>

<p>If the ping id is zero, respond with an announce response packet.</p>

<p>If the ping id matches the one the node sent in the announce response and the
public key matches the one being searched for, add the part used to send data
to our list. If the list is full make it replace the furthest entry.</p>

<p>data to route request packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x85)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Public key of destination node</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Temporary just generated public key</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with that temporary secret key and the nonce and the
public key from the announce response packet of the destination node. If Node D
contains the ret data for the node, it sends the stuff in this packet as a data
to route response packet to the right node.</p>

<p>The data in the previous packet is in format:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Real public key of sender</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left"> Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with real secret key of the sender, the nonce in the
data packet and the real public key of the receiver:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> id</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left"> Data (optional)</td>
</tr>
</tbody>
</table>

<p>Data sent to us:</p>

<p>announce response packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x84)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left">Data to send back in response</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with the DHT secret key of Node D, the public key in
the request and the nonce:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"> <code>uint8_t</code> <code>is_stored</code></td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Ping ID or Public Key</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Maximum of 4 nodes in packed node format (see DHT)</td>
</tr>
</tbody>
</table>

<p>The packet contains a ping ID if <code>is_stored</code> is 0 or 2, or the public key that
must be used to send data packets if <code>is_stored</code> is 1.</p>

<p>If the <code>is_stored</code> is not 0, it means the information to reach the public key
we are searching for is stored on this node. <code>is_stored</code> is 2 as a response to
a peer trying to announce himself to tell the peer that he is currently
announced successfully.</p>

<p>data to route response packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x86)</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Temporary just generated public key</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with that temporary secret key, the nonce and the
public key from the announce response packet of the destination node.</p>

<p>There are 2 types of request packets and 2 &#39;response&#39; packets to go with them.
The announce request is used to announce ourselves to a node and announce
response packet is used by the node to respond to this packet. The data to
route request packet is a packet used to send packets through the node to
another peer that has announced itself and that we have found. The data to
route response packet is what the node transforms this packet into.</p>

<p>To announce ourselves to the network we must first find, using announce
packets, the peers with the DHT public key closest to our real public key. We
must then announce ourselves to these peers. Friends will then be able to send
messages to us using data to route packets by sending them to these peers. To
find the peers we have announced ourselves to, our friends will find the peers
closest to our real public key and ask them if they know us. They will then be
able to use the peers that know us to send us some messages that will contain
their DHT public key (which we need to know to connect directly to them), TCP
relays that they are connected to (so we can connect to them with these relays
if we need to) and some DHT peers they are connected to (so we can find them
faster in the DHT).</p>

<p>Announce request packets are the same packets used slightly differently if we
are announcing ourselves or searching for peers that know one of our friends.</p>

<p>If we are announcing ourselves we must put our real long term public key in the
packet and encrypt it with our long term private key. This is so the peer we
are announcing ourselves to can be sure that we actually own that public key.
If we are looking for peers we use a temporary public key used only for packets
looking for that peer in order to leak as little information as possible. The
<code>ping_id</code> is a 32 byte number which is sent to us in the announce response and
we must send back to the peer in another announce request. This is done in
order to prevent people from easily announcing themselves many times as they
have to prove they can respond to packets from the peer before the peer will
let them announce themselves. This <code>ping_id</code> is set to 0 when none is known.</p>

<p>The public key we are searching for is set to our long term public key when
announcing ourselves and set to the long term public key of the friend we are
searching for if we are looking for peers.</p>

<p>When announcing ourselves, the public key we want others to use to send us data
back is set to a temporary public key and we use the private key part of this
key to decrypt packet routing data sent to us. This public key is to prevent
peers from saving old data to route packets from previous sessions and be able
to replay them in future Tox sessions. This key is set to zero when searching
for peers.</p>

<p>The sendback data is an 8 byte number that will be sent back in the announce
packet response. Its goal is to be used to learn which announce request packet
the response is responding to, and hence its location in the unencrypted part
of the response. This is needed in toxcore to find and check info about the
packet in order to decrypt it and handle it correctly. Toxcore uses it as an
index to its special <code>ping_array</code>.</p>

<p>Why don&#39;t we use different packets instead of having one announce packet
request and one response that does everything? It makes it a lot more difficult
for possible attackers to know if we are merely announcing ourselves or if we
are looking for friends as the packets for both look the same and are the same
size.</p>

<p>The unencrypted part of an announce response packet contains the sendback data,
which was sent in the request this packet is responding to and a 24 byte random
nonce used to encrypt the encrypted part.</p>

<p>The <code>is_stored</code> number is set to either 0, 1 or 2. 0 means that the public key
that was being searched in the request isn&#39;t stored or known by this peer. 1
means that it is and 2 means that we are announced successfully at that node.
Both 1 and 2 are needed so that when clients are restarted it is possible to
reannounce without waiting for the timeout of the previous announce. This would
not otherwise be possible as a client would receive response 1 without a
<code>ping_id</code> which is needed in order to reannounce successfully.</p>

<p>When the <code>is_stored</code> number is 0 or 2, the next 32 bytes is a <code>ping_id</code>. When
<code>is_stored</code> is 1 it corresponds to a public key (the send back data public key
set by the friend in their announce request) that must be used to encrypt and
send data to the friend.</p>

<p>Then there is an optional maximum 4 nodes, in DHT packed nodes format (see
DHT), attached to the response which denote the 4 DHT peers with the DHT public
keys closest to the searched public key in the announce request known by the
peer (see DHT). To find these peers, toxcore uses the same function as is used
to find peers for get node DHT responses. Peers wanting to announce themselves
or searching for peers that &#39;know&#39; their friends will recursively query closer
and closer peers until they find the closest possible and then either announce
themselves to them or just ping them every once in a while to know if their
friend can be contacted. Note that the distance function used for this is the
same as the Tox DHT.</p>

<p>Data to route request packets are packets used to send data directly to another
peer via a node that knows that peer. The public key is the public key of the
final destination where we want the packet to be sent (the real public key of
our friend). The nonce is a 24 byte random nonce and the public key is a random
temporary public key used to encrypt the data in the packet and, if possible,
only to send packets to this friend (we want to leak as little info to the
network as possible so we use temp public keys as we don&#39;t want a peer to see
the same public keys and be able to link things together). The data is
encrypted data that we want to send to the peer with the public key.</p>

<p>The route response packets are just the last elements (nonce, public key,
encrypted data) of the data to route request packet copied into a new packet
and sent to the appropriate destination.</p>

<p>To handle onion announce packets, toxcore first receives an announce packet and
decrypts it.</p>

<p>Toxcore generates <code>ping_id</code>s by taking a 32 byte sha hash of the current time,
some secret bytes generated when the instance is created, the current time
divided by a 20 second timeout, the public key of the requester and the source
ip/port that the packet was received from. Since the ip/port that the packet
was received from is in the <code>ping_id</code>, the announce packets being sent with a
ping id must be sent using the same path as the packet that we received the
<code>ping_id</code> from or announcing will fail.</p>

<p>The reason for this 20 second timeout in toxcore is that it gives a reasonable
time (20 to 40 seconds) for a peer to announce himself while taking in count
all the possible delays with some extra seconds.</p>

<p>Toxcore generates 2 different ping ids, the first is generated with the current
time (divided by 20) and the second with the current time + 20 (divided by 20).
The two ping ids are then compared to the ping ids in the received packets. The
reason for doing this is that storing every ping id received might be expensive
and leave us vulnerable to a DoS attack, this method makes sure that the other
cannot generate <code>ping_id</code>s and must ask for them. The reason for the 2
<code>ping_id</code>s is that we want to make sure that the timeout is at least 20 seconds
and cannot be 0.</p>

<p>If one of the two ping ids is equal to the public key used to encrypt the
announce packet (the pk the peer is announcing himself as), the sendback data
public key and the sendback data are stored in the datastructure used to store
announced peers. If the implementation has a limit to how many announced
entries it can store, it should only store the entries closest (determined by
the DHT distance function) to its DHT public key. If the entry is already
there, the information will simply be updated with the new one and the timeout
will be reset for that entry.</p>

<p>Toxcore has a timeout of 300 seconds for announce entries after which they are
removed which is long enough to make sure the entries don&#39;t expire prematurely
but not long enough for peers to stay announced for extended amounts of time
after they go offline.</p>

<p>Toxcore will then copy the 4 DHT nodes closest to the public key being searched
to a new packet (the response).</p>

<p>Toxcore will look if the public key being searched is in the datastructure. If
it isn&#39;t it will copy the first generated <code>ping_id</code> (the one generated with the
current time) to the response, set the <code>is_stored</code> number to 0 and send the
packet back.</p>

<p>If the public key is in the datastructure, it will check whether the public key
that was used to encrypt the announce packet is equal to the announced public
key, if it isn&#39;t then it means that the peer is searching for a peer and that
we know it. This means the <code>is_stored</code> is set to 1 and the sending back data
public key in the announce entry is copied to the packet.</p>

<p>If it (key used to encrypt the announce packet) is equal (to the announced
public key which is also the &#39;public key we are searching for&#39; in the announce
packet) meaning the peer is announcing itself and an entry for it exists, the
sending back data public key is checked to see if it equals the one it the
packet. If it is not equal it means that it is outdated, probably because the
announcing peer&#39;s toxcore instance was restarted and so their <code>is_stored</code> is
set to 0, if it is equal it means the peer is announced correctly so the
<code>is_stored</code> is set to 2. The first generated <code>ping_id</code> is then copied to the
packet.</p>

<p>Once the packet is contructed a random 24 byte nonce is generated, the packet
is encrypted (the shared key used to decrypt the request can be saved and used
to encrypt the response to save an expensive key derivation operation), the
data to send back is copied to the unencrypted part and the packet is sent back
as an onion response packet.</p>

<p>In order to announce itself using onion announce packets toxcore first takes
DHT peers, picks random ones and builds onion paths with them by saving 3
nodes, calling it a path, generating some keypairs for encrypting the onion
packets and using them to send onion packets. If the peer is only connected
with TCP, the initial nodes will be bootstrap nodes and connected TCP relays
(for the first peer in the path). Once the peer is connected to the onion he
can fill up his list of known peers with peers sent in announce responses if
needed.</p>

<p>Onion paths have different timeouts depending on whether the path is confirmed
or unconfirmed. Unconfirmed paths (paths that core has never received any
responses from) have a timeout of 4 seconds with 2 tries before they are deemed
non working. This is because, due to network conditions, there may be a large
number of newly created paths that do not work and so trying them a lot would
make finding a working path take much longer. The timeout for a confirmed path
(from which a response was received) is 10 seconds with 4 tries without a
response. A confirmed path has a maximum lifetime of 1200 seconds to make
possible deanonimization attacks more difficult.</p>

<p>Toxcore saves a maximum of 12 paths: 6 paths are reserved for announcing
ourselves and 6 others are used to search for friends. This may not be the
safest way (some nodes may be able to associate friends together) however it is
much more performant than having different paths for each friend. The main
benefit is that the announcing and searching are done with different paths,
which makes it difficult to know that peer with real public key X is friends
with Y and Z. More research is needed to find the best way to do this. At first
toxcore did have different paths for each friend, however, that meant that each
friend path was almost never used (and checked). When using a low amount of
paths for searching there is less resources needed to find good paths. 6 paths
are used because 4 was too low and caused some performance issues because it
took longer to find some good paths at the beginning because only 4 could be
tried at a time. A too high number meanwhile would mean each path is used (and
tested) less. The reason why the numbers are the same for both types of paths
is for code simplification purposes.</p>

<p>To search/announce itself to peers, toxcore keeps the 8 closest peers to each
key it is searching (or announcing itself to). To populate these it starts by
sending announce requests to random peers for all the public keys it is
searching for. It then recursively searches closer and closer peers (DHT
distance function) until it no longer finds any. It is important to make sure
it is not too aggressive at searching the peers as some might no longer be
online but peers might still send announce responses with their information.
Toxcore keeps lists of last pinged nodes for each key searched so as not to
ping dead nodes too aggressively.</p>

<p>Toxcore decides if it will send an announce packet to one of the 4 peers in the
announce response by checking if the peer would be stored as one of the stored
8 closest peers if it responded; if it would not be it doesn&#39;t send an announce
request, if it would be it sends one.</p>

<p>Peers are only put in the 8 closest peers array if they respond to an announce
request. If the peers fail to respond to 3 announce requests they are deemed
timed out and removed.</p>

<p>The reason for the number of peers being 8 is that a lower number might make
searching for and announcing too unreliable and a higher number too
bandwidth/resource intensive.</p>

<p>Toxcore uses <code>ping_array</code> (see <code>ping_array</code>) for the 8 byte sendback data in
announce packets to store information that it will need to handle the response
(key to decrypt it, why was it sent? (to announce ourselves or to search? For
what key? and some other info)). For security purposes it checks to make sure
the packet was received from the right ip/port and checks if the key in the
unencrypted part of the packet is the right public key.</p>

<p>For peers we are announcing ourselves to, if we are not announced to them
toxcore tries every 3 seconds to announce ourselves to them until they return
that we have announced ourselves to, then toxcore sends an announce request
packet every 15 seconds to see if we are still announced and re announce
ourselves at the same time. The timeout of 15 seconds means a <code>ping_id</code>
received in the last packet will not have had time to expire (20 second minimum
timeout) before it is resent 15 seconds later. Toxcore sends every announce
packet with the <code>ping_id</code> previously received from that peer with the same path
(if possible).</p>

<p>For friends this is slightly different. It is important to start searching for
friends after we are fully announced. Assuming a perfect network, we would only
need to do a search for friend public keys only when first starting the
instance (or going offline and back online) as peers starting up after us would
be able to find us immediately just by searching for us. If we start searching
for friends after we are announced we prevent a scenario where 2 friends start
their clients at the same time but are unable to find each other right away
because they start searching for each other while they have not announced
themselves.</p>

<p>For this reason, after the peer is announced successfully for 17 seconds,
announce packets are sent aggressively every 3 seconds to each known close peer
(in the list of 8 peers) to search aggressively for peers that know the peer we
are searching for.</p>

<p>There are other ways this could be done and which would still work but, if
making your own implementation, keep in mind that these are likely not the most
optimized way to do things.</p>

<p>If we find peers (more than 1) that know a friend we will send them an onion
data packet with our DHT public key, up to 2 TCP relays we are connected to and
2 DHT peers close to us to help the friend connect back to us.</p>

<p>Onion data packets are packets sent as the data of data to route packets.</p>

<p>Onion data packets:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key of sender</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left"> Payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with long term private key of the sender, the long
term public key of the receiver and the nonce used in the data to route request
packet used to send this onion data packet (shaves off 24 bytes).</p>

<p>DHT public key packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x9c)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> <code>no_replay</code></td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Our DHT public key</td>
</tr>
<tr>
<td style="text-align: left"><code>[39, 204]</code></td>
<td style="text-align: left">Maximum of 4 nodes in packed format</td>
</tr>
</tbody>
</table>

<p>The packet will only be accepted if the <code>no_replay</code> number is greater than the
<code>no_replay</code> number in the last packet received.</p>

<p>The nodes sent in this packet have TCP so that the friend can connect to us.</p>

<p>Why another round of encryption? We have to prove to the receiver that we own
the long term public key we say we own when sending them our DHT public key.
Friend requests are also sent using onion data packets but their exact format
is explained in Messenger.</p>

<p>The <code>no_replay</code> number is protection if someone tries to replay an older packet
and should be set to an always increasing number. It is 8 bytes so you should
set a high resolution monotonic time as the value.</p>

<p>We send this packet every 30 seconds if there is more than one peer (in the 8)
that says they our friend is announced on them. This packet can also be sent
through the DHT module as a DHT request packet (see DHT) if we know the DHT
public key of the friend and are looking for them in the DHT but have not
connected to them yet. 30 second is a reasonable timeout to not flood the
network with too many packets while making sure the other will eventually
receive the packet. Since packets are sent through every peer that knows the
friend, resending it right away without waiting has a high likelihood of
failure as the chances of packet loss happening to all (up to to 8) packets
sent is low.</p>

<p>When sent as a DHT request packet (this is the data sent in the DHT request
packet):</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x9c)</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key of sender</td>
</tr>
<tr>
<td style="text-align: left"><code>24</code></td>
<td style="text-align: left">Nonce</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Encrypted payload</td>
</tr>
</tbody>
</table>

<p>The payload is encrypted with long term private key of sender, the long term
public key of receiver and the nonce, and contains the DHT public key packet.</p>

<p>When sent as a DHT request packet the DHT public key packet is (before being
sent as the data of a DHT request packet) encrypted with the long term keys of
both the sender and receiver and put in that format. This is done for the same
reason as the double encryption of the onion data packet.</p>

<p>Toxcore tries to resend this packet through the DHT every 20 seconds. 20
seconds is a reasonable resend rate which isn&#39;t too aggressive.</p>

<p>Toxcore has a DHT request packet handler that passes received DHT public key
packets from the DHT module to this module.</p>

<p>If we receive a DHT public key packet, we will first check if the DHT packet is
from a friend, if it is not from a friend, it will be discarded. The
<code>no_replay</code> will then be checked to see if it is good and no packet with a
lower one was received during the session. The DHT key, the TCP nodes in the
packed nodes and the DHT nodes in the packed nodes will be passed to their
relevant modules. The fact that we have the DHT public key of a friend means
this module has achieved its goal.</p>

<p>If a friend is online and connected to us, the onion will stop all of its
actions for that friend. If the peer goes offline it will restart searching for
the friend as if toxcore was just started.</p>

<p>If toxcore goes offline (no onion traffic for 20 seconds) toxcore will
aggressively reannounce itself and search for friends as if it was just
started.</p>

<h1 id='friend-requests' class='section-header'><a href='#friend-requests'>12 Friend requests</a></h1>
<p>When a Tox user adds someone with Tox, toxcore will try sending a friend
request to that person. A friend request contains the long term public key of
the sender, a nospam number and a message.</p>

<p>Transmitting the long term public key is the primary goal of the friend request
as it is what the peer needs to find and establish a connection to the sender.
The long term public key is what the receiver adds to his friends list if he
accepts the friend request.</p>

<p>The nospam is a number used to prevent someone from spamming the network with
valid friend requests. It makes sure that the only people who have seen the Tox
ID of a peer are capable of sending them a friend request. The nospam is one of
the components of the Tox ID.</p>

<p>The nospam is a number or a list of numbers set by the peer, only received
friend requests that contain a nospam that was set by the peer are sent to the
client to be accepted or refused by the user. The nospam prevents random peers
in the network from sending friend requests to non friends. The nospam is not
long enough to be secure meaning an extremely resilient attacker could manage
to send a spam friend request to someone. 4 bytes is large enough to prevent
spam from random peers in the network. The nospam could also allow Tox users to
issue different Tox IDs and even change Tox IDs if someone finds a Tox ID and
decides to send it hundreds of spam friend requests. Changing the nospam would
stop the incoming wave of spam friend requests without any negative effects to
the users friends list. For example if users would have to change their public
key to prevent them from receiving friend requests it would mean they would
have to essentially abandon all their current friends as friends are tied to
the public key. The nospam is not used at all once the friends have each other
added which means changing it won&#39;t have any negative effects.</p>

<p>Friend request:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint32_t</span> <span class="ident">nospam</span>][<span class="ident">Message</span> (<span class="ident">UTF8</span>) <span class="number">1</span> <span class="ident">to</span> <span class="ident">ONION_CLIENT_MAX_DATA_SIZE</span> <span class="ident">bytes</span>]</pre>

<p>Friend request packet when sent as an onion data packet:</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> (<span class="number">32</span>)][<span class="ident">Friend</span> <span class="ident">request</span>]</pre>

<p>Friend request packet when sent as a <code>net_crypto</code> data packet (If we are
directly connected to the peer because of a group chat but are not friends with
them):</p>

<pre class="rust rust-example-rendered">
[<span class="ident">uint8_t</span> (<span class="number">18</span>)][<span class="ident">Friend</span> <span class="ident">request</span>]</pre>

<p>When a friend is added to toxcore with their Tox ID and a message, the friend
is added in <code>friend_connection</code> and then toxcore tries to send friend requests.</p>

<p>When sending a friend request, toxcore will check if the peer which a friend
request is being sent to is already connected to using a <code>net_crypto</code>
connection which can happen if both are in the same group chat. If this is the
case the friend request will be sent as a <code>net_crypto</code> packet using that
connection. If not, it will be sent as an onion data packet.</p>

<p>Onion data packets contain the real public key of the sender and if a
<code>net_crypto</code> connection is established it means the peer knows our real public
key. This is why the friend request does not need to contain the real public
key of the peer.</p>

<p>Friend requests are sent with exponentially increasing interval of 2 seconds, 4
seconds, 8 seconds, etc... in toxcore. This is so friend requests get resent
but eventually get resent in intervals that are so big that they essentially
expire. The sender has no way of knowing if a peer refuses a friend requests
which is why friend requests need to expire in some way. Note that the interval
is the minimum timeout, if toxcore cannot send that friend request it will try
again until it manages to send it. One reason for not being able to send the
friend request would be that the onion has not found the friend in the onion
and so cannot send an onion data packet to them.</p>

<p>Received friend requests are passed to the client, the client is expected to
show the message from the friend request to the user and ask the user if they
want to accept the friend request or not. Friend requests are accepted by
adding the peer sending the friend request as a friend and refused by simply
ignoring it.</p>

<p>Friend requests are sent multiple times meaning that in order to prevent the
same friend request from being sent to the client multiple times toxcore keeps
a list of the last real public keys it received friend requests from and
discards any received friend requests that are from a real public key that is
in that list. In toxcore this list is a simple circular list. There are many
ways this could be improved and made more efficient as a circular list isn&#39;t
very efficient however it has worked well in toxcore so far.</p>

<p>Friend requests from public keys that are already added to the friends list
should also be discarded.</p>

<h1 id='friend-connection' class='section-header'><a href='#friend-connection'>13 Friend connection</a></h1>
<p><code>friend_connection</code> is the module that sits on top of the <a href="#dht">DHT</a>,
<a href="#onion">Onion</a> and <a href="#net-crypto"><code>net_crypto</code></a> modules and takes care of
linking the 3 together.</p>

<p>Friends in <code>friend_connection</code> are represented by their real public key. When a
friend is added in <code>friend_connection</code>, an onion search entry is created for
that friend. This means that the onion module will start looking for this
friend and send that friend their DHT public key, and the TCP relays it is
connected to, in case a connection is only possible with TCP.</p>

<p>Once the onion returns the DHT public key of the peer, the DHT public key is
saved, added to the DHT friends list and a new <code>net_crypto</code> connection is
created. Any TCP relays returned by the onion for this friend are passed to the
<code>net_crypto</code> connection.</p>

<p>If the DHT establishes a direct UDP connection with the friend,
<code>friend_connection</code> will pass the IP/port of the friend to <code>net_crypto</code> and
also save it to be used to reconnect to the friend if they disconnect.</p>

<p>If <code>net_crypto</code> finds that the friend has a different DHT public key, which can
happen if the friend restarted their client, <code>net_crypto</code> will pass the new DHT
public key to the onion module and will remove the DHT entry for the old DHT
public key and replace it with the new one. The current <code>net_crypto</code> connection
will also be killed and a new one with the correct DHT public key will be
created.</p>

<p>When the <code>net_crypto</code> connection for a friend goes online, <code>friend_connection</code>
will tell the onion module that the friend is online so that it can stop
spending resources looking for the friend. When the friend connection goes
offline, <code>friend_connection</code> will tell the onion module so that it can start
looking for the friend again.</p>

<p>There are 2 types of data packets sent to friends with the <code>net_crypto</code>
connection handled at the level of <code>friend_connection</code>, Alive packets and TCP
relay packets. Alive packets are packets with the packet id or first byte of
data (only byte in this packet) being 16. They are used in order to check if
the other friend is still online. <code>net_crypto</code> does not have any timeout when
the connection is established so timeouts are caught using this packet. In
toxcore, this packet is sent every 8 seconds. If none of these packets are
received for 32 seconds, the connection is timed out and killed. These numbers
seem to cause the least issues and 32 seconds is not too long so that, if a
friend times out, toxcore won&#39;t falsely see them online for too long. Usually
when a friend goes offline they have time to send a disconnect packet in the
<code>net_crypto</code> connection which makes them appear offline almost instantly.</p>

<p>The timeout for when to stop retrying to connect to a friend by creating new
<code>net_crypto</code> connections when the old one times out in toxcore is the same as
the timeout for DHT peers (122 seconds). However, it is calculated from the
last time a DHT public key was received for the friend or time the friend&#39;s
<code>net_crypto</code> connection went offline after being online. The highest time is
used to calculate when the timeout is. <code>net_crypto</code> connections will be
recreated (if the connection fails) until this timeout.</p>

<p><code>friend_connection</code> sends a list of 3 relays (the same number as the target
number of TCP relay connections in <code>TCP_connections</code>) to each connected friend
every 5 minutes in toxcore. Immediately before sending the relays, they are
associated to the current <code>net_crypto-&gt;TCP_connections</code> connection. This
facilitates connecting the two friends together using the relays as the friend
who receives the packet will associate the sent relays to the <code>net_crypto</code>
connection they received it from. When both sides do this they will be able to
connect to each other using the relays. The packet id or first byte of the
packet of share relay packets is 0x11. This is then followed by some TCP relays
stored in packed node format.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x11)</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">TCP relays in packed node format (see DHT)</td>
</tr>
</tbody>
</table>

<p>If local IPs are received as part of the packet, the local IP will be replaced
with the IP of the peer that sent the relay. This is because we assume this is
the best way to attempt to connect to the TCP relay. If the peer that sent the
relay is using a local IP, then the sent local IP should be used to connect to
the relay.</p>

<p>For all other data packets, are passed by <code>friend_connection</code> up to the upper
Messenger module. It also separates lossy and lossless packets from
<code>net_crypto</code>.</p>

<p>Friend connection takes care of establishing the connection to the friend and
gives the upper messenger layer a simple interface to receive and send
messages, add and remove friends and know if a friend is connected (online) or
not connected (offline).</p>

<h1 id='tox-id' class='section-header'><a href='#tox-id'>14 Tox ID</a></h1>
<p>The Tox ID is used to identify peers so that they can be added as friends in
Tox. In order to add a friend, a Tox user must have the friend&#39;s Tox ID. The
Tox ID contains the long term public key of the peer (32 bytes) followed by the
4 byte nospam (see: <a href="#friend-requests"><code>friend_requests</code></a>) value and a 2 byte
XOR checksum. The method of sending the Tox ID to others is up to the user and
the client but the recommended way is to encode it in hexadecimal format and
have the user manually send it to the friend using another program.</p>

<p>Tox ID:</p>

<p><img src="img/tox-id.png" alt="Tox ID"></p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">long term public key</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left">nospam</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left">checksum</td>
</tr>
</tbody>
</table>

<p>The checksum is calculated by XORing the first two bytes of the ID with the
next two bytes, then the next two bytes until all the 36 bytes have been XORed
together. The result is then appended to the end to form the Tox ID.</p>

<p>The user must make sure the Tox ID is not intercepted and replaced in transit
by a different Tox ID, which would mean the friend would connect to a malicious
person instead of the user, though taking reasonable precautions as this is
outside the scope of Tox. Tox assumes that the user has ensured that they are
using the correct Tox ID, belonging to the intended person, to add a friend.</p>

<h1 id='messenger' class='section-header'><a href='#messenger'>15 Messenger</a></h1>
<p>Messenger is the module at the top of all the other modules. It sits on top of
<a href="#friend-connection"><code>friend_connection</code></a> in the hierarchy of toxcore.</p>

<p>Messenger takes care of sending and receiving messages using the connection
provided by <code>friend_connection</code>. The module provides a way for friends to
connect and makes it usable as an instant messenger. For example, Messenger
lets users set a nickname and status message which it then transmits to friends
when they are online. It also allows users to send messages to friends and
builds an instant messenging system on top of the lower level
<code>friend_connection</code> module.</p>

<p>Messenger offers two methods to add a friend. The first way is to add a friend
with only their long term public key, this is used when a friend needs to be
added but for some reason a friend request should not be sent. The friend
should only be added. This method is most commonly used to accept friend
requests but could also be used in other ways. If two friends add each other
using this function they will connect to each other. Adding a friend using this
method just adds the friend to <code>friend_connection</code> and creates a new friend
entry in Messenger for the friend.</p>

<p>The second method to add a friend is by using their Tox ID and a message to be
sent in a friend request. This way of adding friends will try to send a friend
request, with the set message, to the peer whose Tox ID was added. The method
is similar to the first one, except that a friend request is crafted and sent
to the other peer.</p>

<p>When a friend connection associated to a Messenger friend goes online, a ONLINE
packet will be sent to them. Friends are only set as online if an ONLINE packet
is received.</p>

<p>As soon as a friend goes online, Messenger will stop sending friend requests to
that friend, if it was sending them, as they are redundant for this friend.</p>

<p>Friends will be set as offline if either the friend connection associated to
them goes offline or if an OFFLINE packet is received from the friend.</p>

<p>Messenger packets are sent to the friend using the online friend connection to
the friend.</p>

<p>Should Messenger need to check whether any of the non lossy packets in the
following list were received by the friend, for example to implement receipts
for text messages, <code>net_crypto</code> can be used. The <code>net_crypto</code> packet number,
used to send the packets, should be noted and then <code>net_crypto</code> checked later
to see if the bottom of the send array is after this packet number. If it is,
then the friend has received them. Note that <code>net_crypto</code> packet numbers could
overflow after a long time, so checks should happen within 2**32 <code>net_crypto</code>
packets sent with the same friend connection.</p>

<p>Message receipts for action messages and normal text messages are implemented
by adding the <code>net_crypto</code> packet number of each message, along with the
receipt number, to the top of a linked list that each friend has as they are
sent. Every Messenger loop, the entries are read from the bottom and entries
are removed and passed to the client until an entry that refers to a packet not
yet received by the other is reached, when this happens it stops.</p>

<p>List of Messenger packets:</p>

<h2 id='online' class='section-header'><a href='#online'>15.1 <code>ONLINE</code></a></h2>
<p>length: 1 byte</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x18)</td>
</tr>
</tbody>
</table>

<p>Sent to a friend when a connection is established to tell them to mark us as
online in their friends list. This packet and the OFFLINE packet are necessary
as <code>friend_connections</code> can be established with non-friends who are part of a
groupchat. The two packets are used to differentiate between these peers,
connected to the user through groupchats, and actual friends who ought to be
marked as online in the friendlist.</p>

<p>On receiving this packet, Messenger will show the peer as being online.</p>

<h2 id='offline' class='section-header'><a href='#offline'>15.2 <code>OFFLINE</code></a></h2>
<p>length: 1 byte</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x19)</td>
</tr>
</tbody>
</table>

<p>Sent to a friend when deleting the friend. Prevents a deleted friend from
seeing us as online if we are connected to them because of a group chat.</p>

<p>On receiving this packet, Messenger will show this peer as offline.</p>

<h2 id='nickname' class='section-header'><a href='#nickname'>15.3 <code>NICKNAME</code></a></h2>
<p>length: 1 byte to 129 bytes.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x30)</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 128]</code></td>
<td style="text-align: left">Nickname as a UTF8 byte string</td>
</tr>
</tbody>
</table>

<p>Used to send the nickname of the peer to others. This packet should be sent
every time to each friend every time they come online and each time the
nickname is changed.</p>

<h2 id='statusmessage' class='section-header'><a href='#statusmessage'>15.4 <code>STATUSMESSAGE</code></a></h2>
<p>length: 1 byte to 1008 bytes.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"> <code>uint8_t</code> (0x31)</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 1007]</code></td>
<td style="text-align: left">Status message as a UTF8 byte string</td>
</tr>
</tbody>
</table>

<p>Used to send the status message of the peer to others. This packet should be
sent every time to each friend every time they come online and each time the
status message is changed.</p>

<h2 id='userstatus' class='section-header'><a href='#userstatus'>15.5 <code>USERSTATUS</code></a></h2>
<p>length: 2 bytes</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x32)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> status (0 = online, 1 = away, 2 = busy)</td>
</tr>
</tbody>
</table>

<p>Used to send the user status of the peer to others. This packet should be sent
every time to each friend every time they come online and each time the user
status is changed.</p>

<h2 id='typing' class='section-header'><a href='#typing'>15.6 <code>TYPING</code></a></h2>
<p>length: 2 bytes</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x33)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> typing status (0 = not typing, 1 = typing)</td>
</tr>
</tbody>
</table>

<p>Used to tell a friend whether the user is currently typing or not.</p>

<h2 id='message' class='section-header'><a href='#message'>15.7 <code>MESSAGE</code></a></h2>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x40)</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 1372]</code></td>
<td style="text-align: left">Message as a UTF8 byte string</td>
</tr>
</tbody>
</table>

<p>Used to send a normal text message to the friend.</p>

<h2 id='action' class='section-header'><a href='#action'>15.8 <code>ACTION</code></a></h2>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x41)</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 1372]</code></td>
<td style="text-align: left">Action message as a UTF8 byte string</td>
</tr>
</tbody>
</table>

<p>Used to send an action message (like an IRC action) to the friend.</p>

<h2 id='msi' class='section-header'><a href='#msi'>15.9 <code>MSI</code></a></h2>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x45)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">data</td>
</tr>
</tbody>
</table>

<p>Reserved for Tox AV usage.</p>

<h2 id='file-transfer-related-packets' class='section-header'><a href='#file-transfer-related-packets'>15.10 File Transfer Related Packets</a></h2>
<h3 id='file_sendrequest' class='section-header'><a href='#file_sendrequest'>15.10.1 <code>FILE_SENDREQUEST</code></a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x50)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> file number</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> file type</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> file size</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">file id (32 bytes)</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 255]</code></td>
<td style="text-align: left">filename as a UTF8 byte string</td>
</tr>
</tbody>
</table>

<p>Note that file type and file size are sent in big endian/network byte format.</p>

<h3 id='file_control' class='section-header'><a href='#file_control'>15.10.2 <code>FILE_CONTROL</code></a></h3>
<p>length: 4 bytes if <code>control_type</code> isn&#39;t seek. 8 bytes if <code>control_type</code> is
seek.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x51)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> <code>send_receive</code></td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> file number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> <code>control_type</code></td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> seek parameter</td>
</tr>
</tbody>
</table>

<p><code>send_receive</code> is 0 if the control targets a file being sent (by the peer
sending the file control), and 1 if it targets a file being received.</p>

<p><code>control_type</code> can be one of: 0 = accept, 1 = pause, 2 = kill, 3 = seek.</p>

<p>The seek parameter is only included when <code>control_type</code> is seek (3).</p>

<p>Note that if it is included the seek parameter will be sent in big
endian/network byte format.</p>

<h3 id='file_data' class='section-header'><a href='#file_data'>15.10.3 <code>FILE_DATA</code></a></h3>
<p>length: 2 to 1373 bytes.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x52)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> file number</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 1371]</code></td>
<td style="text-align: left">file data piece</td>
</tr>
</tbody>
</table>

<p>Files are transferred in Tox using File transfers.</p>

<p>To initiate a file transfer, the friend creates and sends a <code>FILE_SENDREQUEST</code>
packet to the friend it wants to initiate a file transfer to.</p>

<p>The first part of the <code>FILE_SENDREQUEST</code> packet is the file number. The file
number is the number used to identify this file transfer. As the file number is
represented by a 1 byte number, the maximum amount of concurrent files Tox can
send to a friend is 256. 256 file transfers per friend is enough that clients
can use tricks like queueing files if there are more files needing to be sent.</p>

<p>256 outgoing files per friend means that there is a maximum of 512 concurrent
file transfers, between two users, if both incoming and outgoing file transfers
are counted together.</p>

<p>As file numbers are used to identify the file transfer, the Tox instance must
make sure to use a file number that isn&#39;t used for another outgoing file
transfer to that same friend when creating a new outgoing file transfer. File
numbers are chosen by the file sender and stay unchanged for the entire
duration of the file transfer. The file number is used by both <code>FILE_CONTROL</code>
and <code>FILE_DATA</code> packets to identify which file transfer these packets are for.</p>

<p>The second part of the file transfer request is the file type. This is simply a
number that identifies the type of file. for example, tox.h defines the file
type 0 as being a normal file and type 1 as being an avatar meaning the Tox
client should use that file as an avatar. The file type does not effect in any
way how the file is transfered or the behavior of the file transfer. It is set
by the Tox client that creates the file transfers and send to the friend
untouched.</p>

<p>The file size indicates the total size of the file that will be transfered. A
file size of <code>UINT64_MAX</code> (maximum value in a <code>uint64_t</code>) means that the size
of the file is undetermined or unknown. For example if someone wanted to use
Tox file transfers to stream data they would set the file size to <code>UINT64_MAX</code>.
A file size of 0 is valid and behaves exactly like a normal file transfer.</p>

<p>The file id is 32 bytes that can be used to uniquely identify the file
transfer. For example, avatar transfers use it as the hash of the avatar so
that the receiver can check if they already have the avatar for a friend which
saves bandwidth. It is also used to identify broken file transfers across
toxcore restarts (for more info see the file transfer section of tox.h). The
file transfer implementation does not care about what the file id is, as it is
only used by things above it.</p>

<p>The last part of the file transfer is the optional file name which is used to
tell the receiver the name of the file.</p>

<p>When a <code>FILE_SENDREQUEST</code> packet is received, the implementation validates and
sends the info to the Tox client which decides whether they should accept the
file transfer or not.</p>

<p>To refuse or cancel a file transfer, they will send a <code>FILE_CONTROL</code> packet
with <code>control_type</code> 2 (kill).</p>

<p><code>FILE_CONTROL</code> packets are used to control the file transfer. <code>FILE_CONTROL</code>
packets are used to accept/unpause, pause, kill/cancel and seek file transfers.
The <code>control_type</code> parameter denotes what the file control packet does.</p>

<p>The <code>send_receive</code> and file number are used to identify a specific file
transfer. Since file numbers for outgoing and incoming files are not related to
each other, the <code>send_receive</code> parameter is used to identify if the file number
belongs to files being sent or files being received. If <code>send_receive</code> is 0,
the file number corresponds to a file being sent by the user sending the file
control packet. If <code>send_receive</code> is 1, it corresponds to a file being received
by the user sending the file control packet.</p>

<p><code>control_type</code> indicates the purpose of the <code>FILE_CONTROL</code> packet.
<code>control_type</code> of 0 means that the <code>FILE_CONTROL</code> packet is used to tell the
friend that the file transfer is accepted or that we are unpausing a previously
paused (by us) file transfer. <code>control_type</code> of 1 is used to tell the other to
pause the file transfer.</p>

<p>If one party pauses a file transfer, that party must be the one to unpause it.
Should both sides pause a file transfer, both sides must unpause it before the
file can be resumed. For example, if the sender pauses the file transfer, the
receiver must not be able to unpause it. To unpause a file transfer,
<code>control_type</code> 0 is used. Files can only be paused when they are in progress
and have been accepted.</p>

<p><code>control_type</code> 2 is used to kill, cancel or refuse a file transfer. When a
<code>FILE_CONTROL</code> is received, the targeted file transfer is considered dead, will
immediately be wiped and its file number can be reused. The peer sending the
<code>FILE_CONTROL</code> must also wipe the targeted file transfer from their side. This
control type can be used by both sides of the transfer at any time.</p>

<p><code>control_type</code> 3, the seek control type is used to tell the sender of the file
to start sending from a different index in the file than 0. It can only be used
right after receiving a <code>FILE_SENDREQUEST</code> packet and before accepting the file
by sending a <code>FILE_CONTROL</code> with <code>control_type</code> 0. When this <code>control_type</code> is
used, an extra 8 byte number in big endian format is appended to the
<code>FILE_CONTROL</code> that is not present with other control types. This number
indicates the index in bytes from the beginning of the file at which the file
sender should start sending the file. The goal of this control type is to
ensure that files can be resumed across core restarts. Tox clients can know if
they have received a part of a file by using the file id and then using this
packet to tell the other side to start sending from the last received byte. If
the seek position is bigger or equal to the size of the file, the seek packet
is invalid and the one receiving it will discard it.</p>

<p>To accept a file Tox will therefore send a seek packet, if it is needed, and
then send a <code>FILE_CONTROL</code> packet with <code>control_type</code> 0 (accept) to tell the
file sender that the file was accepted.</p>

<p>Once the file transfer is accepted, the file sender will start sending file
data in sequential chunks from the beginning of the file (or the position from
the <code>FILE_CONTROL</code> seek packet if one was received).</p>

<p>File data is sent using <code>FILE_DATA</code> packets. The file number corresponds to the
file transfer that the file chunks belong to. The receiver assumes that the
file transfer is over as soon as a chunk with the file data size not equal to
the maximum size (1371 bytes) is received. This is how the sender tells the
receiver that the file transfer is complete in file transfers where the size of
the file is unknown (set to <code>UINT64_MAX</code>). The receiver also assumes that if
the amount of received data equals to the file size received in the
<code>FILE_SENDREQUEST</code>, the file sending is finished and has been successfully
received. Immediately after this occurs, the receiver frees up the file number
so that a new incoming file transfer can use that file number. The
implementation should discard any extra data received which is larger than the
file size received at the beginning.</p>

<p>In 0 filesize file transfers, the sender will send one <code>FILE_DATA</code> packet with
a file data size of 0.</p>

<p>The sender will know if the receiver has received the file successfully by
checking if the friend has received the last <code>FILE_DATA</code> packet sent
(containing the last chunk of the file). <code>Net_crypto</code> can be used to check
whether packets sent through it have been received by storing the packet number
of the sent packet and verifying later in <code>net_crypto</code> to see whether it was
received or not. As soon as <code>net_crypto</code> says the other received the packet,
the file transfer is considered successful, wiped and the file number can be
reused to send new files.</p>

<p><code>FILE_DATA</code> packets should be sent as fast as the <code>net_crypto</code> connection can
handle it respecting its congestion control.</p>

<p>If the friend goes offline, all file transfers are cleared in toxcore. This
makes it simpler for toxcore as it does not have to deal with resuming file
transfers. It also makes it simpler for clients as the method for resuming file
transfers remains the same, even if the client is restarted or toxcore loses
the connection to the friend because of a bad internet connection.</p>

<h2 id='group-chat-related-packets' class='section-header'><a href='#group-chat-related-packets'>15.11 Group Chat Related Packets</a></h2>
<table>
<thead>
<tr>
<th style="text-align: left">Packet ID</th>
<th style="text-align: left">Packet Name</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">0x60</td>
<td style="text-align: left"><code>INVITE_GROUPCHAT</code></td>
</tr>
<tr>
<td style="text-align: left">0x61</td>
<td style="text-align: left"><code>ONLINE_PACKET</code></td>
</tr>
<tr>
<td style="text-align: left">0x62</td>
<td style="text-align: left"><code>DIRECT_GROUPCHAT</code></td>
</tr>
<tr>
<td style="text-align: left">0x63</td>
<td style="text-align: left"><code>MESSAGE_GROUPCHAT</code></td>
</tr>
<tr>
<td style="text-align: left">0xC7</td>
<td style="text-align: left"><code>LOSSY_GROUPCHAT</code></td>
</tr>
</tbody>
</table>

<p>Messenger also takes care of saving the friends list and other friend
information so that it&#39;s possible to close and start toxcore while keeping all
your friends, your long term key and the information necessary to reconnect to
the network.</p>

<p>Important information messenger stores includes: the long term private key, our
current nospam value, our friends&#39; public keys and any friend requests the user
is currently sending. The network DHT nodes, TCP relays and some onion nodes
are stored to aid reconnection.</p>

<p>In addition to this, a lot of optional data can be stored such as the usernames
of friends, our current username, status messages of friends, our status
message, etc... can be stored. The exact format of the toxcore save is
explained later.</p>

<p>The TCP server is run from the toxcore messenger module if the client has
enabled it. TCP server is usually run independently as part of the bootstrap
node package but it can be enabled in clients. If it is enabled in toxcore,
Messenger will add the running TCP server to the TCP relay.</p>

<p>Messenger is the module that transforms code that can connect to friends based
on public key into a real instant messenger.</p>

<h1 id='group' class='section-header'><a href='#group'>16 Group</a></h1>
<p>Group chats in Tox work by temporarily adding some peers (up to 4) present in
the group chat as temporary <code>friend_connection</code> friends, that are deleted when
the group chat is exited.</p>

<p>Each peer in the group chat is identified by their real long term public key
however peers transmit their DHT public keys to each other via the group chat
in order to speed up the connection by making it unnecessary for the peers to
find each others DHT public keys with the onion which would happen if they
would have added themselves as normal friends.</p>

<p>The upside of using <code>friend_connection</code> is that group chats do not have to deal
with things like hole-punching, peers only on TCP or other low level networking
things. The downside however is that every single peer knows each others real
long term public key and DHT public key which means these group chats should
only be used between friends.</p>

<p>To connect to each other, two peers must have the other added to their list of
friend connections. This is not a problem if the group chat has an equal or
smaller number of participants than 5 as each of the 5 peers will have the 4
others added to their list of friend connections. When there are more peers
there must be a way to ensure that peers will manage to connect to other
groupchat peers.</p>

<p>Since the maximum number of peers per groupchat that will be connected to with
friend connections is 4, if all peers in the groupchat are arranged in a
perfect circle and each peer connects to the 2 peers that are the closest to
the right of them and the 2 peers that are closest to the left of them, the
peers should form a well connected circle of peers.</p>

<p>Group chats in toxcore do this by subtracting the real long term public key of
the peer with all the others in the group (our PK - other peer PK) and finding
the two peers for which the result of this operation is the smallest. The
operation is then inversed (other peer PK - our PK) and this operation is done
again with all the public keys of the peers in the group. The 2 peers for which
the result is again the smallest are picked.</p>

<p>This gives 4 peers that are then added as a friend connection and associated to
the group. If every peer in the group does this, they will form a circle of
perfectly connected peers.</p>

<p>Once the peers are connected to each other in a circle they relay each others
messages. Every time a peer leaves the group or a new peer joins each member of
the chat will recalculate the peers they should connect to.</p>

<p>To join a group chat the peer must first be invited to it by their friend. To
make a groupchat the peer will first create a groupchat and then invite people
to this group chat. Once their friends are in the group chat they can invite
their other friends to the chat and so on.</p>

<p>To create a group chat the peer will generate a random 32 byte id that will be
used to uniquely identify this group chat. 32 bytes is enough so that when
randomly generated with a secure random number generator every groupchat ever
created will have a different id. The goal of this 32 byte id is so that peers
have a way of identifying each group chat so that they can prevent themselves
from joining a groupchat twice for example.</p>

<p>The groupchat will also have an unsigned 1 byte type. This type indicates what
kind of groupchat the groupchat is, the current types are:</p>

<p>0: text 1: audio</p>

<p>Text groupchats are text only while audio indicates that the groupchat supports
sending audio to it as well as text.</p>

<p>The groupchat will also be identified by a unique unsigned 2 byte integer which
in toxcore corresponds to the index of the groupchat in the array it is being
stored in. Every groupchat in the current instance must have a different
number. This number is used by groupchat peers that are directly connected to
us to tell us which packets are for which groupchat. This is why every
groupchat packet contains a groupchat number as part of them. Putting a 32 byte
groupchat id in each packet would increase bandwidth waste by a lot which is
the reason why groupchat numbers are used instead.</p>

<p>Using the group number as the index of the array used to store the groupchat
instances is recommended because this kind of access is usually most efficient
and it ensures that each groupchat has a unique group number.</p>

<p>When creating a new groupchat, the peer will add themselves as a groupchat peer
with a peer number of 0 and their own long term public key and DHT public key.</p>

<p>Invite packets:</p>

<p>Invite packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x60)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x00)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>33</code></td>
<td style="text-align: left">Group chat identifier</td>
</tr>
</tbody>
</table>

<p>A group chat identifier consists of a 1-byte type and a 32-byte ID
concatenated.</p>

<p>Response packet</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x60)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x01)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number (local)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number to join</td>
</tr>
<tr>
<td style="text-align: left"><code>33</code></td>
<td style="text-align: left">Group chat identifier</td>
</tr>
</tbody>
</table>

<p>To invite a friend to a group chat, an invite packet is sent to the friend.
These packets are sent using Messenger (if you look at the Messenger packet id
section, all the groupchat packet ids are in there). Note that all numbers like
all other numbers sent using Tox packets are sent in big endian format.</p>

<p>The group chat number is as explained above, the number used to uniquely
identify the groupchat instance from all the other groupchat instances the peer
has. It is sent in the invite packet because it is needed by the friend in
order to send back groupchat related packets.</p>

<p>What follows is the 1 byte type with the 32 byte groupchat id appended to it.</p>

<p>To refuse the invite, the friend receiving it will simply ignore and discard
it.</p>

<p>To accept the invite, the friend will create their own groupchat instance with
the 32 byte groupchat id and 1 byte type sent in the request and send a invite
response packet back. The friend will also add the one who sent the invite as a
temporary invited groupchat connection.</p>

<p>The first group number in the response packet is the group number of the
groupchat the invited friend just created. The second group number is the group
chat number that was sent in the invite request. What follows is the 1 byte
type and 32 byte groupchat id that were sent in the invite request.</p>

<p>When a peer receives an invite response packet they will check if the group id
sent back corresponds to the group id of the groupchat with the group number
also sent back. If everything is ok, a new peer number will be generated for
the peer that sent the invite response packet. Then the peer with their
generated peer number, their long term public key and DHT public key will be
added to the peer list of the groupchat. A new peer packet will also be sent to
tell everyone in the group chat about the new peer. The peer will also be added
as a temporary invited groupchat connection.</p>

<p>Peer numbers are used to uniquely identify each peer in the group chat. They
are used in groupchat message packets so that peers receiving them can know who
or which groupchat peer sent them. As groupchat packets are relayed, they must
contain something that is used by others to identify the sender. Since putting
a 32 byte public key in each packet would be wasteful a 2 byte peer number is
instead used. Each peer in the groupchat has a unique peer number. Toxcore
generates each peer number randomly but makes sure newly generated peer numbers
are not equal to current ones already used by other peers in the group chat. If
two peers join the groupchat from two different endpoints there is a small
possibility that both will be given the same peer number however this
possibility is low enough in practice that is not an issue.</p>

<p>Temporary invited groupchat connections are groupchat connections to the
groupchat inviter used by groupchat peers to bootstrap themselves the
groupchat. They are the same thing as connections to groupchat peers via friend
connections except that they are discarded after the peer is fully connected to
the group chat.</p>

<p>Peer online packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x61)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number (local)</td>
</tr>
<tr>
<td style="text-align: left"><code>33</code></td>
<td style="text-align: left">Group chat identifier</td>
</tr>
</tbody>
</table>

<p>Peer leave packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x62)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number (local)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x01)</td>
</tr>
</tbody>
</table>

<p>For a groupchat connection to work, both peers in the groupchat must be
attempting to connect directly to each other.</p>

<p>Groupchat connections are established when both peers who want to connect to
each other either create a new friend connection to connect to each other or
reuse an exiting friend connection that connects them together (if they are
friends or already are connected together because of another group chat).</p>

<p>As soon as the connection to the other peer is opened, a peer online packet is
sent to the peer. The goal of the online packet is to tell the peer that we
want to establish the groupchat connection with them and tell them the
groupchat number of our groupchat instance. The peer online packet contains the
group number and the group type and 32 byte groupchat id. The group number is
the group number the peer has for the group with the group id sent in the
packet.</p>

<p>When both sides send a online packet to the other peer, a connection is
established.</p>

<p>When an online packet is received, the group number to communicate with the
group is saved. If the connection to the peer is already established (an online
packet has been already received) then the packet is dropped. If there is no
group connection to that peer being established, the packet is dropped. If this
is the first group connection to that group we establish, a peer query packet
is sent. This is so we can get the list of peers from the group.</p>

<p>The peer leave packet is sent to the peer right before killing a group
connection. It is only used to tell the other side that the connection is dead
if the friend connection is used for other uses than the group chat (another
group chat, for a connection to a friend). If not, then the other peer will see
the friend connection go offline which will prompt them to stop using it and
kill the group connection tied to it.</p>

<p>Peer query packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x62)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x08)</td>
</tr>
</tbody>
</table>

<p>Peer response packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x62)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x09)</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left"> Repeated times number of peers: Peer info</td>
</tr>
</tbody>
</table>

<p>The Peer info structure is as follows:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> peer number</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">DHT public key</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> Name length</td>
</tr>
<tr>
<td style="text-align: left"><code>[0, 255]</code></td>
<td style="text-align: left">Name</td>
</tr>
</tbody>
</table>

<p>Title response packet:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x62)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x0a)</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Title</td>
</tr>
</tbody>
</table>

<p>Message packets:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0x63)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> peer number</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> message number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> with a value representing id of message</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Data</td>
</tr>
</tbody>
</table>

<p>Lossy Message packets:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> (0xc7)</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> group number</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> peer number</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint16_t</code> message number</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> with a value representing id of message</td>
</tr>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Data</td>
</tr>
</tbody>
</table>

<p>If a peer query packet is received, the receiver takes his list of peers and
creates a peer response packet which is then sent to the other peer. If there
are too many peers in the group chat and the peer response packet would be
larger than the maximum size of friend connection packets (1373 bytes), more
than one peer response packet is sent back. A Title response packet is also
sent back. This is how the peer that joins a group chat finds out the list of
peers in the group chat and the title of the group chat right after joining.</p>

<p>Peer response packets are straightforward and contain the information for each
peer (peer number, real public key, DHT public key, name) appended to each
other. The title response is also straight forward.</p>

<p>Both the maximum length of groupchat peer names and the groupchat title is 128
bytes. This is the same maximum length as names in all of toxcore.</p>

<p>When a peer receives the peer response packet(s), they will add each of the
received peers to their groupchat peer list, find the 4 closest peers to them
and create groupchat connections to them as was explained previously.</p>

<p>To find their peer number, the peer will find themselves in the list of
received peers and use the peer number assigned to them as their own.</p>

<p>Message packets are used to send messages to all peers in the groupchat. To
send a message packet, a peer will first take their peer number and the message
they want to send. Each message packet sent will have a message number that is
equal to the last message number sent + 1. Like all other numbers (group chat
number, peer number) in the packet, the message number in the packet will be in
big endian format. When a Message packet is received, the peer receiving it
will take the message number in the packet and see if it is bigger than the one
it has saved for the peer with peer number. If this is the first Message packet
being received for this peer then this check is omitted. The message number is
used to know if a Message packet was already received and relayed to prevent
packets from looping around the groupchat. If the message number check says
that the packet was already received, then the packet is discarded. If it was
not already received, a Message packet with the message is sent (relayed) to
all current group connections (normal groupchat connections + temporary invited
groupchat connections) except the one that it was received from. The only thing
that should change in the Message packet as it is relayed is the group number.</p>

<h2 id='message-ids' class='section-header'><a href='#message-ids'>16.1 Message ids</a></h2>
<h3 id='ping-0x00' class='section-header'><a href='#ping-0x00'>16.1.1 ping (0x00)</a></h3>
<p>Sent approximately every 60 seconds by every peer. Contains no data.</p>

<h3 id='new_peer-0x10' class='section-header'><a href='#new_peer-0x10'>16.1.2 <code>new_peer</code> (0x10)</a></h3>
<p>Tell everyone about a new peer in the chat.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Peer number</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">DHT public key</td>
</tr>
</tbody>
</table>

<h3 id='kill_peer-0x11' class='section-header'><a href='#kill_peer-0x11'>16.1.3 <code>kill_peer</code> (0x11)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Peer number</td>
</tr>
</tbody>
</table>

<h3 id='name-change-0x30' class='section-header'><a href='#name-change-0x30'>16.1.4 Name change (0x30)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Name (namelen)</td>
</tr>
</tbody>
</table>

<h3 id='groupchat-title-change-0x31' class='section-header'><a href='#groupchat-title-change-0x31'>16.1.5 Groupchat title change (0x31)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Title (titlelen)</td>
</tr>
</tbody>
</table>

<h3 id='chat-message-0x40' class='section-header'><a href='#chat-message-0x40'>16.1.6 Chat message (0x40)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Message (messagelen)</td>
</tr>
</tbody>
</table>

<h3 id='action-me-0x41' class='section-header'><a href='#action-me-0x41'>16.1.7 Action (/me) (0x41)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">variable</td>
<td style="text-align: left">Message (messagelen)</td>
</tr>
</tbody>
</table>

<p>Ping messages must be sent every 60 seconds by every peer. This is how other
peers know that the peers are still alive.</p>

<p>When a new peer joins, the peer which invited the joining peer will send a new
peer message to warn everyone that there is a new peer in the chat. When a new
peer message is received, the peer in the packet must be added to the peer
list.</p>

<p>Kill peer messages are used to indicate that a peer has quit the group chat. It
is sent by the one quitting the group chat right before they quit it.</p>

<p>Name change messages are used to change or set the name of the peer sending it.
They are also sent by a joining peer right after receiving the list of peers in
order to tell others what their name is.</p>

<p>Title change packets are used to change the title of the group chat and can be
sent by anyone in the group chat.</p>

<p>Chat and action messages are used by the group chat peers to send messages to
others in the group chat.</p>

<p>Lossy message packets are used to send audio packets to others in audio group
chats. Lossy packets work the same way as normal relayed groupchat messages in
that they are relayed to everyone in the group chat until everyone has them.</p>

<p>Some differences with them though is that first of all the message number is a
2 byte integer. If I were to improve the groupchats protocol I would make the
message number for normal message packets 2 bytes. 1 byte means only 256
packets can be received at the same time. With the delays in groupchats and 256
packets corresponding to less than a high quality video frame it would not
work. This is why 2 bytes was chosen.</p>

<p>Note that this message number like all other numbers in the packet are in big
endian format.</p>

<p>When receiving a lossy packet the peer will first check if it was already
received. If it wasn&#39;t, the packet will be added to the list of received
packets and then the packet will be passed to its handler and then sent to the
2 closest connected groupchat peers that are not the sender. The reason for it
to be 2 instead of 4 (well 3 if we are not the original sender) for normal
message packets is that it reduces bandwidth usage without lowering the quality
of the received audio stream via lossy packets. Message packets also are sent
relatively rarely, enough so that changing it to 2 would have a minimal impact
in bandwidth usage.</p>

<p>To check if a packet was received, the last up to 65536 received packet numbers
are stored, current groups store the last 256 packet numbers however that is
because it is currently audio only. If video was added meaning a much higher
number of packets would be sent, this number would be increased. If the packet
number is in this list then it was received.</p>

<p>This is how groupchats in Tox work.</p>

<h1 id='networktxt' class='section-header'><a href='#networktxt'>17 network.txt</a></h1>
<p>The network module is the lowest file in toxcore that everything else depends
on. This module is basically a UDP socket wrapper, serves as the sorting ground
for packets received by the socket, initializes and uninitializes the socket.
It also contains many socket, networking related and some other functions like
a monotonic time function used by other toxcore modules.</p>

<p>Things of note in this module are the maximum UDP packet size define
(<code>MAX_UDP_PACKET_SIZE</code>) which sets the maximum UDP packet size toxcore can send
and receive. The list of all UDP packet ids: <code>NET_PACKET_*</code>. UDP packet ids are
the value of the first byte of each UDP packet and is how each packet gets
sorted to the right module that can handle it. <code>networking_registerhandler()</code>
is used by higher level modules in order to tell the network object which
packets to send to which module via a callback.</p>

<p>It also contains datastructures used for ip addresses in toxcore. IP4 and IP6
are the datastructures for ipv4 and ipv6 addresses, IP is the datastructure for
storing either (the family can be set to <code>AF_INET</code> (ipv4) or <code>AF_INET6</code> (ipv6).
It can be set to another value like <code>TCP_ONION_FAMILY</code>, <code>TCP_INET</code>, <code>TCP_INET6</code>
or <code>TCP_FAMILY</code> which are invalid values in the network modules but valid
values in some other module and denote a special type of ip) and <code>IP_Port</code>
stores an IP datastructure with a port.</p>

<p>Since the network module interacts directly with the underlying operating
system with its socket functions it has code to make it work on windows, linux,
etc... unlike most modules that sit at a higher level.</p>

<p>The network module currently uses the polling method to read from the UDP
socket. The <code>networking_poll()</code> function is called to read all the packets from
the socket and pass them to the callbacks set using the
<code>networking_registerhandler()</code> function. The reason it uses polling is simply
because it was easier to write it that way, another method would be better
here.</p>

<p>The goal of this module is to provide an easy interface to a UDP socket and
other networking related functions.</p>

<h1 id='ping-array' class='section-header'><a href='#ping-array'>18 Ping array</a></h1>
<p>Ping array is an array used in toxcore to store data for pings. It enables the
storage of arbitrary data that can then be retrieved later by passing the 8
byte ping id that was returned when the data was stored. It also frees data
from pings that are older than a ping expiring delay set when initializing the
array.</p>

<p>Ping arrays are initialized with a size and a timeout parameter. The size
parameter denotes the maximum number of entries in the array and the timeout
denotes the number of seconds to keep an entry in the array. Timeout and size
must be bigger than 0.</p>

<p>Adding an entry to the ping array will make it return an 8 byte number that can
be used as the ping number of a ping packet. This number is generated by first
generating a random 8 byte number (toxcore uses the cryptographic secure random
number generator), dividing then multiplying it by the total size of the array
and then adding the index of the element that was added. This generates a
random looking number that will return the index of the element that was added
to the array. This number is also stored along with the added data and the
current time (to check for timeouts). Data is added to the array in a cyclical
manner (0, 1, 2, 3... (array size - 1), 0, 1, ...). If the array is full, the
oldest element is overwritten.</p>

<p>To get data from the ping array, the ping number is passed to the function to
get the data from the array. The modulo of the ping number with the total size
of the array will return the index at which the data is. If there is no data
stored at this index, the function returns an error. The ping number is then
checked against the ping number stored for this element, if it is not equal the
function returns an error. If the array element has timed out, the function
returns an error. If all the checks succeed the function returns the exact data
that was stored and it is removed from the array.</p>

<p>Ping array is used in many places in toxcore to efficiently keep track of sent
packets.</p>

<h1 id='state-format' class='section-header'><a href='#state-format'>19 State Format</a></h1>
<p>The reference Tox implementation uses a custom binary format to save the state
of a Tox client between restarts. This format is far from perfect and will be
replaced eventually. For the sake of maintaining compatibility down the road,
it is documented here.</p>

<p>The binary encoding of all integer types in the state format is a fixed-width
byte sequence with the integer encoded in Little Endian unless stated
otherwise.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left">Zeroes</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> (0x15ED1B1F)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of sections</td>
</tr>
</tbody>
</table>

<h2 id='sections' class='section-header'><a href='#sections'>19.1 Sections</a></h2>
<p>The core of the state format consists of a list of sections. Every section has
its type and length specified at the beginning. In some cases, a section only
contains one item and thus takes up the entire length of the section. This is
denoted with &#39;?&#39;.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> Length of this section</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Section type</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> (0x01CE)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">Section</td>
</tr>
</tbody>
</table>

<p>Section types:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Name</th>
<th style="text-align: left">Value</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">NospamKeys</td>
<td style="text-align: left">0x01</td>
</tr>
<tr>
<td style="text-align: left">DHT</td>
<td style="text-align: left">0x02</td>
</tr>
<tr>
<td style="text-align: left">Friends</td>
<td style="text-align: left">0x03</td>
</tr>
<tr>
<td style="text-align: left">Name</td>
<td style="text-align: left">0x04</td>
</tr>
<tr>
<td style="text-align: left">StatusMessage</td>
<td style="text-align: left">0x05</td>
</tr>
<tr>
<td style="text-align: left">Status</td>
<td style="text-align: left">0x06</td>
</tr>
<tr>
<td style="text-align: left">TcpRelays</td>
<td style="text-align: left">0x0A</td>
</tr>
<tr>
<td style="text-align: left">PathNodes</td>
<td style="text-align: left">0x0B</td>
</tr>
<tr>
<td style="text-align: left">EOF</td>
<td style="text-align: left">0xFF</td>
</tr>
</tbody>
</table>

<p>Not every section listed above is required to be present in order to restore
from a state file. Only NospamKeys is required.</p>

<h3 id='nospam-and-keys-0x01' class='section-header'><a href='#nospam-and-keys-0x01'>19.1.1 Nospam and Keys (0x01)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> Nospam</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term secret key</td>
</tr>
</tbody>
</table>

<h3 id='dht-0x02' class='section-header'><a href='#dht-0x02'>19.1.2 DHT (0x02)</a></h3>
<p>This section contains a list of DHT-related sections.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> (0x159000D)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of DHT sections</td>
</tr>
</tbody>
</table>

<h4 id='dht-sections' class='section-header'><a href='#dht-sections'>19.1.2.1 DHT Sections</a></h4>
<p>Every DHT section has the following structure:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> Length of this section</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> DHT section type</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> (0x11CE)</td>
</tr>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">DHT section</td>
</tr>
</tbody>
</table>

<p>DHT section types:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Name</th>
<th style="text-align: left">Value</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">Nodes</td>
<td style="text-align: left">0x04</td>
</tr>
</tbody>
</table>

<h5 id='nodes-0x04' class='section-header'><a href='#nodes-0x04'>19.1.2.1.1 Nodes (0x04)</a></h5>
<p>This section contains a list of nodes. These nodes are used to quickly
reconnect to the DHT after a Tox client is restarted.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of nodes</td>
</tr>
</tbody>
</table>

<p>The structure of a node is the same as <code>Node Info</code>. Note: this means that the
integers stored in these nodes are stored in Big Endian as well.</p>

<h3 id='friends-0x03' class='section-header'><a href='#friends-0x03'>19.1.3 Friends (0x03)</a></h3>
<p>This section contains a list of friends. A friend can either be a peer we&#39;ve
sent a friend request to or a peer we&#39;ve accepted a friend request from.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of friends</td>
</tr>
</tbody>
</table>

<p>Friend:</p>

<p>Some of the integers in this structure are stored in Big Endian. This is
denoted with &quot;(BE)&quot;.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> Status</td>
</tr>
<tr>
<td style="text-align: left"><code>32</code></td>
<td style="text-align: left">Long term public key</td>
</tr>
<tr>
<td style="text-align: left"><code>1024</code></td>
<td style="text-align: left">Friend request message as a byte string</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left">PADDING</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Size of the friend request message (BE)</td>
</tr>
<tr>
<td style="text-align: left"><code>128</code></td>
<td style="text-align: left">Name as a byte string</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Size of the name (BE)</td>
</tr>
<tr>
<td style="text-align: left"><code>1007</code></td>
<td style="text-align: left">Status message as a byte string</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left">PADDING</td>
</tr>
<tr>
<td style="text-align: left"><code>2</code></td>
<td style="text-align: left"><code>uint16_t</code> Size of the status message (BE)</td>
</tr>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> User status (see also: <code>USERSTATUS</code>)</td>
</tr>
<tr>
<td style="text-align: left"><code>3</code></td>
<td style="text-align: left">PADDING</td>
</tr>
<tr>
<td style="text-align: left"><code>4</code></td>
<td style="text-align: left"><code>uint32_t</code> Nospam (only used for sending a friend request)</td>
</tr>
<tr>
<td style="text-align: left"><code>8</code></td>
<td style="text-align: left"><code>uint64_t</code> Last seen time</td>
</tr>
</tbody>
</table>

<p>Status can be one of:</p>

<table>
<thead>
<tr>
<th style="text-align: left">Status</th>
<th style="text-align: left">Meaning</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">0</td>
<td style="text-align: left">Not a friend</td>
</tr>
<tr>
<td style="text-align: left">1</td>
<td style="text-align: left">Friend added</td>
</tr>
<tr>
<td style="text-align: left">2</td>
<td style="text-align: left">Friend request sent</td>
</tr>
<tr>
<td style="text-align: left">3</td>
<td style="text-align: left">Confirmed friend</td>
</tr>
<tr>
<td style="text-align: left">4</td>
<td style="text-align: left">Friend online</td>
</tr>
</tbody>
</table>

<h3 id='name-0x04' class='section-header'><a href='#name-0x04'>19.1.4 Name (0x04)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">Name as a UTF-8 encoded string</td>
</tr>
</tbody>
</table>

<h3 id='status-message-0x05' class='section-header'><a href='#status-message-0x05'>19.1.5 Status Message (0x05)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">Status message as a UTF-8 encoded string</td>
</tr>
</tbody>
</table>

<h3 id='status-0x06' class='section-header'><a href='#status-0x06'>19.1.6 Status (0x06)</a></h3>
<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>1</code></td>
<td style="text-align: left"><code>uint8_t</code> User status (see also: <code>USERSTATUS</code>)</td>
</tr>
</tbody>
</table>

<h3 id='tcp-relays-0x0a' class='section-header'><a href='#tcp-relays-0x0a'>19.1.7 Tcp Relays (0x0A)</a></h3>
<p>This section contains a list of TCP relays.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of TCP relays</td>
</tr>
</tbody>
</table>

<p>The structure of a TCP relay is the same as <code>Node Info</code>. Note: this means that
the integers stored in these nodes are stored in Big Endian as well.</p>

<h3 id='path-nodes-0x0b' class='section-header'><a href='#path-nodes-0x0b'>19.1.8 Path Nodes (0x0B)</a></h3>
<p>This section contains a list of path nodes used for onion routing.</p>

<table>
<thead>
<tr>
<th style="text-align: left">Length</th>
<th style="text-align: left">Contents</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left"><code>?</code></td>
<td style="text-align: left">List of path nodes</td>
</tr>
</tbody>
</table>

<p>The structure of a path node is the same as <code>Node Info</code>. Note: this means that
the integers stored in these nodes are stored in Big Endian as well.</p>

<h3 id='eof-0xff' class='section-header'><a href='#eof-0xff'>19.1.9 EOF (0xFF)</a></h3>
<p>This section indicates the end of the state file. This section doesn&#39;t have any
content and thus it&#39;s length is 0.</p>

<h1 id='testing' class='section-header'><a href='#testing'>20 Testing</a></h1>
<p>The final part of the architecture is the test protocol. We use a
<a href="http://msgpack.org">MessagePack</a> based RPC protocol to expose language
agnostic interfaces to internal functions. Using property based testing with
random inputs as well as specific edge case tests help ensure that an
implementation of the Tox protocol following the architecture specified in this
document is correct.</p>

<p>See the <a href="https://github.com/msgpack/msgpack/blob/master/spec.md">spec</a> of
msgpack for information on the binary representation.</p>

<p>TODO(iphydf): Generate and add specifications of each test method here.</p>

    
</body>
</html>